/*
 * System Runtime
 * 
 * https://designfirst.io/systemruntime/
 * 
 * Copyright 2018 Erwan Carriou
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).runtime=e()}}(function(){var define,module,exports;return function e(t,n,a){function r(i,s){if(!n[i]){if(!t[i]){var d="function"==typeof require&&require;if(!s&&d)return d(i,!0);if(o)return o(i,!0);var c=new Error("Cannot find module '"+i+"'");throw c.code="MODULE_NOT_FOUND",c}var l=n[i]={exports:{}};t[i][0].call(l.exports,function(e){var n=t[i][1][e];return r(n||e)},l,l.exports,e,t,n,a)}return n[i].exports}for(var o="function"==typeof require&&require,i=0;i<a.length;i++)r(a[i]);return r}({1:[function(e,t,n){"use strict";n.system={name:"system-runtime",master:!1,version:"2.6.2",description:"System Runtime",schemas:{"1ac07185641fa9f":{_name:"_Behavior",_inherit:["_Component"],_core:!0,core:"property",component:"property",action:"property",state:"property",useCoreAPI:"property",context:"property",_id:"1ac07185641fa9f"},"104ad1f48518376":{_id:"104ad1f48518376",_name:"_Channel",_inherit:["_Component"],_core:!0,send:"event",$systemInstalled:"event",$systemResolved:"event",$systemStarted:"event",$systemStopped:"event",$systemUninstalled:"event"},"1c00b13a1b1bc92":{_name:"_ClassInfo",_inherit:["_Component"],_core:!0,model:"property",schema:"property",method:"method",methods:"method",property:"method",properties:"method",link:"method",links:"method",collections:"method",collection:"method",event:"method",events:"method",_id:"1c00b13a1b1bc92"},"111df11e2b19fde":{_id:"111df11e2b19fde",_name:"_Component",_inherit:[],_core:!0,classInfo:"method",on:"method",off:"method",require:"method",destroy:"method",init:"method",error:"event"},"1723516a30132ac":{_name:"_Database",_inherit:["_Component"],_core:!0,collections:"method",insert:"event",update:"event",remove:"event",_id:"1723516a30132ac"},f1a10d1067d1b23a:{_id:"f1a10d1067d1b23a",_name:"_Log",_inherit:["_Component"],_core:!0,action:"property",collection:"property",id:"property",field:"property",value:"property",order:"property"},"1268f1dddd1fea7":{_name:"_Logger",_core:!0,level:"property",debug:"method",info:"method",warn:"method",error:"method",_id:"1268f1dddd1fea7"},"14caa1c46414ee1":{_name:"_Message",_inherit:["_Component"],_core:!0,event:"property",from:"property",data:"property",_id:"14caa1c46414ee1"},"193f1166eb16609":{_name:"_Metamodel",_inherit:["_Component"],_core:!0,schema:"method",model:"method",type:"method",create:"method",_id:"193f1166eb16609"},"157931f7a31b61d":{_id:"157931f7a31b61d",_name:"_OSGi",_inherit:["_Component"],_core:!0,install:"method",uninstall:"method",start:"method",stop:"method",status:"method",bundle:"method"},"12e211d4cd120a6":{_id:"12e211d4cd120a6",_name:"_Runtime",_inherit:["_OSGi"],_core:!0,version:"property",system:"method",message:"method",ready:"event"},"158711d6f215e4b":{_name:"_State",_inherit:[],_core:!0,_class:!1,state:"property",value:"property",_id:"158711d6f215e4b"},"1cb761fa4510dca":{_id:"1cb761fa4510dca",_name:"_System",_inherit:["_SystemOSGi"],_core:!0,name:"property",master:"property",version:"property",description:"property",schemas:"property",models:"property",behaviors:"property",types:"property",components:"property"},"145fe10c7514298":{_id:"145fe10c7514298",_name:"_SystemOSGi",_inherit:["_Component"],_core:!0,state:"property",location:"property",start:"method",stop:"method"}},models:{"166971fd9d107fd":{_name:"_Behavior",_core:!0,context:{type:"any",readOnly:!1,mandatory:!1,default:null},core:{type:"boolean",readOnly:!1,mandatory:!1,default:!1},useCoreAPI:{type:"any",readOnly:!1,mandatory:!1,default:!1},component:{type:"string",readOnly:!1,mandatory:!0,default:""},action:{type:"javascript",readOnly:!1,mandatory:!0,default:""},state:{type:"string",readOnly:!1,mandatory:!0,default:""},_id:"166971fd9d107fd"},"135c71078810af2":{_id:"135c71078810af2",_name:"_Channel",_core:!0,send:{params:[{name:"message",type:"message"}]},$systemInstalled:{params:[{name:"id",type:"string",mandatory:!0,default:""}]},$systemResolved:{params:[{name:"id",type:"string",mandatory:!0,default:""}]},$systemUninstalled:{params:[{name:"id",type:"string",mandatory:!0,default:""}]},$systemStarted:{params:[{name:"id",type:"string",mandatory:!0,default:""}]},$systemStopped:{params:[{name:"id",type:"string",mandatory:!0,default:""}]}},"158321dced1014a":{_name:"_ClassInfo",_core:!0,model:{type:"object",readOnly:!0,mandatory:!0,default:{}},property:{params:[{name:"name",type:"string"}],result:"object"},properties:{result:"array"},link:{params:[{name:"name",type:"string"}],result:"object"},links:{result:"array"},method:{params:[{name:"name",type:"string"}],result:"object"},methods:{result:"array"},collection:{params:[{name:"name",type:"string"}],result:"object"},collections:{result:"array"},event:{params:[{name:"name",type:"string"}],result:"object"},events:{result:"array"},_id:"158321dced1014a",schema:{type:"object",readOnly:!0,mandatory:!0,default:{}}},"123751cb591de26":{_id:"123751cb591de26",_name:"_Component",_core:!0,on:{params:[{name:"state",type:"string"},{name:"action",type:"function"},{name:"useCoreAPI",type:"any",mandatory:!1,default:!1},{name:"isCore",type:"boolean",mandatory:!1,default:!1}]},off:{params:[{name:"state",type:"string",mandatory:!1},{name:"behaviorId",type:"string",mandatory:!1}]},require:{params:[{name:"id",type:"string"}]},destroy:{params:[]},classInfo:{result:"_ClassInfo"},init:{params:[{name:"conf",type:"object"}]},error:{params:[{name:"data",type:"errorParam"}]}},"18a51169d7112d4":{_name:"_Database",_core:!0,collections:{result:"object"},insert:{params:[{name:"event",type:"dbInsertEvent"}]},update:{params:[{name:"event",type:"dbUpdateEvent"}]},remove:{params:[{name:"event",type:"dbRemoveEvent"}]},_id:"18a51169d7112d4"},o1e1e01e6b41cec3:{_id:"o1e1e01e6b41cec3",_name:"_Log",action:{type:"dbAction",readOnly:!1,mandatory:!1,default:"insert"},collection:{type:"string",readOnly:!1,mandatory:!1,default:""},id:{type:"string",readOnly:!1,mandatory:!1,default:""},field:{type:"string",readOnly:!1,mandatory:!1,default:""},value:{type:"any",readOnly:!1,mandatory:!1,default:""},order:{type:"number",readOnly:!1,mandatory:!1,default:0},_core:!0},"16b9d1ac2216ffe":{_id:"16b9d1ac2216ffe",_name:"_Logger",_core:!0,level:{type:"log",readOnly:!1,mandatory:!1,default:"warn"},debug:{params:[{name:"message",type:"any"}]},info:{params:[{name:"message",type:"any"}]},warn:{params:[{name:"message",type:"any"}]},error:{params:[{name:"message",type:"any"}]}},"1d9b6139411aa91":{_name:"_Message",_core:!0,event:{type:"string",readOnly:!1,mandatory:!0,default:""},from:{type:"string",readOnly:!1,mandatory:!0,default:""},data:{type:"array",readOnly:!1,mandatory:!0,default:[]},_id:"1d9b6139411aa91"},"1628c13c22152e6":{_name:"_Metamodel",_core:!0,schema:{params:[{name:"name",type:"any",default:"",mandatory:!1},{name:"schema",type:"object",default:{},mandatory:!1}],result:"any"},model:{params:[{name:"name",type:"any",default:"",mandatory:!1},{name:"model",type:"object",default:{},mandatory:!1}],result:"any"},type:{params:[{name:"name",type:"any",default:"",mandatory:!1},{name:"type",type:"object",default:{},mandatory:!1}],result:"any"},create:{params:[]},_id:"1628c13c22152e6"},"100b91ed2211b15":{_id:"100b91ed2211b15",_name:"_OSGi",install:{params:[{name:"url",type:"any",mandatory:!0,default:""},{name:"async",type:"boolean",mandatory:!1,default:!0}],result:"string"},uninstall:{params:[{name:"id",type:"string",mandatory:!0,default:""}]},start:{params:[{name:"id",type:"string",mandatory:!0,default:""}]},stop:{params:[{name:"id",type:"string",mandatory:!0,default:""}]},status:{result:"object"},_core:!0,bundle:{result:"string"}},"14c7c105b31a160":{_id:"14c7c105b31a160",_name:"_Runtime",_core:!0,version:{type:"string",readOnly:!0,mandatory:!0,default:"0.0.0"},system:{params:[{name:"params",type:"any",mandatory:!1}],result:"object"},message:{params:[{name:"msg",type:"message",mandatory:!0}]},ready:{}},"177ac136891629f":{_name:"_State",_core:!0,state:{type:"string",readOnly:!1,mandatory:!0,default:""},value:{type:"any",readOnly:!1,mandatory:!1,default:null},_id:"177ac136891629f"},"170521b88614387":{_name:"_System",_core:!0,name:{type:"string",readOnly:!1,mandatory:!0,default:""},master:{type:"boolean",readOnly:!1,mandatory:!1,default:!1},version:{type:"string",readOnly:!1,mandatory:!1,default:"0.0.1"},description:{type:"string",readOnly:!1,mandatory:!1,default:""},schemas:{type:"object",readOnly:!1,mandatory:!1,default:{}},models:{type:"object",readOnly:!1,mandatory:!1,default:{}},behaviors:{type:"object",readOnly:!1,mandatory:!1,default:{}},types:{type:"object",readOnly:!1,mandatory:!1,default:{}},components:{type:"object",readOnly:!1,mandatory:!1,default:{}},_id:"170521b88614387"},"1b2811b092143f5":{_id:"1b2811b092143f5",_name:"_SystemOSGi",start:{},stop:{},_core:!0,state:{type:"string",readOnly:!1,mandatory:!1,default:"none"},location:{type:"string",readOnly:!1,mandatory:!1,default:""}}},behaviors:{"12e491859c13918":{_id:"12e491859c13918",component:"_Channel",state:"$systemStarted",action:"function $systemStarted(id) { \n  var systems = null;\n    \n  if (id !== 'e89c617b6b15d24') {\n    if (typeof document !== 'undefined') {\n      systems = document.querySelectorAll('link[rel=system]');\n         \n      if ($state.get('runtime') && $state.get('runtime').state === 'ready') {    \n      } else {\n        if (systems.length + 1 === $db._System.count()) {\n          $component.get('runtime').ready();\n        }\n      }\n    }\n  }\n}",useCoreAPI:!0,core:!0},"1e9021bd4e1bc6e":{_id:"1e9021bd4e1bc6e",component:"_Channel",state:"$systemInstalled",action:"function $systemInstalled(id) {\n  var systems = null,\n    dependencies = [],\n    master = [],\n    canStart = true;\n\n  if (id !== 'e89c617b6b15d24') {\n    // if all systems are installed\n    systems = $db._System.find({});\n\n    systems.forEach(function (system) {\n      var sys = this.require(system._id);\n      if (sys && sys.state && sys.state() === 'none') {\n        canStart = false;\n      }\n    }.bind(this));\n\n    // start all the systems\n    if (canStart) {\n      dependencies = $db._System.find({\n        'master': false\n      });\n\n      dependencies.forEach(function (dep) {\n        var system = this.require(dep._id);\n        channel = this.require('channel');\n\n        if (system.state() === 'resolved') {\n          system.state('starting');\n          system.start();\n          channel.$systemStarted(dep._id);\n          system.state('active');\n        }\n      }.bind(this));\n\n      master = $db._System.find({\n        'master': true\n      });\n\n      master.forEach(function (dep) {\n        var system = this.require(dep._id);\n        channel = this.require('channel');\n\n        if (system && system.state && system.state() === 'resolved') {\n          system.state('starting');\n          system.start();\n          channel.$systemStarted(dep._id);\n          system.state('active');\n        }\n      }.bind(this));\n    }\n  }\n}",useCoreAPI:!0,core:!0},"155141e40312cd8":{_id:"155141e40312cd8",component:"_ClassInfo",state:"collection",action:"function collection(name) {\n  var result = {};\n  if (this.schema()[name] === 'collection') {\n    result = this.model()[name];\n  }\n\n  return result;\n}",core:!0},"1f6941a0c012c1f":{_id:"1f6941a0c012c1f",component:"_ClassInfo",state:"collections",action:"function collections(name) {\n  var keys = Object.keys(this.schema()),\n    item = '',\n    result = [],\n    i = 0,\n    length = keys.length;\n\n  for (i = 0; i < length; i++) {\n    item = keys[i];\n    if (this.schema()[item] === 'collection') {\n      result.push(item);\n    }\n  }\n\n  return result;\n}",core:!0},"1ef711b4171c849":{_id:"1ef711b4171c849",component:"_ClassInfo",state:"event",action:"function event(name) {\n  var result = {};\n\n  if (this.schema()[name] === 'event') {\n    result = this.model()[name];\n  }\n\n  return result;\n}",core:!0},"1bae51b6ed1d25c":{_id:"1bae51b6ed1d25c",component:"_ClassInfo",state:"events",action:"function events(name) {\n  var keys = Object.keys(this.schema()),\n    item = '',\n    result = [],\n    i = 0,\n    length = keys.length;\n\n  for (i = 0; i < length; i++) {\n    item = keys[i];\n    if (this.schema()[item] === 'event') {\n      result.push(item);\n    }\n  }\n  return result;\n}",core:!0},"19ac2125221528b":{_id:"19ac2125221528b",component:"_ClassInfo",state:"link",action:"function link(name) {\n  var result = {};\n\n  if (this.schema()[name] === 'link') {\n    result = this.model()[name];\n  }\n  return result;\n}",core:!0},"17ed21dfc01b8e8":{_id:"17ed21dfc01b8e8",component:"_ClassInfo",state:"links",action:"function links(name) {\n  var keys = Object.keys(this.schema()),\n    item = '',\n    result = [],\n    i = 0,\n    length = keys.length;\n\n  for (i = 0; i < length; i++) {\n    item = keys[i];\n    if (this.schema()[item] === 'link') {\n      result.push(item);\n    }\n  } return result;\n}",core:!0},"11ce318a561ac61":{_id:"11ce318a561ac61",component:"_ClassInfo",state:"method",action:"function method(name) {\n  var result = {};\n  if (this.schema()[name] === 'method') {\n    result = this.model()[name];\n  }\n  \n  return result;\n}",core:!0},"12ff2190a018046":{_id:"12ff2190a018046",component:"_ClassInfo",state:"methods",action:"function methods(name) {\n  var keys = Object.keys(this.schema()),\n    item = '',\n    result = [],\n    i = 0,\n    length = keys.length;\n\n  for (i = 0; i < length; i++) {\n    item = keys[i];\n    if (this.schema()[item] === 'method') {\n      result.push(item);\n    }\n  }\n\n  return result;\n}",core:!0},"1028d1681e1fd58":{_id:"1028d1681e1fd58",component:"_ClassInfo",state:"properties",action:"function properties(name) {\n  var keys = Object.keys(this.schema()),\n    item = '',\n    result = [],\n    i = 0,\n    length = keys.length;\n\n  for (i = 0; i < length; i++) {\n    item = keys[i];\n    if (this.schema()[item] === 'property') {\n      result.push(item);\n    }\n  } return result;\n}",core:!0},"18eeb10c5319368":{_id:"18eeb10c5319368",component:"_ClassInfo",state:"property",action:"function property(name) {\n  var result = {};\n\n  if (this.schema()[name] === 'property') {\n    result = this.model()[name];\n  }\n  return result;\n}",core:!0},"1ba721201114b6b":{_id:"1ba721201114b6b",component:"_Component",state:"destroy",action:"function destroy() {\n  $component.destroy(this.id());\n}",core:!0,useCoreAPI:!0},"15486186f41a48c":{_id:"15486186f41a48c",component:"_Component",state:"off",action:'function off(state, behaviorId) {\n  var args = [],\n    i = 0,\n    numInjectedParams = 8,\n    length = arguments.length;\n\n  if ($helper.isOnNode()) {\n    numInjectedParams = numInjectedParams +1;\n  }\n\n  for (i = 0; i < length - numInjectedParams; i++) {\n    args.push(arguments[i]);\n  }\n\n  if ($workflow.checkParams({\n    "component": this,\n    "methodName": "off",\n    "args": args\n  })) {\n\n    if (state || behaviorId) {\n      if ($metamodel.isValidState(state, this.constructor.name)) {\n        $behavior.remove({\n          "behaviorId": behaviorId,\n          "componentId": this.id(),\n          "state": state\n        });\n      } else {\n        this.require(\'logger\').warn("invoke \\\'off\\\' method of component \'" + this.id() + "\' with an invalid state \'" + state + "\'");\n      }\n    } else {\n      $behavior.remove({\n        "componentId": this.id()\n      });\n    }\n  }\n}',core:!0,useCoreAPI:!0},"1da0a17878104c3":{_id:"1da0a17878104c3",component:"_Component",state:"require",action:"function require(id) {\n  return $component.get(id);\n}",core:!0,useCoreAPI:!0},d152631c35813f2e:{_id:"d152631c35813f2e",component:"_Component",state:"classInfo",action:"function classInfo() { \n\tconst className = this.constructor.name;\n\tlet result;\n\t\n\tif (className !== 'Function') {\n\t  result = this.require(className + 'Info');\n\t}\n\t\n\treturn result;\n}",useCoreAPI:!1,core:!0},"1a5111d17a1800c":{_id:"1a5111d17a1800c",component:"_Database",state:"collections",action:"function collections() {\n  var result = {},\n    collectionName = '';\n\n  for (collectionName in $db.store) {\n    if ($db.store.hasOwnProperty(collectionName)) {\n      result[collectionName] = $db[collectionName];\n    }\n  }\n  return result;\n}",core:!0,useCoreAPI:!0},"1d993108fa18ef2":{_id:"1d993108fa18ef2",component:"_Logger",state:"debug",action:"function debug(message) {\n  if (this.level() === 'debug') {\n    console.log('runtime: ' + message);\n  }\n}",core:!0},"1a37a188e11fe73":{_id:"1a37a188e11fe73",component:"_Logger",state:"error",action:"function error(message) {\n  console.error('runtime: ' + message);\n}",core:!0},"1edd21e12a16534":{_id:"1edd21e12a16534",component:"_Logger",state:"info",action:"function info(message) {\n  if (this.level() === 'info' || this.level() === 'debug') {\n    console.info('runtime: ' + message);\n  }\n}",core:!0},"141f2143d3122a4":{_id:"141f2143d3122a4",component:"_Logger",state:"level",action:"function level(val) {\n  $log.level(val);\n}",core:!0,useCoreAPI:!0},"192401bab21304e":{_id:"192401bab21304e",component:"_Logger",state:"warn",action:"function warn(message) {\n  if (this.level() === 'info' || this.level() === 'warn' || this.level() === 'debug') {\n    console.warn('runtime: ' + message);\n  }\n}",core:!0},"11fc715e2f1a31e":{_id:"11fc715e2f1a31e",component:"_Metamodel",state:"create",action:"function create() {\n  $metamodel.create();\n}",core:!0,useCoreAPI:!0},"1232f1f107142cf":{_id:"1232f1f107142cf",component:"_Metamodel",state:"model",action:"function model(name, model) {\n  return $metamodel.model(name, model);\n}",core:!0,useCoreAPI:!0},"1365412f69153d2":{_id:"1365412f69153d2",component:"_Metamodel",state:"schema",action:"function schema(name, schema) {\n  return $metamodel.schema(name, schema);\n}",core:!0,useCoreAPI:!0},"194db147fe161a2":{_id:"194db147fe161a2",component:"_Metamodel",state:"type",action:"function type(name, type) {\n  return $metamodel.type(name, type);\n}",core:!0,useCoreAPI:!0},"1ef951f1411b895":{_id:"1ef951f1411b895",component:"_OSGi",state:"install",action:"function install(url, async) {\n  var importedSystem = null,\n    system = {},\n    systemId = '',\n    callbackLoad = null,\n    xhr = null,\n    result = '',\n    channel = $component.get('channel');\n\n  if (typeof url === 'object') {\n    importedSystem = url;\n  } else {\n    if (url.indexOf('{') === 0) {\n      importedSystem = JSON.parse(url);\n    }\n  }\n\n  if (importedSystem) {\n    systemId = $db.importSystem(importedSystem);\n    if (systemId) {\n      system = this.require(systemId);\n\n      if (typeof url === 'string') {\n        system.location(url);\n      }\n      system.state('installed');\n      channel.$systemInstalled(systemId);\n      system.state('resolved');\n      channel.$systemResolved(systemId);\n\n      result = systemId;\n    }\n  } else {\n    if (typeof global !== 'undefined' && typeof window === 'undefined') {\n      if (url.indexOf('.json') !== -1) {\n        system = require(global.process.env.PWD + '/' + url);\n      } else {\n        system = require(url);\n      }\n      systemId = $db.importSystem(system);\n      system = this.require(systemId);\n\n      if (typeof url === 'string') {\n        system.location(url);\n      }\n      system.state('installed');\n      channel.$systemInstalled(systemId);\n      system.state('resolved');\n      channel.$systemResolved(systemId);\n\n      result = systemId;\n    } else {\n      xhr = new XMLHttpRequest();\n      callbackLoad = function callbackLoad(system, url) {\n        var sysId = $db.importSystem(system),\n          sys = $component.get(sysId),\n          channel = $component.get('channel');\n\n        if (typeof url === 'string') {\n          sys.location(url);\n        }\n        sys.state('installed');\n        channel.$systemInstalled(sysId);\n        sys.state('resolved');\n        channel.$systemResolved(sysId);\n\n        result = sysId;\n      };\n\n      if (async) {\n        xhr.open('GET', url, true);\n        xhr.onreadystatechange = function () {\n          if (xhr.readyState === 4) {\n            if (xhr.status === 200 || xhr.status === 0) {\n              callbackLoad(JSON.parse(xhr.response), url);\n            }\n          }\n        };\n        xhr.send(null);\n      } else {\n        xhr.open('GET', url, false);\n        xhr.send(null);\n        if (xhr.status === 200 || xhr.status === 0) {\n          callbackLoad(JSON.parse(xhr.response), url);\n        }\n      }\n    }\n  }\n  return result;\n}",useCoreAPI:!0,core:!0},"14c1517b711cb78":{_id:"14c1517b711cb78",component:"_OSGi",state:"uninstall",action:"function uninstall(id) {\n  var search = {},\n    system = null,\n    behaviorId = '',\n    collection = '',\n    componentId = '',\n    length = 0,\n    i = 0,\n    coreComponents = ['admin', 'channel', 'db', 'logger', 'metamodel', 'runtime'];\n\n  search = $db._System.find({\n    '_id': id\n  });\n\n  if (search.length) {\n    system = search[0];\n    // remove behaviors\n    if (system.behaviors) {\n      for (behaviorId in system.behaviors) {\n        $db._Behavior.remove({\n          '_id': system.behaviors[behaviorId]._id\n        });\n      }\n    }\n    // remove components\n    if (system.components) {\n      for (collection in system.components) {\n        for (componentId in system.components[collection]) {\n          if (coreComponents.indexOf(componentId) === -1) {\n            $db[collection].remove({\n              '_id': componentId\n            });\n          }\n        }\n      }\n    }\n  }\n  if (this.require(id) && this.require(id).state) {\n    this.require(id).state('uninstalled');\n    this.require('channel').$systemUninstalled(id);\n  }\n}",useCoreAPI:!0,core:!0},"105f219c6813643":{_id:"105f219c6813643",component:"_OSGi",state:"start",action:"function start(id) {\n  var system = this.require(id),\n    channel = this.require('channel');\n\n  if (system.state() === 'resolved' || system.state() === 'installed') {\n    system.state('starting');\n    if (system.start) {\n      system.start();\n    }\n    channel.$systemStarted(id);\n    system.state('active');\n  }\n}",useCoreAPI:!1,core:!0},"1a81a1f00d17269":{_id:"1a81a1f00d17269",component:"_OSGi",state:"stop",action:"function stop(id) {\n  var system = this.require(id),\n    channel = this.require('channel');\n\n  if (system.state() === 'active') {\n    system.state('stopping');\n    if (system.stop) {\n      system.stop();\n    }\n    channel.$systemStopped(id);\n    system.state('resolved');\n    channel.$systemResolved(id);\n  }\n}",useCoreAPI:!1,core:!0},"116851b602128d1":{_id:"116851b602128d1",component:"_OSGi",state:"status",action:"function status() {\n  var result = {},\n    system = null,\n    length = 0,\n    i = 0;\n\n  systems = $db._System.find({});\n\n  length = systems.length;\n  for (i = 0; i < length; i++) {\n    system = systems[i];\n    result[system.name] = {\n      'id': system._id,\n      'state': system.state,\n      'name': system.name,\n      'version': system.version,\n      'location': system.location,\n      'master': system.master\n    };\n  }\n\n  return result;\n}",useCoreAPI:!0,core:!0},"19cf317d7217331":{_id:"19cf317d7217331",component:"_OSGi",state:"bundle",action:"function bundle() { \n\tvar result = $db.exportSystem();\n\treturn result;\n}",useCoreAPI:!0,core:!0},"13010167f313f87":{_id:"13010167f313f87",component:"_Runtime",state:"system",action:"function system(params) {\n  var RuntimeSystem = null,\n    system = {},\n    systemId = '',\n    result = [],\n    conf = {};\n\n  if (params) {\n    if (typeof params === 'string') {\n      conf.master = true;\n      conf.name = params;\n    } else {\n      conf = params;\n      conf.master = true;\n    }\n    RuntimeSystem = this.require('_System');\n    system = new RuntimeSystem(conf);\n    system.state('active');\n  } else {\n    result = $db._System.find({\n      'master': true\n    });\n    if (result.length) {\n      systemId = result[0]._id;\n      system = $component.get(systemId);\n    }\n  }\n  return system;\n}",core:!0,useCoreAPI:!0},"1cfa4145f614da8":{_id:"1cfa4145f614da8",component:"_Runtime",state:"message",action:"function message(msg) { \n  $db._Message.insert(msg);\n}",useCoreAPI:!0,core:!0},"1cb9d103d41dd97":{_id:"1cb9d103d41dd97",component:"e89c617b6b15d24",state:"start",action:"function start() {\n  if (typeof document !== 'undefined') {\n    document.addEventListener('DOMContentLoaded', function DOMContentLoaded(e) {\n      var systems = [],\n        system = null,\n        scripts = [],\n        script = null,\n        logLevel = 'warn',\n        i = 0,\n        length = 0;\n    \n      systems = document.querySelectorAll('link[rel=system]');\n      length = systems.length;\n  \n      // logger\n      scripts = document.querySelectorAll('script[log]');\n      if (scripts.length) {\n        logLevel = scripts[0].getAttribute('log');\n        this.require('logger').level(logLevel);\n      }\n  \n      // systems\n      for (i = 0; i < length; i++) {\n        system = systems[i];\n  \n        if (system.getAttribute('async') === 'false') {\n          this.require('runtime').install(system.href, false);\n        } else {\n          this.require('runtime').install(system.href, true);\n        }\n      }\n  \n      // ready event\n      if (length === 0) {\n        this.require('runtime').ready();\n      }\n  }.bind(this));\n  }\n}",useCoreAPI:!0,core:!0}},types:{css:{_id:"h1d88311ac019211",name:"css",type:"string",core:!0},date:{_id:"c17cad1bc3d17752",name:"date",type:"object",core:!0},json:{_id:"e1d25a12e67127ed",name:"json",type:"object",core:!0},dbInsertEvent:{_id:"148ef1e19810e6d",core:!0,name:"dbInsertEvent",type:"object",schema:{collection:{type:"string",mandatory:!0,default:""},document:{type:"object",mandatory:!0,default:{}}}},dbRemoveEvent:{_id:"1952e1ac4213f4a",name:"dbRemoveEvent",type:"object",core:!0,schema:{collection:{type:"string",mandatory:!0,default:""},id:{type:"string",mandatory:!0,default:""}}},dbUpdateEvent:{_id:"1f5c41309711752",core:!0,name:"dbUpdateEvent",type:"object",schema:{collection:{type:"string",mandatory:!0,default:""},id:{type:"string",mandatory:!0,default:""},field:{type:"string",mandatory:!0,default:""},value:{type:"any",mandatory:!0,default:null}}},dbAction:{_id:"e1950e16f2914da9",core:!0,name:"dbAction",type:"string",value:["insert","update","remove"]},collection:{_id:"d1c0d0130c616199",name:"collection",type:"object",schema:{type:{type:["string"],mandatory:!0},readOnly:{type:"boolean",mandatory:!0},mandatory:{type:"boolean",mandatory:!0},default:{type:"object",mandatory:!0},description:{type:"string",mandatory:!1},label:{type:"string",mandatory:!1}},core:!0},errorParam:{_id:"e198761fc0b1ae8a",name:"errorParam",type:"object",schema:{message:{type:"string",mandatory:!0},error:{type:"object",mandatory:!0}},core:!0},event:{_id:"g1668d1de2d1ff6f",name:"event",type:"object",schema:{params:{type:["parameter"],mandatory:!1},description:{type:"string",mandatory:!1}},core:!0},html:{_id:"y161c21320b11acb",name:"html",type:"string",core:!0},javascript:{_id:"s13d4c1fdf916504",name:"javascript",type:"string",core:!0},link:{_id:"p124601801d1dbfa",name:"link",type:"object",schema:{type:{type:"string",mandatory:!0},readOnly:{type:"boolean",mandatory:!0},mandatory:{type:"boolean",mandatory:!0},default:{type:"{type}",mandatory:!0},description:{type:"string",mandatory:!1},label:{type:"string",mandatory:!1}},core:!0},log:{_id:"d1fd161a4a4149fc",name:"log",type:"string",value:["debug","info","warn","error"],core:!0},message:{_id:"l13b061ac571272d",name:"message",type:"object",schema:{event:{type:"string",mandatory:!0},from:{type:"string",mandatory:!1},data:{type:"object",mandatory:!0}},core:!0},method:{_id:"x1227218eed1f3e9",name:"method",type:"object",schema:{result:{type:"string",mandatory:!1},params:{type:["parameter"],mandatory:!1},description:{type:"string",mandatory:!1}},core:!0},osgiStates:{_id:"q1f0ca120fc13fb3",name:"osgiStates",type:"string",value:["none","installed","resolved","starting","active","stopping","uninstalled"],core:!0},parameter:{_id:"e1b18e16c6c195ad",name:"parameter",type:"object",schema:{description:{type:"string",mandatory:!1},name:{type:"string",mandatory:!0},type:{type:"string",mandatory:!0},mandatory:{type:"boolean",mandatory:!1},default:{type:"{type}",mandatory:!1}},core:!0},property:{_id:"a16a3a1ae051a55d",name:"property",type:"object",schema:{type:{type:"string",mandatory:!0},readOnly:{type:"boolean",mandatory:!0},mandatory:{type:"boolean",mandatory:!0},default:{type:"{type}",mandatory:!0},description:{type:"string",mandatory:!1},label:{type:"string",mandatory:!1}},core:!0},text:{_id:"c136fc129a912f54",name:"text",type:"string",core:!0}},components:{_Channel:{channel:{_id:"channel"}},_Database:{db:{_id:"db"}},_Logger:{logger:{_id:"logger",level:"warn"}},_Metamodel:{metamodel:{_id:"metamodel"}},_Runtime:{runtime:{_id:"runtime",version:"2.6.2"}}},_id:"e89c617b6b15d24"}},{}],2:[function(e,t,n){"use strict";var a=e("./db.js"),r=e("./helper.js"),o={};function i(e,t,n,a){var o=-1,i=[],s=[],d="",c="",l=!0,m=!1;return 0===t.trim().indexOf("function")&&(l=!1),l?(o=t.indexOf("=>"),(i=(-1!==(c=(c=t.substring(0,o)).replace("=>","")).indexOf("(")?c.split("(")[1].replace(")","").trim():c.trim()).split(",")).forEach(function(e){s.push(e.trim())}),0===(d=t.substring(o+2,t.length).trim()).indexOf("{")&&(d=d.substring(1,d.lastIndexOf("}")).trim()),-1===d.indexOf("\n")&&(m=!0),l&&m&&-1===d.indexOf("return ")&&(d="return "+d)):(o=t.indexOf("{"),(i=(c=t.substring(0,o)).split("(")[1].replace(")","").trim().split(",")).forEach(function(e){s.push(e.trim())}),d=(d=t.substring(o+1)).substring(0,d.lastIndexOf("}")).trim()),d=d.replace(/_this/g,"this"),""===i[0]&&(i=[]),a&&(i.push("$component"),i.push("$db"),i.push("$metamodel"),i.push("$workflow"),i.push("$behavior"),i.push("$state"),i.push("$log"),i.push("$helper")),r.isOnNode()&&i.push("require"),""!==i[0]?new Function("__body","return function "+e+" ("+i.join(",")+") { return new Function('"+i.join("','")+"', __body).apply(this, arguments) };")(d):new Function("__body","return function "+e+" () { return new Function(__body).apply(this, arguments) };")(d)}n.add=function(e,t,n,s,d,c){var l=r.generateId(),m=n.toString();return void 0===d&&(d=!1),void 0===s&&(s=!1),n=i(t,m,0,s),o[l]=n,a._Behavior.insert({_id:l,component:e,state:t,action:m,useCoreAPI:s,core:d,context:c}),l},n.remove=function(e){(e=e||{}).behaviorId=e.behaviorId||"",e.componentId=e.componentId||"",e.state=e.state||"",e.componentId&&(e.behaviorId?(a._Behavior.remove({_id:e.behaviorId,component:e.componentId,state:e.state}),delete o[e.behaviorId]):(e.state?a._Behavior.remove({component:e.componentId,state:e.state}):a._Behavior.remove({component:e.componentId})).forEach(function(e){delete o[e]}))},n.removeFromMemory=function(e){delete o[e]},n.getActions=function(e,t){var n=[],r=null;return a._Behavior.find({component:e,state:t}).forEach(function(e){void 0===(r=o[e._id])&&(r=i(e.state,e.action,e.core,e.useCoreAPI),o[e._id]=r),n.push({useCoreAPI:e.useCoreAPI,context:e.context,action:r})}),n},n.clear=function(){o={}},n.get=function(e){return o[e]}},{"./db.js":4,"./helper.js":5}],3:[function(e,t,n){"use strict";var a=e("./workflow.js"),r=e("./db.js"),o=e("./metamodel.js"),i=e("./behavior.js"),s=e("./helper.js"),d=e("./log.js"),c=e("./state.js"),l="property",m="link",u="collection",y="method",f="event",p="_name",h={};function g(e){var t=[],n=[],r="",i="",c="",l="",m=!1;function u(){var e=0,a=0,i=t.length;for(n.forEach(function(n){o.isClassName(r)?t[e]=s.getRuntime().require(n):t[e]=n,e+=1}),a=e;a<i;a++)delete t[a];t.length=n.length}function y(e,t,u,y){var f=0,p=0,g=[];if(m)d.readOnlyProperty(i,c,l);else if(o.isClassName(r))if(e&&o.inheritFrom(e.constructor.name,r.replace("@",""))){switch(!0){case"push"===t:n.push(e.id());break;case"unshift"===t:n.unshift(e.id());break;case"splice"===t:for(p=(g=n.splice(u,y,e)).length,f=0;f<p;f++)a.state({component:i,state:l,data:[h[g[f]],"remove"]})}s.isRuntime()&&s.getRuntime().require("db").update({collection:c,id:i,field:l,value:n}),a.state({component:i,state:l,data:[e,"add"]})}else void 0!==e.id?d.invalidPropertyName(i,c,l,e.id(),r):d.invalidPropertyName(i,c,l,e,r);else if(e&&o.isValidType(e,r)){switch(!0){case"push"===t:n.push(e);break;case"unshift"===t:n.unshift(e);break;case"splice"===t:n.splice(u,y,e)}s.isRuntime()&&s.getRuntime().require("db").update({collection:c,id:i,field:l,value:n}),a.state({component:i,state:l,data:[e,"add"]})}else d.invalidPropertyName(i,c,l,e,r);return n.length}function f(e){var t,u=null;if(m)d.readOnlyProperty(i,c,l);else if(0!==n.length){switch(!0){case"pop"===e:u=n.pop();break;case"shift"===e:u=n.shift()}s.isRuntime()&&s.getRuntime().require("db").update({collection:c,id:i,field:l,value:n}),t=o.isClassName(r)?h[u]:u,a.state({component:i,state:l,data:[t,"remove"]})}return t}return r=(e=e||{}).type||"",i=e.id||"",l=e.propertyName||"",n=e.arr||[],c=e.classId||"",void 0!==e.readOnly&&(m=e.readOnly),n.forEach(function(e){o.isClassName(r)?t.push(s.getRuntime().require(e)):t.push(e)}),t.push=function(e){var t=y(e,"push");return u(),t},t.unshift=function(e){var t=y(e,"unshift");return u(),t},t.concat=function(t){var a,r=0,o=0;if(Array.isArray(t))for(o=t.length,r=0;r<o;r++)y(t[r],"push");return e.arr=n,a=new g(e),u(),a},t.pop=function(){var e=f("pop");return u(),e},t.shift=function(){var e=f("shift");return u(),e},t.sort=function(e){var a;return n.sort(e),s.isRuntime()&&s.getRuntime().require("db").update({collection:c,id:i,field:l,value:n}),a=t,u(),a},t.reverse=function(){return n.reverse(),s.isRuntime()&&s.getRuntime().require("db").update({collection:c,id:i,field:l,value:n}),u(),t},t.splice=function(e,t,d){var m=[],f=0,p=0,g=null;if(void 0!==d)y(d,"splice",e,t);else for(m=n.splice(e,t),s.isRuntime()&&s.getRuntime().require("db").update({collection:c,id:i,field:l,value:n}),p=m.length,f=0;f<p;f++)g=o.isClassName(r)?h[m[f]]:m[f],a.state({component:i,state:l,data:[g,"remove"]});return u(),m},t.slice=function(e,t){var a=n.slice(e,t);return u(),a},t}function v(e,t){var n,a=[],r=0,i=0;if(n=o.getModel(e)[t].params)for(r=n.length,i=0;i<r;i++)a.push(n[i].name);return a}function b(e,t,n){var a=null,o=r.store[e][t],i=n.split("."),s=i.length,d=0;for(a=o,d=0;d<s;d++)a=a[i[d]];return a}function _(e,t,n,a){var o=null,i=r.store[e][t],s=n.split("."),d=s.length,c=0;for(o=i,c=0;c<d-1;c++)o=o[s[c]];o[s[c]]=a}function O(e,t,c){(function(e){var t,n,a,r,i=0,s=[];for(t=o.getModel(e),n=o.getSchema(t[p]),r=(a=Object.keys(n)).length,i=0;i<r;i++)n[a[i]]!==m&&n[a[i]]!==l&&n[a[i]]!==u||s.push({name:a[i],type:t[a[i]].type,readOnly:t[a[i]].readOnly});return s})(e).forEach(function(l){var m,u,y={},f="";m=l.name,f=l.type,u=l.readOnly,Array.isArray(f)||"array"===f?(y=function(e,t){var n,i,l,y,p,h,v=[],b=null,_=null,O=null;if(void 0===t){if(void 0===e)return new g({id:this.id(),propertyName:m,readOnly:u,classId:c,type:"array"===f?"any":f[0],arr:r.store[c][this.id()][m]});if(Array.isArray(e))y=e,p="array"===f?"any":f[0],h=!0,y.forEach(function(e){o.isValidType(e,p)&&o.inheritFrom(e.constructor.name,p.replace("@",""))&&o.isClassName(p)||(h=h&&!1)}),(v=r[c].find({_id:this.id()})).length&&(b=v[0],n=e,i="array"===f?"any":f[0],l=[],n.forEach(function(e){if(o.isClassName(i))switch(!0){case"string"==typeof e:l.push(e);break;case void 0!==e.id:l.push(e.id());break;default:l.push(null)}else l.push(e)}),O=l,a.state({component:this.id(),state:m,data:[e,"reset"]}),b[m]=O,s.isRuntime()&&s.getRuntime().require("db").update({collection:c,id:this.id(),field:m,value:b[m]}));else if("number"==typeof e){if(_=r.store[c][this.id()][m][e])return O=o.isClassName("array"===f?"array":f[0])?s.getRuntime().require(_):_}else d.invalidPropertyName(this.id(),this.constructor.name,m,e,"number")}else if(u)d.readOnlyProperty(this.id(),this.constructor.name,m);else if(o.isValidType(t,"array"===f?"any":f[0])||o.inheritFrom(t.constructor.name,"array"===f?"array":f[0].replace("@",""))&&o.isClassName("array"===f?"array":f[0])){if((v=r[c].find({_id:this.id()})).length){if(o.isClassName("array"===f?"array":f[0]))switch(!0){case"string"==typeof t:O=t;break;case void 0!==t.id:O=t.id();break;default:O=""}else O=t;(b=v[0])[m][e]=O,s.isRuntime()&&s.getRuntime().require("db").update({collection:c,id:this.id(),field:m,value:b[m]}),a.state({component:this.id(),state:m,data:[t,"add"]})}}else d.invalidPropertyName(this.id(),this.constructor.name,m,t,f)},t.prototype[m]=new Function("__body","return function "+m+" (position, value) { return __body.call(this, position, value) };")(y)):(y=function(t){var l=[],y=null,p=null;if(void 0===t){if(y=r.store[c][this.id()]){switch(!0){case o.isClassName(f):p=n.get(y[m]);break;case"date"===f:p=new Date(y[m]);break;case"json"===f:p=JSON.parse(JSON.stringify(y[m]));break;case"array"===f:p=new g({id:this.id(),propertyName:m,readOnly:u,classId:c,type:"any",arr:r.store[c][this.id()][m]});break;case o.isStructure(m,c):p=function e(t,c,l,m){var u=(y=c,f=l,h=null,v=[],p=o.getModel(f)[y].type,(h=o.getType(p)).schema&&Object.keys(h.schema).forEach(function(e){h.schema[e].name=e,v.push(h.schema[e])}),v);var y,f,p,h,v;var O={};u.forEach(function(u){var y={},f="",p="",h="";f=u.name,p=u.type,h=u.readOnly,"array"===p?(y=function(e,n){var i,u,y="",v="";if(v=(y=t?y+"."+c:c)+"."+f,void 0===n){if(void 0===e)return new g({id:m,propertyName:v,readOnly:h,classId:l,type:"any",arr:b(l,m,v)});if(Array.isArray(e))i="any",u=!0,e.forEach(function(e){o.isValidType(e,i)||(u=u&&!1)}),r[l].find({_id:m}).length&&(_(l,m,v,e),a.state({component:m,state:v,data:[e,"reset"]}),s.isRuntime()&&s.getRuntime().require("db").update({collection:l,id:m,field:v,value:e}));else{if("number"==typeof e)return b(l,m,v)[e];d.invalidPropertyName(m,this.constructor.name,f,e,"number")}}else if(h)d.readOnlyProperty(m,this.constructor.name,f);else if(o.isValidType(n,"any")){if(r[l].find({_id:m}).length){var O=b(l,m,v);void 0===O&&(O=[]),O[e]=n,_(l,m,v,O),s.isRuntime()&&s.getRuntime().require("db").update({collection:l,id:m,field:v,value:O}),a.state({component:m,state:v,data:[O,"add"]})}}else d.invalidPropertyName(m,this.constructor.name,f,n,p)},O[f]=new Function("__body","return function "+f+" (position, value) { return __body.call(this, position, value) };")(y)):(y=function(y){var g=[],v=null,O="",k="";if(k=(O=t?O+"."+c:c)+"."+f,void 0===y){if(r.store[l][m]){switch(!0){case o.isClassName(p):v=n.get(b(l,m,k));break;case"date"===p:v=new Date(b(l,m,k));break;case"json"===p:v=JSON.parse(JSON.stringify(b(l,m,k)));break;case o.isStructure(f,l):v=e(O,f,l,m);break;default:v=b(l,m,k)}return void 0===v&&void 0!==u.default&&(v=u.default),v}d.destroyedComponentCall(k,m)}else if(h)d.readOnlyProperty(m,l,k);else if(o.isValidType(y,p)){if((g=r[l].find({_id:m})).length){switch(g[0],!0){case o.isClassName(p):_(l,m,k,y.id());break;case"date"===p:_(l,m,k,y.toISOString());break;default:_(l,m,k,y)}s.isRuntime()&&s.getRuntime().require("db")&&s.getRuntime().require("db").update({collection:l,id:m,field:k,value:y}),"_Behavior"===l&&i.removeFromMemory(m),a.state({component:m,state:k,data:[y]})}}else d.invalidPropertyName(m,l,k,y,p)},O[f]=new Function("__body","return function "+f+" (value) { return __body.call(this,value) };")(y))});return O}("",m,e,this.id());break;default:p=y[m]}return p}d.destroyedComponentCall(m,this.id())}else if(u)d.readOnlyProperty(this.id(),this.constructor.name,m);else if(o.isValidType(t,f)){if((l=r[c].find({_id:this.id()})).length){switch(y=l[0],!0){case o.isClassName(f):y[m]=null===t?t:t.id();break;case"date"===f:y[m]="string"==typeof t?t:t.toISOString();break;default:y[m]=t}s.isRuntime()&&s.getRuntime().require("db")&&s.getRuntime().require("db").update({collection:c,id:this.id(),field:m,value:t}),"_Behavior"===c&&i.removeFromMemory(this.id()),a.state({component:this.id(),state:m,data:[t]})}}else d.invalidPropertyName(this.id(),this.constructor.name,m,t,f)},t.prototype[m]=new Function("__body","return function "+m+" (value) { return __body.call(this,value) };")(y))})}function k(e,t,n){(function(e){var t,n,a,r,i=0,s=[];for(t=o.getModel(e),n=o.getSchema(t[p]),r=(a=Object.keys(n)).length,i=0;i<r;i++)n[a[i]]===y&&s.push(a[i]);return s})(e).forEach(function(e){var r=v(n,e),o=r.join(", "),i="",s=function(){return a.state({component:this.id(),state:e,data:arguments})},c=function(){var t=null,r=Array.prototype.slice.call(arguments);return r.shift(),arguments[0]?t=a.state({component:this.id(),state:e,data:r,context:arguments[0]}):d.unknownContext(n,e),t};o?(r.unshift("context"),i=r.join(", "),t.prototype[e]=new Function("__body","return function "+e+" ("+o+") { return __body.call(this,"+o+") };")(s),"name"!==e&&(t[e]=new Function("__body","return function "+e+" ("+i+") { return __body.call(this,"+i+") };")(c))):(t.prototype[e]=new Function("__body","return function "+e+" () { return __body.call(this) };")(s),"name"!==e&&(t[e]=new Function("__body","return function "+e+" (context) { return __body.call(this, context) };")(c)))})}function w(e,t,n){(function(e){var t,n,a,r,i=0,s=[];for(t=o.getModel(e),n=o.getSchema(t[p]),r=(a=Object.keys(n)).length,i=0;i<r;i++)n[a[i]]===f&&s.push(a[i]);return s})(e).forEach(function(e){var o=v(n,e).join(", "),i=function(){var t=[],o="e89c617b6b15d24",i=[],s=0,d=-1,c={};if("_Channel"===n){for((t=r._System.find({master:!0})).length&&(o=t[0]._id),c.from=o,d=arguments.length,s=0;s<d;s++)i.push(arguments[s]);c.data=i,c.event=e,r._Message.insert(c),a.state({component:this.id(),state:"send",data:[{event:c.event,from:c.from,data:c.data}]})}else a.state({component:this.id(),state:e,data:arguments})};t.prototype[e]=o?new Function("__body","return function "+e+" ("+o+") { return __body.call(this,"+o+") };")(i):new Function("__body","return function "+e+" () { return __body.call(this) };")(i)})}function S(e){var t,l,m,u,y,f={},p="";return p=void 0===(e=e||{}).model?s.generateId():e.model,t=p,f=new Function("__body","return function "+t+" (config) { __body.call(this,config) };")(function(e){var n={};"Object"!==(e=e||{}).constructor.name&&(d.invalidConctructorParameters(e,t),e={}),o.isValidObject(e,o.getModel(t),!0,!0)||d.invalidParameters(t),o.prepareObject(e,o.getModel(t)),void 0===e._id&&(e._id=s.generateId()),h[e._id]=this,n=function(){return e._id},this.id=new Function("__body","return function id () { return __body.call(this) };")(n),r.store[t][e._id]=e,r.createLog("insert",t,e._id,"",e),s.isRuntime()&&s.getRuntime().require("db")&&s.getRuntime().require("db").insert({collection:t,document:e}),Object.freeze(this),this.init&&this.init(e)}),h[p]=f,l=p,f.id=new Function("__body","return function id () { return __body.call(this) };")(function(){return l}),O(e.model,f,p),k(e.model,f,p),w(e.model,f,p),o.inheritFrom(p,"_Component")&&(y=p,f.prototype.on=new Function("__body","return function on (state, action, useCoreAPI, isCore) { return __body.call(this, state, action, useCoreAPI, isCore) };")(function(e,t,n,s){var l="",m="",u=null;return n&&n.constructor&&"Boolean"!==n.constructor.name&&(u=n,n=!1,s=!0),a.checkParams({component:this,methodName:"on",args:arguments})&&(o.isValidState(e,y)?o.isEvent(e,y)||o.isProperty(e,y)||o.isLink(e,y)||o.isCollection(e,y)||!(r._Behavior.find({component:this.id(),state:e}).length>=1)?a.validParamNumbers(y,e,t)?(l=i.add(this.id(),e,t,n,s,u),(m=c.get(this.id()))&&m.state===e&&a.action(l,m.value)):d.invalidParamNumberMethodOn(this.id(),this.constructor.name,e):d.behaviorNotUnique(y,e):d.invalidStateOn(y,e)),l}),u=p,f.on=new Function("__body","return function on (state, action, useCoreAPI, isCore) { return __body.call(this, state, action, useCoreAPI, isCore) };")(function(e,t,n,s){var l="",m="",y=null;return n&&n.constructor&&"Boolean"!==n.constructor.name&&(y=n,n=!1,s=!0),a.checkParams({component:this,methodName:"on",args:arguments})&&(o.isValidState(e,u)?o.isEvent(e,u)||o.isProperty(e,u)||o.isLink(e,u)||o.isCollection(e,u)||!(r._Behavior.find({component:this.id(),state:e}).length>=1)?a.validParamNumbers(u,e,t)?(l=i.add(this.id(),e,t,n,s,y),(m=c.get(this.id()))&&m.state===e&&a.action(l,m.value)):d.invalidParamNumberMethodOn(this.id(),this.constructor.name,e):d.behaviorNotUnique(u,e):d.invalidStateOn(u,e)),l}),m=p,f.off=new Function("__body","return function off (state, behaviorId) { return __body.call(this, state, behaviorId) };")(function(e,t){a.checkParams({component:this,methodName:"off",args:arguments})&&(o.isValidState(e,m)?i.remove({behaviorId:t,componentId:m,state:e}):d.invalidStateOff(m,e))}),f.require=new Function("__body","return function require (id) { return __body.call(this, id) };")(function(e){return n.get(e)}),f.init=new Function("__body","return function init (conf) { return __body.call(this, conf) };")(function(){}),f.destroy=new Function("__body","return function destroy () { return __body.call(this) };")(function(){var e,t=this.id(),n=[],o=0;for(r[t]&&(n=r[t].remove()),delete h[t],i.remove({componentId:t}),e=n.length,o=0;o<e;o++)i.remove({componentId:n[o]});a.state({component:t,state:"destroy"})}),f.classInfo=new Function("__body","return function classInfo () { return __body.call(this) };")(function(){return n.get(this.id()+"Info")})),Object.freeze(f),f}g.prototype=[],n.get=function(e){return h[e]},n.create=function(e){return S(e)},n.destroy=function(e){var t=h[e],n="";t&&(delete h[e],n=t.constructor.name,r[n].remove({_id:e}),i.remove({componentId:e}),"_Behavior"===n&&i.removeFromMemory(e))},n.removeFromMemory=function(e){delete h[e]},n.clear=function(){h={}}},{"./behavior.js":2,"./db.js":4,"./helper.js":5,"./log.js":6,"./metamodel.js":7,"./state.js":9,"./workflow.js":10}],4:[function(e,t,n){"use strict";var a=e("./component.js"),r=e("./metamodel.js"),o=e("./helper.js"),i=e("./log.js"),s=e("./behavior.js"),d=e("./state.js"),c=e("./workflow.js"),l=[],m=["_Runtime","_Schema","_Model","_GeneratedModel","_Behavior","_State","_Type","_Metamodel","_Database","_System","_ClassInfo","_Message","_Channel","_Logger","_Log"],u=["_Log","_Schema","_Logger","_Model","_GeneratedModel","_State","_Type"],y=0;function f(){var e=[];return e.sort=function(t){var n="",a=[];return e.forEach(function(e){a.push(e)}),t instanceof Function?a.sort(t):(n=Object.keys(t)[0],a.sort(function(e,a){return e[n]<a[n]?1===t[n]?-1:1:e[n]>a[n]?1===t[n]?1:-1:0})),a},e}function p(e,t,n){var a=!0,r="";e:for(r in t)switch(!0){case"$eq"===r:if(t[r]instanceof RegExp){if(null===n[e].toString().match(t[r])){a=!1;break e}}else if(n[e]!==t[r]){a=!1;break e}break;case"$gt"===r:if(n[e]<=t[r]){a=!1;break e}break;case"$gte"===r:if(n[e]<t[r]){a=!1;break e}break;case"$lt"===r:if(n[e]>=t[r]){a=!1;break e}break;case"$lte"===r:if(n[e]>t[r]){a=!1;break e}break;case"$ne"===r:if(n[e]===t[r]){a=!1;break e}break;case"$in"===r:if(Array.isArray(t[r])&&-1===t[r].indexOf(n[e])){a=!1;break e}break;case"$nin"===r:if(Array.isArray(t[r])&&-1!==t[r].indexOf(n[e])){a=!1;break e}}return a}function h(e,t){var n=!0,a=!1,r="",o=0,i=0;e:for(r in e){if(void 0===t[r]){n=!1;break}switch(!0){case e[r]instanceof RegExp:if(Array.isArray(t[r])&&!Array.isArray(e[r])){for(i=t[r].length,o=0;o<i;o++)if(null!==t[r][o].toString().match(e[r])){a=!0;break e}n=a}else if(null===t[r].toString().match(e[r])){n=!1;break e}break;case e[r]instanceof Object&&!Array.isArray(e[r]):n=p(r,e[r],t);break;case Array.isArray(t[r])&&!Array.isArray(e[r]):if(-1===t[r].indexOf(e[r])){n=!1;break e}break;default:if(t[r]!==e[r]){n=!1;break e}}}return n}function g(){var e,t="",a="",r=null,o=null,s=null,d={};if((e=n._System.find({master:!0})).length){r=(s=e[0])._id,d._id=r,d.name=s.name,d.description=s.description,d.version=s.version,d.master=!0,o=function(){var e,t={},a="",r="",o="",i=null,s=null,d=null,c=null,m=null,u="",y="",f=0,p="";if(t.schemas={},n._Schema.count())for(u in n.store._Schema)n.store._Schema[u]._core||(d=JSON.parse(JSON.stringify(n.store._Schema[u])),t.schemas[u]=d);if(t.models={},n._Model.count())for(y in n.store._Model)n.store._Model[y]._core||(c=JSON.parse(JSON.stringify(n.store._Model[y])),t.models[y]=c);if(t.types={},n._Type.count())for(o in n.store._Type)n.store._Type[o].core||(i=JSON.parse(JSON.stringify(n.store._Type[o])),t.types[i.name]=i);t.behaviors={};for(r in n.store._Behavior)n.store._Behavior[r].core||(s=JSON.parse(JSON.stringify(n.store._Behavior[r])),t.behaviors[r]=s);for(t.components={},e=l.length,f=0;f<e;f++)if(a=l[f],n[a].count()){m=JSON.parse(JSON.stringify(n.store[a]));for(p in m)m[p]._core&&delete m[p];Object.keys(m).length&&(t.components[a]=m)}return t}();for(a in o)o.hasOwnProperty(a)&&(d[a]=o[a]);t=JSON.stringify(d)}else t="{}",i.masterSystemNotFound();return t}f.prototype=[],n.store={};var v=function(e){r.getSchema(e)||-1!==m.indexOf(e)?(n.store[e]={},this.name=e,-1===m.indexOf(e)&&l.push(e)):i.invalidCollectionName(e)};v.prototype.find=function(e){var t=new f,a={},r="",o={};if((e=e||null)&&Object.keys(e).length)if(Array.isArray(e))e.forEach(function(e){for(r in n.store[this.name])h(e,o=n.store[this.name][r])&&void 0===a[r]&&(t.push(o),a[r]=!0)}.bind(this));else for(r in n.store[this.name])h(e,o=n.store[this.name][r])&&t.push(o);else for(r in n.store[this.name])o=n.store[this.name][r],t.push(o);return t},v.prototype.insert=function(e){var t=[],s=null,d=[];return Array.isArray(e)?t=e:t.push(e),t.forEach(function(e){var t=null,l=[];switch(!0){case"_Schema"===this.name:case"_Logger"===this.name:case"_Model"===this.name:case"_Type"===this.name:case"_GeneratedModel"===this.name:case r.isValidObject(e,r.getModel(this.name)):if(void 0===e._id&&(e._id=o.generateId()),r.prepareObject(e,r.getModel(this.name)),n.store[this.name][e._id]=e,(s=a.get(this.name))?(t=new s(e),d.push(t.id())):(n.createLog("insert",this.name,e._id,"",e),o.isRuntime()&&o.getRuntime().require("db")&&o.getRuntime().require("db").insert({collection:this.name,document:e})),"_Message"===this.name&&o.isRuntime())for(var m=(l=n._Channel.find({})).length,u=0;u<m;u++)o.getRuntime().require(l[u]._id),c.state({component:l[u]._id,state:e.event,data:e.data});break;default:i.invalidDocumentOnDbInsert(e,this.name)}}.bind(this)),d},v.prototype.update=function(e,t,s){var d=this.find(e),l=0,m=0,u=d.length,y="",f=r.getModel(this.name),p="";if(void 0===(s=s||{}).upsert&&(s.upsert=s.upsert||!1),t)for(0===u&&s.upsert&&(e._id&&(t._id=e._id),this.insert(t),l+=1),m=0;m<u;m++){void 0!==t._id&&t._id!==d[m]._id&&i.updateUuid(d[m]._id,t._id,void 0!==a.get(t._id));for(y in t)void 0!==d[m][y.split(".")[0]]&&("_Schema"!==this.name&&"_Model"!==this.name&&"_GeneratedModel"!==this.name?(p="",0!==y.indexOf("_")?p=-1!==y.indexOf(".")?r.getModelPathType(this.name,y):f[y].type:r.getMetaDef()[y]&&(p=r.getMetaDef()[y].type),p?r.isValidType(t[y],p)?(d[m][y]=t[y],l+=1,n.createLog("update",this.name,d[m]._id,y,t[y]),o.isRuntime()&&o.getRuntime().require("db")&&o.getRuntime().require("db").update({collection:this.name,id:d[m]._id,field:y,value:t[y]}),"array"===p?c.state({component:d[m]._id,state:y,data:[t[y],"reset"]}):c.state({component:d[m]._id,state:y,data:[t[y]]})):i.invalidPropertyTypeOnDbUpdate(this.name,d[m]._id,y,t[y],p):i.unknownPropertyOnDbUpdate(this.name,y,d[m]._id)):(d[m][y]=t[y],n.createLog("update",this.name,d[m]._id,y,t[y]),l+=1,o.isRuntime()&&o.getRuntime().require("db")&&o.getRuntime().require("db").update({collection:this.name,id:d[m]._id,field:y,value:t[y]})))}return l},v.prototype.remove=function(e){var t=[],r="",i=null;if((e=e||null)&&Object.keys(e).length)if(Array.isArray(e))e.forEach(function(e){for(r in n.store[this.name])h(e,n.store[this.name][r])&&(delete n.store[this.name][r],n.createLog("remove",this.name,r,"",""),(i=a.get(r))&&i.destroy(),o.isRuntime()&&o.getRuntime().require("db")&&o.getRuntime().require("db").remove({collection:this.name,id:r}),t.push(r))}.bind(this));else for(r in n.store[this.name])h(e,n.store[this.name][r])&&(delete n.store[this.name][r],n.createLog("remove",this.name,r,"",""),(i=a.get(r))&&i.destroy(),o.isRuntime()&&o.getRuntime().require("db")&&o.getRuntime().require("db").remove({collection:this.name,id:r}),t.push(r));else for(r in n.store[this.name])delete n.store[this.name][r],n.createLog("remove",this.name,r,"",""),-1===u.indexOf(this.name)&&(i=a.get(r))&&i.destroy(),o.isRuntime()&&o.getRuntime().require("db")&&o.getRuntime().require("db").remove({collection:this.name,id:r}),t.push(r);return t},v.prototype.count=function(){var e=0,t="";for(t in n.store[this.name])e++;return e},n.createLog=function(e,t,a,r,i){var s=o.generateId();t=t||"",a=a||"",r=r||"",i=i||"",Object.keys(n.store._Log).length>1e3&&(n.store._Log={}),n.store._Log[s]={_id:s,action:e,collection:t,id:a,field:r,value:i,order:y++}},n.collection=function(e){n[e]=new v(e)},n.importSystem=function(e){return function(e){var t="",a="",o="",i="",s="",d="",c="",l=[];if(e){delete e.subsystem;for(i in e.types)r.type(e.types[i]);for(s in e.schemas)r.schema(e.schemas[s]);for(d in e.models)r.model(e.models[d]);r.create();for(c in e.behaviors)n._Behavior.insert(e.behaviors[c]);for(a in e.components)for(o in e.components[a])n[a].insert(e.components[a][o]);(l=n._System.find({master:!0})).length&&(l[0]._id===e._id?e.master=!0:e.master&&(l[0].master=!1)),n._System.insert(e),t=e._id}return t}(e)},n.exportSystem=function(e){return e?function(e){var t={},a=[],r="",o=0,i=0,s=null,d=null,c=null,l=null,m=null,u="";if((a=n._System.find({master:!0})).length&&(r=a[0].name),t.name=e.name||"sub_"+r,t.version=e.version||"0.0.1",t.description=e.description||"",t.schemas={},e.schemas)for(i=(a=n._Schema.find(e.schema)).length,o=0;o<i;o++)(s=a[o])._core||(t.schemas[s._id]=s);if(t.models={},e.models)for(i=(a=n._Model.find(e.models)).length,o=0;o<i;o++)(c=a[o])._core||(t.models[c._id]=c);if(t.types={},e.types)for(i=(a=n._Type.find(e.types)).length,o=0;o<i;o++)(d=a[o])._core||(t.types[d._id]=d);if(t.behaviors={},e.behaviors)for(l=n._Behavior.find(e.behaviors),i=a.length,o=0;o<i;o++)(l=a[o]).core||(t.behaviors[l._id]=l);if(t.components={},e.components)for(u in e.components)if(n[u])for(t.components[u]={},i=(a=n[u].find(e.components[u])).length,o=0;o<i;o++)m=a[o],t.components[u][m._id]=m;return JSON.stringify(t)}(e):g()},n.clear=function(){var e=0,t=0,a="";for(e=l.length,t=0;t<e;t++)a=l[t],n[a].remove();for(e=m.length,t=0;t<e;t++)a=m[t],n[a].remove()},n.init=function(){var e,t;t=n._System.find({_id:"e89c617b6b15d24"})[0],n.clear(),a.clear(),r.clear(),d.clear(),s.clear(),r.init(),e=n.importSystem(t),a.get(e).start()}},{"./behavior.js":2,"./component.js":3,"./helper.js":5,"./log.js":6,"./metamodel.js":7,"./state.js":9,"./workflow.js":10}],5:[function(require,module,exports){(function(global){"use strict";var $db=require("./db.js"),$component=require("./component.js"),runtimeRef=null,requireRef=null;exports.isRuntime=function(){var e=!1;return $db._Runtime&&$db._Runtime.find().length&&(e=!0),e},exports.getRuntime=function(){var e="";return runtimeRef||(e=$db._Runtime.find()[0]._id,runtimeRef=$component.get(e)),runtimeRef},exports.isOnNode=function(){var e=!1;return"undefined"==typeof window&&void 0!==global&&(e=!0),e},exports.getRequire=function getRequire(){return requireRef||(requireRef=eval("require")),requireRef},exports.generateId=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16)}return(t="abcdefghijklmnopqrstuvwxyz").charAt(Math.floor(Math.random()*t.length))+e()+e()+e();var t},exports.polyfill=function(){void 0===Function.prototype.name&&void 0!==Object.defineProperty&&Object.defineProperty(Function.prototype,"name",{get:function(){var e=/function\s([^(]{1,})\(/.exec(this.toString());return e&&e.length>1?e[1].trim():""},set:function(e){}})}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./component.js":3,"./db.js":4}],6:[function(e,t,n){"use strict";var a=e("./metamodel.js"),r=e("./db.js"),o=e("./component.js"),i="_id",s={currentLevel:"warn",level:function(e){return e&&(this.currentLevel=e),this.currentLevel},debug:function(e){"debug"===this.currentLevel&&console.log("runtime: "+e)},info:function(e){"info"!==this.currentLevel&&"debug"!==this.currentLevel||console.info("runtime: "+e)},warn:function(e){"info"!==this.currentLevel&&"warn"!==this.currentLevel&&"debug"!==this.currentLevel||console.warn("runtime: "+e)},error:function(e){console.error("runtime: "+e)}};function d(){var e="",t=[],n=null;return a.getModel("_Logger")&&(t=r._Logger.find()).length?(e=t[0][i],n=o.get(e)?o.get(e):s):n=s,n}n.level=function(e){e},n.unknownProperty=function(e,t){var n="";n=t._name?"unknown property '"+e+"' for the definition of '"+t._name+"'":"unknown property '"+e+"' for a model",d().warn(n)},n.invalidPropertyType=function(e,t,n){d().warn("invalid type for property '"+e+"': expected type '"+t+"' instead of type '"+typeof n+"'")},n.invalidEnumValue=function(e,t){d().warn("'"+e+"' is an invalid value for the type enum '"+t+"'")},n.invalidClassName=function(e,t,n){d().warn("invalid class name for component '"+e+"': expected '"+t+"' instead of '"+n+"'")},n.missingProperty=function(e){d().warn("missing property '"+e+"' for a schema or a model")},n.missingImplementation=function(e){d().warn("schema '"+e+"' is missing.")},n.invalidTypeImp=function(e,t){d().error("the property '"+e+"' of the model '"+t+"' is invalid")},n.missingPropertyImp=function(e,t){d().warn("missing property '"+e+"' in the model '"+t+"'")},n.unknownPropertyImp=function(e,t){d().error("the model '"+t+"' has an unknown property '"+e+"'")},n.invalidTypeDefinition=function(e){d().warn("the type '"+e+"' is not valid")},n.invalidPropertyName=function(e,t,n,a,r){var o="";"Function"!==t&&(o=" (class '"+t+"')"),"string"==typeof r?d().warn("invalid type for property '"+n+"' on component '"+e+"'"+o+": expected '"+r.replace("@","")+"' instead of '"+typeof a+"'"):d().warn("invalid type for property type '"+n+"' on component '"+o+": expected 'string' instead of '"+typeof r+"'")},n.readOnlyProperty=function(e,t,n){var a="";"Function"!==t&&(a=" (class '"+t+"')"),d().warn("can not set read-only property '"+n+"' on component '"+e+"'"+a)},n.invalidDocumentOnDbInsert=function(e,t){d().warn("invalid document '"+JSON.stringify(e).replace(/,/g,", ")+"' on an insert operation on collection '"+t+"'")},n.invalidPropertyTypeOnDbUpdate=function(e,t,n,a,r){d().warn("invalid type when trying to update the property '"+n+"' of document '"+t+"' (collection '"+e+"') with the value '"+JSON.stringify(a)+"': expected type '"+r+"'")},n.unknownPropertyOnDbUpdate=function(e,t,n){d().warn("unknown property '"+e+"' on an update operation on collection '"+t+"' with component '"+n+"'")},n.unknownMethod=function(e,t){d().warn("try to call an unknown method '"+t+"' for the class '"+e+"'")},n.invalidCollectionName=function(e){d().warn("invalid name for creating the collection '"+e+"': there is no schema '"+e+"' in the metamodel")},n.invalidResultType=function(e,t,n,a,r){var o="";"Function"!==t&&(o=" (class '"+t+"')"),r?d().warn("invalid type for the result of method '"+n+"' on component '"+e+"'"+o+": expected type '"+a.replace("@","")+"' instead of type '"+r+"'"):d().warn("invalid type for the result of method '"+n+"' on component '"+e+"'"+o+": expected type '"+a.replace("@","")+"'")},n.unknownComponent=function(e,t){d().warn("unkown class component '"+e+"' for component '"+t+"'")},n.workflowRestarted=function(){d().warn("runtime has been restarted")},n.invalidParamNumber=function(e,t,n){var a="";"Function"!==t&&(a=" (class '"+t+"')"),d().warn("invalid number of parameters when calling the method '"+n+"' on component '"+e+"'"+a)},n.invalidParamType=function(e,t,n,a){var r="";"Function"!==t&&(r=" (class '"+t+"')"),void 0!==a?d().warn("invalid type for the parameter '"+a+"' when calling the method '"+n+"' on component '"+e+"'"+r):d().warn("invalid type for a parameter when calling the method '"+n+"' on component '"+e+"'"+r)},n.behaviorNotUnique=function(e,t){d().warn("try to add more than one behavior for the state '"+t+"' on class '"+e+"'")},n.invalidStateOn=function(e,t){d().warn("try to add a behavior to an unkwown state '"+t+"' on class '"+e+"'")},n.invalidStateOff=function(e,t){d().warn("try to remove a behavior from an unkwown state '"+t+"' on class '"+e+"'")},n.masterSystemNotFound=function(){d().warn("can not export the database because no system was defined")},n.invalidType=function(e,t){d().warn("invalid type for value '"+JSON.stringify(e)+"': expected '"+t+"'")},n.unknownType=function(e){d().warn("unknown type for value '"+JSON.stringify(e)+"'")},n.canNotYetValidate=function(e,t){d().debug("can not yet validate if the component '"+e+"' is an instance of '"+t+"'")},n.invalidChannelEvent=function(e,t,n){d().warn("invalid type for the message '"+JSON.stringify(e)+"': expected type '"+n+"' for event '"+t+"'")},n.invalidParamNumberMethodOn=function(e,t,n){var a="";"Function"!==t&&(a=" (class '"+t+"')"),d().warn("invalid number of parameters when adding a behavior on method '"+n+"' on component '"+e+"'"+a)},n.updateUuid=function(e,t,n){n?d().warn("try to update a component of id '"+e+"' with the new id '"+t+"' that is already used"):d().warn("try to update a component of id '"+e+"' with the new id '"+t+"'")},n.invalidUseOfComponent=function(e){d().warn("try to change the state of the destroyed component '"+e+"'")},n.invalidSchema=function(e){d().warn("the schema '"+e+"' is not valid, it has been removed from the metamodel")},n.invalidModel=function(e){d().warn("the model '"+e+"' is not valid, it has been removed from the metamodel")},n.invalidParameters=function(e){d().warn("the parameters for creating a component of class '"+e+"' are not compliant with the model")},n.destroyedComponentCall=function(e,t){d().warn("trying to get the property '"+e+"' on the destroyed component '"+t+"'")},n.invalidConctructorParameters=function(e,t){d().warn("the constructor parameter '"+JSON.stringify(e).replace(/,/g,", ")+"' for creating a component of class '"+t+"' is not an object")},n.unknownModel=function(e){d().warn("try get the information of an unknown model '"+e+"'")},n.missingSchema=function(e){d().warn("the schema '"+e+"' is missing")},n.cyclicDependency=function(e){e?d().error("a cyclic inheritance dependency with ’"+e+"’ schema has been found, please check the '_inherit' properties of your schemas"):d().error("a cyclic inheritance dependency has been found, please check the '_inherit' properties of your schemas")},n.invalidEnumType=function(e,t,n){void 0!==n&&n!==typeof e?d().warn("invalid type for enumerated type '"+t+"': expected type '"+n+"' instead of type '"+typeof e+"'"):d().warn("invalid type for enumerated type '"+t+"'")},n.loadSchema=function(e){d().debug("load schema '"+e+"'")},n.loadModel=function(e){d().debug("load model '"+e+"'")},n.loadType=function(e){d().debug("load type '"+e+"'")},n.compileSchema=function(e){d().debug("compile schema '"+e+"'...")},n.generateModel=function(e){d().debug("generate model '"+e+"'...")},n.checkModel=function(e){d().debug("analyze model '"+e+"'...")},n.createCollection=function(e){d().debug("create collection '"+e+"'")},n.createClass=function(e){d().debug("create class '"+e+"'")},n.modelCreationBegin=function(){d().debug("starting model creation...")},n.modelCreationEnd=function(){d().debug("model creation ended")},n.actionInvokeError=function(e,t,n,a){"Function"!==n?d().error("error when trying to call the method '"+e+"' on component '"+t+"' (class '"+n+"'): "+a):d().error("error when trying to call the method '"+e+"' on component '"+t+"': "+a)},n.invalidSchemaPropertyName=function(e,t){d().warn("invalid name '"+t+"' for schema '"+e+"': a property name can not begin with '_'")},n.invalidSchemaProperty=function(e,t){d().warn("invalid property '"+t+"' for schema '"+e+"': only 'property', 'link', 'collection', 'method' and 'event' are allowed.")},n.invalidPropertyFormat=function(e){d().warn("invalid format for a definition of a property': '"+e+"' is not an object")},n.invalidState=function(e,t){d().warn("invalid state '"+t+"' for the model '"+e+"'")},n.unknownContext=function(e,t){d().warn("invoke the behavior '"+t+"' on the class '"+e+"' without a valid context")}},{"./component.js":3,"./db.js":4,"./metamodel.js":7}],7:[function(e,t,n){"use strict";var a=e("./db.js"),r=e("./log.js"),o=e("./component.js"),i=(e("./workflow.js"),e("./helper.js")),s="_id",d="_name",c="_description",l="_inherit",m="_class",u="_core",y=["property","collection","link","method","event"],f=["_id","_name","_inherit","_description","_class","_core"],p=["boolean","string","number","object","function","array","date","any"],h={metadef:{},inheritance:{},inheritanceTree:{},schemas:{},compiledSchemas:{},models:{},generatedModels:{},states:{},type:{}};function g(e){var t=!0;return-1===f.indexOf(e)&&(t=!1),t}function v(){var e,t,o="",i="",s="",c={},l="",m=null,u=null,y=null,f={},p={},v=[],b=0,_=0,O=0;for(s in h.compiledSchemas){f={_name:(c=h.compiledSchemas[s])._name},void 0!==c._core&&(f._core=c._core),Array.isArray(c._inherit)&&(f._inherit=c._inherit),void 0!==c._class&&(f._class=c._class),void 0!==c._description&&(f._description=c._description);for(o in c)g(o)||0!==o.indexOf("_")||r.invalidSchemaPropertyName(c._name,o);for(o in c)switch(!0){case"property"===c[o]:f[o]={type:"any",readOnly:!1,mandatory:!1,default:"",description:o,label:o};break;case"link"===c[o]:f[o]={type:"_Component",readOnly:!1,mandatory:!1,default:"",description:o,label:o};break;case"method"===c[o]:f[o]={params:[{name:"param1",type:"any",mandatory:!1,default:null},{name:"param2",type:"any",mandatory:!1,default:null},{name:"param3",type:"any",mandatory:!1,default:null}],result:"any",description:o};break;case"event"===c[o]:f[o]={params:[{name:"param1",type:"any",mandatory:!1,default:null},{name:"param2",type:"any",mandatory:!1,default:null},{name:"param3",type:"any",mandatory:!1,default:null}],description:o};break;case"collection"===c[o]:f[o]={type:["_Component"],readOnly:!1,mandatory:!1,default:[],description:o,label:o};break;default:g(o)||r.invalidSchemaProperty(c._name,o)}h.generatedModels[f._name]=f}for(l in h.generatedModels)i=(f=h.generatedModels[l])[d],(u=h.models[i])&&(p=x(u,f),h.generatedModels[i]=p);for(e=(t=function(){var e=[],t={},n="",a=0;for(n in h.inheritanceTree)a=h.inheritanceTree[n].length,void 0===t[a]&&(t[a]=[]),t[a].push(n);return Object.keys(t).sort().forEach(function(n){t[n].forEach(function(t){e.push(t)})}),e}()).length,_=0;_<e;_++)if(l=t[_],f=h.generatedModels[l]){(v=n.getParents(l)).reverse();JSON.parse(JSON.stringify(f));for(b=v.length,O=0;O<b;O++)i=v[O],(m=h.generatedModels[i])&&(p=x(m,f),h.generatedModels[l]=p);(u=h.models[l])&&(p=x(u,h.generatedModels[l]),h.generatedModels[l]=p)}for(l in h.generatedModels)y=h.generatedModels[l],a._GeneratedModel.insert(y),y._core||r.generateModel(l)}function b(){var e="",t=[];function n(e,t){var n,a=0,r=[];for(n=t.length,a=0;a<n;a++)0===t[a].indexOf(e)&&((r=t[a]).reverse(),r.pop(),r.reverse(),t[a]=r)}function a(e,t){var n,a=!0,r=0;for(n=t.length,r=0;r<n;r++)t[r].indexOf(e)>0&&(a=!1);return a}function o(e){var t,r=0,o=[];for(t=e.length,r=0;r<t;r++)if(a(e[r][0],e)){o.push(e[r][0]),n(e[r][0],e);break}return o}function i(e){var t,n,a,s,d=[],c=0;for(Array.isArray(h.inheritance[e])?d=h.inheritance[e].slice():r.missingSchema(e),t=d.length,c=0;c<t;c++)if(n=e,a=d[c],s=void 0,s=!1,Array.isArray(h.inheritance[a])&&-1!==h.inheritance[a].indexOf(n)&&(r.cyclicDependency(n),s=!0),s){d=[];break}return d.length?[e].concat(function(e){var t=[],n=[];for(n=o(e);void 0!==n[0];)t=t.concat(n),n=o(e);return function(e){var t,n=0,a=!0;for(t=e.length,n=0;n<t;n++)e[n].length&&(a=!1);return a}(e)||r.cyclicDependency(),t}(d.map(i).concat([d]))):[e]}for(e in h.inheritance)(t=i(e).reverse()).pop(),t.length&&(h.inheritanceTree[e]=t)}function _(e){var t={},n=h.schemas[e],a=h.inheritanceTree[e],r=0,o=0,i=null,s="";for(a&&(r=a.length,a.reverse()),o=0;o<r;o++){i=h.schemas[a[o]];for(s in i)0!==s.indexOf("_")&&(t[s]=i[s])}for(s in n)t[s]=n[s];return t}function O(e,t){var n="";for(n in t)n!==s&&n!==d&&n!==c&&n!==l&&n!==m&&n!==u&&(void 0!==e[n]?k(e[n],t[n])||r.invalidTypeImp(n,e[d]):r.missingPropertyImp(n,e[d]));for(n in e)n!==s&&n!==d&&n!==c&&n!==l&&n!==m&&n!==u&&void 0===t[n]&&r.unknownPropertyImp(n,e[d])}function k(e,t){return M(t,"string")&&-1!==p.indexOf(t)?M(e,t):w(e,t)}function w(e,t){var a=!0,r=h.type[t],o=0,i=0;if(M(r,"undefined"))a=!1;else if(M(e,"undefined"))a=!1;else if("array"===r.type)for(o=e.length,i=0;i<o&&!1!==(a=M(r.schema,"undefined")?n.isValidType(e[i],r.type):n.isValidSchema(e[i],r.schema));i++);else a=M(r.schema,"undefined")?n.isValidType(e,r.type):n.isValidSchema(e,r.schema);return a}function S(e){return e.replace("@","").trim()}function j(e){return M(e,"string")&&-1===p.indexOf(e)&&!n.isClassName(e)}function I(e){var t="";return t=Array.isArray(e)?"array":typeof e,"any"===e&&(t="any"),t}function C(e){var t="";return e&&e.constructor&&(t=e.constructor.name),t}function N(e,t){return-1!==t.indexOf(e)}function M(e,t){var n=!0,a=null;switch(t){case"array":n=Array.isArray(e);break;case"date":"string"==typeof e?(a=new Date(e),n=!isNaN(a.getDate())):n=e instanceof Date;break;case"any":n=!0;break;default:n=t===typeof e}return n}function P(e,t,n){var a=!1,r=h.generatedModels[t];return r&&r[d]&&(r=h.compiledSchemas[r[d]]),r&&r[e.split(".")[0]]===n&&(a=!0),a}function x(e,t,n){var a="",r=t;for(a in e)e.hasOwnProperty(a)&&0!==a.indexOf("_")&&(r[a]=e[a]);return r}function R(e,t,n){var r=null,o=[],i="";switch(!0){case"=>"===e:break;case"string"==typeof t&&"boolean"===t:r=n?{name:e,type:"boolean",mandatory:!1,default:!1}:{type:"boolean",readOnly:!1,mandatory:!1,default:!1};break;case"string"==typeof t&&"string"===t:r=n?{name:e,type:"string",mandatory:!1,default:""}:{type:"string",readOnly:!1,mandatory:!1,default:""};break;case"string"==typeof t&&"number"===t:r=n?{name:e,type:"number",mandatory:!1,default:0}:{type:"number",readOnly:!1,mandatory:!1,default:0};break;case"string"==typeof t&&"object"===t:r=n?{name:e,type:"object",mandatory:!1,default:{}}:{type:"object",readOnly:!1,mandatory:!1,default:{}};break;case"string"==typeof t&&"array"===t:r=n?{name:e,type:"array",mandatory:!1,default:[]}:{type:"array",readOnly:!1,mandatory:!1,default:[]};break;case"string"==typeof t&&"date"===t:r=n?{name:e,type:"date",mandatory:!1,default:""}:{type:"date",readOnly:!1,mandatory:!1,default:""};break;case"string"==typeof t&&"any"===t:r=n?{name:e,type:"any",mandatory:!1,default:null}:{type:"any",readOnly:!1,mandatory:!1,default:""};break;case"string"==typeof t:i={},(o=a._Type.find({name:t})).length&&o[0].value&&(i=o[0].value[0]),a._Schema.find({_name:t}).length&&(i=""),r=n?{name:e,type:t,mandatory:!1,default:i}:{type:t,readOnly:!1,mandatory:!1,default:i};break;case"array"==typeof t&&"boolean"==typeof t[0]:r=n?{name:e,type:["boolean"],mandatory:!1,default:[]}:{type:["boolean"],readOnly:!1,mandatory:!1,default:[]};break;case"array"==typeof t&&"string"==typeof t[0]:r=n?{name:e,type:["string"],mandatory:!1,default:""}:{type:["string"],readOnly:!1,mandatory:!1,default:""};break;case"array"==typeof t&&"number"==typeof t[0]:r=n?{name:e,type:["number"],mandatory:!1,default:[]}:{type:["number"],readOnly:!1,mandatory:!1,default:[]};break;case"array"==typeof t&&"object"==typeof t[0]:r=n?{name:e,type:["object"],mandatory:!1,default:[]}:{type:["object"],readOnly:!1,mandatory:!1,default:[]};break;case"array"==typeof t&&"date"==typeof t[0]:r=n?{name:e,type:["date"],mandatory:!1,default:[]}:{type:["date"],readOnly:!1,mandatory:!1,default:[]};break;case"array"==typeof t&&"any"==typeof t[0]:r=n?{name:e,type:["any"],mandatory:!1,default:[]}:{type:["any"],readOnly:!1,mandatory:!1,default:[]};break;case"array"==typeof t:r=n?{name:e,type:t,mandatory:!1,default:[]}:{type:t,readOnly:!1,mandatory:!1,default:[]}}return r}function A(e){var t="",n="",a={};e=JSON.parse(JSON.stringify(e));for(t in e)if(e.hasOwnProperty(t)&&0!==t.indexOf("_"))switch(!0){case"string"==typeof e[t]:e[t]=R(t,e[t],!1);break;case"object"==typeof e[t]&&void 0===e[t]["=>"]:e[t]=x(e[t],R(t,e[t].type||"any",!1));break;case"object"==typeof e[t]&&void 0!==e[t]["=>"]:a={params:[],result:"any"};for(n in e[t])"string"==typeof e[t][n]&&("=>"===n?a.result=e[t][n]:a.params.push(R(n,e[t][n],!0))),"object"==typeof e[t][n]&&a.params.push(x(e[t][n]),R(n,e[t][n].type||"any",!0));e[t]=a}return e}n.schema=function(e,t){var o,c,m,u=null,y="",f={},p=[];return void 0===t||0===Object.keys(t).length?"string"==typeof e?(t={},t[d]=e,y=e):(t=JSON.parse(JSON.stringify(e)),y=t[d]):(t=JSON.parse(JSON.stringify(t)),t[d]=e,y=t[d]),void 0===t[s]&&(t[s]=i.generateId()),void 0===t[l]&&(t[l]=["_Component"]),t[l]=(o=t[l],c=[],m={},o.forEach(function(e){var t=e.trim();void 0===m[t]&&(m[t]=t,c.push(t))}),c),n.isValidObject(t,h.metadef.schema,!1)?(p=a._Schema.find({_name:y})).length?(f=x(t,p[0]),a._Schema.update({_name:y},f),u=p[0]._id):u=a._Schema.insert(t)[0]:r.invalidSchema(t[d]),u},n.model=function(e,t){var o=null,c="",l={},m=[];return void 0===t||0===Object.keys(t).length?(t=JSON.parse(JSON.stringify(e)),c=t[d]):(t=JSON.parse(JSON.stringify(t)),t[d]=e,t=A(t),c=t[d]),void 0===t[s]&&(t[s]=i.generateId()),n.isValidObject(t,h.metadef.model,!1)?(m=a._Model.find({_name:c})).length?(l=x(t,m[0]),a._Model.update({_name:c},l),o=m[0]._id):o=a._Model.insert(t)[0]:r.invalidModel(t[d]),o},n.type=function(e,t){var o=null,i="",s={};return void 0===t||0===Object.keys(t).length?i=(s=JSON.parse(JSON.stringify(e))).name:Array.isArray(t)?(t=JSON.parse(JSON.stringify(t)),s.value=t,s.name=e,s.type=typeof t[0]||"any",i=s.name):(t=JSON.parse(JSON.stringify(t)),s.schema=A(t),s.name=e,s.type="object",i=s.name),n.isValidObject(s,h.metadef.type)?o=a._Type.insert(s)[0]:r.invalidTypeDefinition(i),o},n.init=function(){n.clear(),h.metadef={schema:{_id:{type:"string",mandatory:!0},_name:{type:"string",mandatory:!0},_inherit:{type:["string"],mandatory:!1,default:["_Component"]},_class:{type:"boolean",mandatory:!1},_core:{type:"boolean",mandatory:!1},_description:{type:"string",mandatory:!1}},model:{_id:{type:"string",mandatory:!0},_name:{type:"string",mandatory:!0},_inherit:{type:["string"],mandatory:!1},_class:{type:"boolean",mandatory:!1},_core:{type:"boolean",mandatory:!1},_description:{type:"string",mandatory:!1}},type:{_id:{type:"string",mandatory:!1},name:{type:"string",mandatory:!0},type:{type:"string",mandatory:!0},schema:{type:"object",mandatory:!1},value:{type:["any"],mandatory:!1},core:{type:"boolean",mandatory:!1},description:{type:"string",mandatory:!1}}},a.collection("_Logger"),a.collection("_Schema"),a.collection("_Model"),a.collection("_GeneratedModel"),a.collection("_ClassInfo"),a.collection("_Behavior"),a.collection("_State"),a.collection("_Type"),a.collection("_Message"),a.collection("_Channel"),a.collection("_Log")},n.clear=function(){h={metadef:{},inheritance:{},inheritanceTree:{},schemas:{},compiledSchemas:{},models:{},generatedModels:{},states:{},type:{}}},n.create=function(){r.modelCreationBegin(),function(){var e,t,n,o=null,i={},s=null,c="",m="",u=0,y=0;for(h.inheritance={},h.inheritanceTree={},h.schemas={},h.compiledSchemas={},h.models={},h.generatedModels={},h.states={},h.type={},y=(e=a._Schema.find({})).length,u=0;u<y;u++)c=(o=e[u])[d],m=o[l],h.schemas[c]=o,m&&(h.inheritance[c]=m),o._core||r.loadSchema(c);for(y=(n=a._Model.find({})).length,u=0;u<y;u++)c=(i=n[u])[d],h.models[c]=i,i._core||r.loadModel(c);for(y=(t=a._Type.find({})).length,u=0;u<y;u++)s=t[u],h.type[s.name]=s,s.core||r.loadType(s.name)}(),b(),function(){var e="";for(e in h.schemas)h.schemas[e]._core||r.compileSchema(e),h.compiledSchemas[e]=_(e)}(),v(),function(){var e="",t=null,n="";for(e in h.generatedModels)(t=h.generatedModels[e])&&((n=h.compiledSchemas[e])?(t._core||r.checkModel(e),O(t,n)):r.missingImplementation(e))}(),function(){var e="",t=null,n="",a=[],r="";for(e in h.compiledSchemas){if(a=[],t=h.compiledSchemas[e])for(r in t)n=t[r],0!==r.indexOf("_")&&-1!==y.indexOf(n)&&a.push(r);h.states[e]=a}}(),function(){var e="",t={};for(e in h.generatedModels)t=h.generatedModels[e],void 0===a[t[d]]&&!1!==t[m]&&(a.collection(t[d]),t._core||r.createCollection(t[d]))}(),function(){var e="",t={};for(e in h.generatedModels)!1!==(t=h.generatedModels[e])[m]&&(o.create({model:e}),t._core||r.createClass(e))}(),function(){var e="",t={},r="";for(e in h.generatedModels)r=(t=h.generatedModels[e])[d]+"Info",!1!==t[m]&&n.inheritFrom(t[d],"_Component")&&(o.get(r)?a._ClassInfo.update({_id:r},{_id:r,schema:h.compiledSchemas[e],model:t}):a._ClassInfo.insert({_id:r,schema:h.compiledSchemas[e],model:t}))}(),r.modelCreationEnd()},n.isEvent=function(e,t){return P(e,t,"event")},n.isProperty=function(e,t){return P(e,t,"property")},n.isLink=function(e,t){return P(e,t,"link")},n.isCollection=function(e,t){return P(e,t,"collection")},n.isMethod=function(e,t){return P(e,t,"method")},n.isStructure=function(e,t){var n=!1,a=h.generatedModels[t],r="";return a[e]&&(r=h.type[a[e].type]),r&&r.schema&&(n=!0),n},n.isValidState=function(e,t){var a=!1,r=h.generatedModels[t],o={};return-1!==e.indexOf(".")?a=n.isValidModelPath(t,e):(r&&r[d]&&(r=h.generatedModels[r[d]]),o=h.states[r[d]],Array.isArray(o)&&(a=-1!==o.indexOf(e))),a},n.isValidType=function(e,t){var a,i,s,d,c=!0;function l(e,t){var n=!0,a=S(t),i=e;return""!==e&&null!==e&&(M(e,"string")&&(i=o.get(e)),C(i)!==a&&"{}"!==JSON.stringify(i)&&(n=!1,r.invalidType(e,t.replace("@","")))),n}switch(!0){case j(t):(c=w(e,t))||(h.type[t]?r.invalidEnumType(e,t,h.type[t].type):r.invalidEnumType(e,t)),c&&(a=e,i=t,s=h.type[i],d=!0,Array.isArray(s.value)&&-1===s.value.indexOf(a)&&(d=!1),!1===d&&r.invalidEnumValue(a,i),c=d);break;case n.isClassName(t):c=l(e,t);break;default:c=function(e,t){var a=!0,r=0,o=0;switch(I(t)){case"string":a=M(e,t);break;case"array":for(o=e.length,r=0;r<o;r++)switch(!0){case j(t[0]):a=w(e[r],t[0]);break;case n.isClassName(t[0]):a=l(e[r],t[0]);break;default:a=M(e[r],t[0])}}return a}(e,t)}return c},n.isValidEnum=function(e,t){var a,i,s,d=!0;return n.isClassName(t.type)?(a=o.get(e),i=S(t.type),s="","Function"===(s=a.constructor.name)&&(s=a.name),(d=s===i&&-1!==t.value.indexOf(e))||r.invalidEnumValue(e,t.type)):(d=M(e,t.type)&&-1!==t.value.indexOf(e))||r.invalidEnumValue(e,t.name),d},n.isValidSchema=function e(t,a){var o,i,s,d,c="",l=null,m=!0,u="",y="",f="",p=0,g=0;function v(){var t=!0;switch(f=I(u)){case"string":if(j(f))t=e(l,u);else if(!M(l,u)){r.invalidPropertyType(c,u,l),t=!1;break}break;case"array":for(p=l.length,g=0;g<p;g++)if(j(u[0]))t=e(l[g],h.type[u[0]].schema);else if(!M(l[g],u[0])){r.invalidPropertyType(l[g],u[0],l[g]),t=!1;break}}return t}if(M(t,"object")){for(c in t){if(l=t[c],M(a[c],"undefined"))return r.unknownProperty(c,a),!1;switch(u=a[c].type,!0){case n.isClassName(u):s=void 0,d=void 0,s=!0,d=[],y=C(u),j(y=(y=t[y]).replace("@",""))?h.type[y]?h.type[y].schema?s=e(l,h.type[y].schema):(s=M(l,h.type[y].type),(d=h.type[y].value)&&(s=N(l,d))):s=!1:s="array"===y?Array.isArray(l):n.isClassName(y)?M(l,"object")||M(l,"string"):M(l,y),s||r.invalidPropertyType(c,y,l),m=s;break;case-1!==u.indexOf("{"):o=void 0,i=void 0,o=!0,i=[],y=u.replace("{","").replace("}","").trim(),j(y=(y=t[y]).replace("@",""))?h.type[y]?h.type[y].schema?o=e(l,h.type[y].schema):(o=M(l,h.type[y].type),(i=h.type[y].value)&&(o=N(l,i))):o=!1:o="array"===y?Array.isArray(l):n.isClassName(y)?M(l,"object")||M(l,"string"):M(l,y),o||r.invalidPropertyType(c,y,l),m=o;break;default:m=v()}if(!m)break}for(c in a)if(!0===(l=a[c]).mandatory&&M(t[c],"undefined")&&void 0!==t[c]){r.missingProperty(c),m=!1;break}}else m=!1,r.invalidPropertyFormat(t);return m},n.isValidObject=function e(t,a,i,s){var d="",c=null,l=!0,m=!0,u="",y="",f="",p=0,g=0;function v(t,a){var r,o=!0;if(r=h.type[a])switch(!0){case!M(r.schema,"undefined"):o=e(t,r.schema,i,s);break;case!M(r.value,"undefined"):o=n.isValidEnum(t,r);break;default:o=n.isValidType(t,r.type)}else o=!1;return o}function b(e,a){var i=!0,c=null,l=!1;if(y=S(a),e&&e.id?(c=e,l=!0):c=o.get(e),M(c,"undefined"))switch(!0){case M(e,"object")&&null!==e&&Object.keys(e).length>0:case M(e,"string")&&""!==e:r.canNotYetValidate(e,y)}else n.inheritFrom(c.constructor.name,y)?l&&s&&(t[d]=c.id()):(i=!1,r.invalidType(e,y));return i}function _(t,a){var c=!0,l=null,m="";switch(f=I(a)){case"any":break;case"string":if(j(f))c=e(t,a,i,s);else if("array"===a){if("array"!==I(t)){r.invalidPropertyType(d,a,t),c=!1;break}}else if("date"===a){if(l=new Date(t),!(c=!isNaN(l.getDate()))){r.invalidPropertyType(d,a,t);break}}else if(I(t)!==a&&"any"!==I(t)){r.invalidPropertyType(d,a,t),c=!1;break}break;case"array":if(Array.isArray(t)){for(p=t.length,m=a[0],g=0;g<p;g++)if(j(m))c=v(t[g],m);else if(n.isClassName(m))if("string"===I(t[g]))if(o.get(t[g])){if(!n.inheritFrom(C(o.get(t[g])),S(m))){r.invalidClassName(JSON.stringify(t[g]),S(m),C(o.get(t[g]))),c=!1;break}}else""!==t[g]&&r.canNotYetValidate(t[g],S(m));else{if(!n.inheritFrom(C(t[g]),S(m))){r.invalidClassName(JSON.stringify(t[g]),S(m),C(t[g])),c=!1;break}s&&(t[g]=t[g].id())}else if(I(t[g])!==m&&"any"!==m){r.invalidPropertyType(t[g],m,t[g]),c=!1;break}}else c=!1,r.invalidType(t,"array");break;default:c=!1,r.unknownType(t)}return c}M(i,"undefined")&&(i=!0),M(s,"undefined")&&(s=!1),M(t,"object")||(l=!1,r.invalidType(t,"object"));for(d in t)if(c=t[d],M(a[d],"undefined")&&"_core"!==d&&"_id"!==d){if(i)return r.unknownProperty(d,a),!1}else{switch(!0){case"_core"===d:u="boolean";break;case"_id"===d:u="string";break;default:u=a[d].type}switch(!0){case j(u):l=v(c,u);break;case n.isClassName(u):l=b(c,u);break;default:l=_(c,u)}}for(d in a)m=(c=a[d]).mandatory,t&&M(t[d],"undefined")&&!0===m&&(r.missingProperty(d),l=!1);return l},n.prepareObject=function(e,t){var n="",a=null,r=!0,o="";t=JSON.parse(JSON.stringify(t));for(n in t)r=(a=t[n]).mandatory,o=a.default,M(e[n],"undefined")&&(!1!==r||M(o,"undefined")||(e[n]=o))},n.getSchema=function(e){var t=null;return h.compiledSchemas[e]&&(t=h.compiledSchemas[e]),t},n.getModel=function(e){var t=null;return h.generatedModels[e]&&(t=h.generatedModels[e]),t},n.getType=function(e){var t=null;return h.type[e]&&h.type[e]&&(t=JSON.parse(JSON.stringify(h.type[e]))),t},n.getModelPathType=function(e,t){var a,o,i=null,s="",d=0,c="";for(o=(a=t.split(".")).length,d=0;d<o;d++)s=a[d],0===d?i=n.getModel(e)[s].type:j(i)&&(c=n.getType(i)).schema?i=c.schema[s].type:r.invalidState(e,t);return i},n.isValidModelPath=function(e,t){var a,r,o=!0,i=null,s="",d=0,c="";for(r=(a=t.split(".")).length,d=0;d<r;d++)s=a[d],0===d?i=n.getModel(e)[s].type:j(i)&&(c=n.getType(i)).schema&&c.schema[s]?i=c.schema[s].type:o=!1;return o},n.getMetaDef=function(){return h.metadef.schema},n.getParents=function(e){return h.inheritanceTree[e]?h.inheritanceTree[e].slice():[]},n.inheritFrom=function(e,t){var a=!1,r=[],o=0,i=0;function s(e,t){var a=!1,r=[],o=0;if(0!==(r=n.getParents(e)).length)if(-1!==r.indexOf(t))a=!0;else for(o=0;o<0&&!(a=s(r[o],t));o++);return a}if(e!==t){if(i=(r=n.getParents(e)).length,0!==r.length)if(-1!==r.indexOf(t))a=!0;else for(o=0;o<i&&!(a=s(r[o],t));o++);}else a=!0;return a},n.isClassName=function(e){var t="",n=M(e,"string");return n&&(Object.keys(h.generatedModels).length>0?(t=e.replace("@",""),n=void 0!==h.generatedModels[t]):n=!1),n}},{"./component.js":3,"./db.js":4,"./helper.js":5,"./log.js":6,"./workflow.js":10}],8:[function(e,t,n){"use strict";var a,r=e("./db.js"),o=e("./component.js"),i=e("./metamodel.js"),s=e("../build/system/system.js"),d="",c=null;e("./helper.js").polyfill(),i.init(),a=r.importSystem(s.system),d=o.get(a),c=o.get("channel"),d.state("installed"),c.$systemInstalled(a),d.state("resolved"),c.$systemResolved(a),d.state("starting"),c.$systemStarted(a),d.start(),d.state("active"),t.exports=o.get("runtime")},{"../build/system/system.js":1,"./component.js":3,"./db.js":4,"./helper.js":5,"./metamodel.js":7}],9:[function(e,t,n){"use strict";var a=e("./db.js"),r={};n.set=function(e,t,n){r[e]={state:t,value:n},a.store._State[e]={state:t,value:n}},n.get=function(e){return r[e]},n.clear=function(){r={}}},{"./db.js":4}],10:[function(e,t,n){"use strict";var a=e("./metamodel.js"),r=e("./component.js"),o=e("./behavior.js"),i=e("./state.js"),s=e("./helper.js"),d=e("./log.js"),c=e("./db.js");function l(e){this.message=e,this.name="RuntimeError"}function m(e){return-1!==e.indexOf(".")}function u(e,t){var n=null,r=[],o=[],i=0,s=0,c=0,l=0;if(a.getModel(e)?n=a.getModel(e)[t]:d.unknownModel(e),n){if(r=n.params)for(i=r.length,s=0;s<i;s++)void 0!==r[s].mandatory&&!0!==r[s].mandatory||(c+=1),l+=1;o.push(c),o.push(l)}else d.unknownMethod(e,t);return o}function y(e){var t,n,r,o,i=(e=e||{}).component||null,s=e.methodName||"",c=null,l="",m="",u=null,y=!0;if(c=void 0!==e.methodResult?e.methodResult:void 0,m="Function"===i.constructor.name?i.name:i.constructor.name,t=m,n=s,r=null,o=null,a.getModel(t)?r=a.getModel(t)[n].result:d.unknownModel(t),r&&(o=r),null!==(u=o))switch(!0){case"any"===u:break;case"array"===u:Array.isArray(c)||(y=!1,d.invalidResultType(i.id(),i.constructor.name,s,u,null));break;case a.isClassName(u):c.constructor?(l="Function"===c.constructor.name?c.name:c.constructor.name)!==u.replace("@","")&&(y=!1,d.invalidResultType(i.id(),i.constructor.name,s,u,l)):(y=!1,d.invalidResultType(i.id(),i.constructor.name,s,u,typeof c));break;default:typeof c!==u&&(y=!1,d.invalidResultType(i.id(),i.constructor.name,s,u,typeof c))}return y}function f(e,t,m,u,y){var f=null,p=[],h="",g=0,v=0;h="Function"===e.constructor.name?e.name:e.constructor.name,a.isProperty(t,h)||a.isLink(t,h)||a.isCollection(t,h)||(u=function(e,t,n){var r,o=[],i=[],s=0,c=0;if(r=a.getModel(e)[t]){if(o=r.params)for(s=o.length,c=0;c<s;c++)!1===o[c].mandatory&&void 0===n[c]?i.push(o[c].default):i.push(n[c])}else d.unknownMethod(e,t);return i}(h,t,u));try{for(v=u.length,g=0;g<v;g++)p.push(u[g]);m.useCoreAPI&&(p.push(r),p.push(c),p.push(a),p.push(n),p.push(o),p.push(i),p.push(d),p.push(s)),s.isOnNode()&&p.push(s.getRequire()),y?m.context?setTimeout(m.action.bind.apply(m.action,[m.context].concat(p)),0):setTimeout(m.action.bind.apply(m.action,[e].concat(p)),0):f=m.context?m.action.apply(m.context,p):m.action.apply(e,p)}catch(n){if(n instanceof l)throw n;void 0===new Function?console.error("runtime: can not execute new Function() instruction in the current context."):(e&&e.error&&e.error({message:"error when trying to call the method '"+t+"' on component '"+e.id()+"'",error:n}),s.getRuntime()&&s.getRuntime().error({message:"error when trying to call the method '"+t+"' on component '"+e.id()+"'",error:n}),d.actionInvokeError(t,e.id(),e.constructor.name,n.message))}return f}l.prototype=new Error,l.prototype.constructor=l,n.validParamNumbers=function(e,t,n){var r,o,i,s,d,c="",l="",m=[],y=[],f=!1;switch(r=(c=n.toString()).indexOf("{"),""===(m=(-1!==(l=(l=c.substring(0,r)).replace("=>","")).indexOf("(")?l.split("(")[1].replace(")","").trim():l.trim()).split(","))[0]&&(m=[]),o=m.length,i=a.isProperty(t,e),s=a.isLink(t,e),d=a.isCollection(t,e),!0){case d:y=[2,2];break;case i:y="array"===a.getModelPathType(e,t)?[2,2]:[1,1];break;case s:y=[1,1];break;default:y=u(e,t)}return y[0]<=o&&o<=y[1]&&(f=!0),f},n.checkParams=function(e){var t,n,r,o,i=(e=e||{}).component||null,s=e.methodName||"",c=e.args||"",l=[],y=[],f="",p=c.length,h=0,g=null,v=!0;switch(f="Function"===i.constructor.name?i.name:i.constructor.name,n=a.isProperty(s,f),r=a.isLink(s,f),o=a.isCollection(s,f),t=function(e,t){var n=null,r=[],o=[],i=0,s=0;if(a.getModel(e)?n=a.getModel(e)[t]:d.unknownModel(e),n){if(r=n.params)for(i=r.length,s=0;s<i;s++)o.push(r[s].name)}else m(t)||d.unknownMethod(e,t);return o}(f,s),!0){case o:l=c&&c[1]&&"reset"===c[1]?[[a.getModel(f)[s].type[0]],"string"]:[a.getModel(f)[s].type[0],"string"],y=[2,2];break;case n:l=m(s)?[a.getModelPathType(f,s)]:[a.getModel(f)[s].type],"array"===a.getModelPathType(f,s)?(l=c&&c[1]&&"reset"===c[1]?[["any"],"string"]:["any","string"],y=[2,2]):y=[1,1];break;case r:l=[a.getModel(f)[s].type],y=[1,1];break;default:l=function(e,t){var n=null,r=[],o=[],i=0,s=0;if(a.getModel(e)?n=a.getModel(e)[t]:d.unknownModel(e),n){if(r=n.params)for(i=r.length,s=0;s<i;s++)o.push(r[s].type)}else d.unknownMethod(e,t);return o}(f,s),y=u(f,s)}for(void 0===p&&(p=1),(p<y[0]||y[1]<p)&&(v=!1,d.invalidParamNumber(i.id(),i.constructor.name,s)),h=0;h<p;h++)if(void 0===(g=c[h])){if(!(h<y[0]))continue;v=!1,d.invalidParamNumber(i.id(),i.constructor.name,s)}else a.isValidType(g,l[h])||(v=!1,d.invalidParamType(i.id(),i.constructor.name,s,t[h]));return v},n.action=function(e,t){var n,i,s=!1,d=!1,l=!1,m=!1,u=null,y=null,p="";n=c._Behavior.find({_id:e}),i=o.get(e),1===n.length&&(u=n[0],(y=r.get(u.component))&&(p="Function"===y.constructor.name?y.name:y.constructor.name,s=a.isEvent(u.state,p),d=a.isProperty(u.state,p),l=a.isLink(u.state,p),m=a.isCollection(u.state,p),(s||d||m||l)&&f(y,u.state,{useCoreAPI:u.useCoreAPI,context:u.context,action:i},t,!0)))},n.state=function(e){(e=e||{}).component=e.component||"",e.state=e.state||"",e.data=e.data||[],e.context=e.context||null;var t,s=null,c=[],l=null,m=null,u=0,p=0,h=!1,g=!1,v=!1,b=!1,_=!1;if((t=i.get(e.component))&&"destroy"===t.state&&d.invalidUseOfComponent(e.component),(s=r.get(e.component))&&(h="Function"===s.constructor.name?s.name:s.constructor.name,_=a.isEvent(e.state,h),g=a.isProperty(e.state,h),v=a.isLink(e.state,h),b=a.isCollection(e.state,h),c=function e(t,n,i){var s=o.getActions(t.id(),n),c=[],l=0,m=0,u=null;if(!s.length||i)if("Function"!==t.constructor.name)s=s.concat(e(r.get(t.constructor.name),n,i));else for(l=(c=a.getParents(t.name)).length,m=0;m<l&&((u=r.get(c[m]))?s=s.concat(e(u,n,i)):d.unknownComponent(c[m],t.name),!s.length);m++);return s.length&&s.reverse(),s}(s,e.state,_)),c.length){if(n.checkParams({component:s,methodName:e.state,args:e.data}))if(_||g||v||b){for(p=c.length,u=0;u<p;u++)l=c[u],f(e.context||s,e.state,l,e.data,!0);i.set(s.id(),e.state,e.data)}else l=c[0],m=f(e.context||s,e.state,l,e.data,!1),y({component:s,methodName:e.state,methodResult:m});return m}s&&(_||g||v||b)&&i.set(s.id(),e.state,e.data)},n.stop=function(e){if(void 0===(e=e||{}).error&&(e.error=!1),e.message=e.message||"",n.state=function(){},e.error)throw e.message?new l("runtime has been stopped because "+e.message):new l("runtime has been stopped because of an unknown error");e.message?console.error("runtime: runtime has been stopped because "+e.message):console.error("runtime: runtime has been stopped")}},{"./behavior.js":2,"./component.js":3,"./db.js":4,"./helper.js":5,"./log.js":6,"./metamodel.js":7,"./state.js":9}]},{},[8])(8)});