/*
* System Designer
*
* https://designfirst.io/systemdesigner/
*
* Copyright 2017 Erwan Carriou
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*    http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/

runtime.on("ready",function(){var e=this.system("design"),i=this.require("DialogCopyright");i.on("init",function(e){var i="";$("#designer-dialog-copyright").empty(),i=this.require("dialog-modal-copyright.html"),document.querySelector("#designer-dialog-copyright").insertAdjacentHTML("afterbegin",i.source().replace(/{{title}}/gi,this.title()).replace(/{{message}}/gi,this.message())),document.getElementById("designer-dialog-copyright-modal-ok").addEventListener("click",function(e){this.ok()}.bind(this))}),i.on("show",function(){$("#designer-dialog-copyright-modal").modal("show")}),i.on("hide",function(){$("#designer-dialog-copyright-modal").modal("hide")});var t=this.require("MenuBar");t.on("init",function(e){var i=[],t=[],r=[],n=[],o=this;i=this.require("db").collections().MenuHeader.find({type:this.designer().type()}),this.header(this.require(i[0]._id)),(t=this.require("db").collections().MenuItem.find({type:this.designer().type()})).sort(function(e,i){return e.position>i.position?1:e.position<i.position?-1:0}),t.forEach(function(e){var i=e._id;o.items().push(o.require(i))}),r=this.require("db").collections().MenuAction.find({type:this.designer().type()}),n=this.require("db").collections().MenuSearch.find({type:this.designer().type()}),(r=r.concat(n)).sort(function(e,i){return e.position>i.position?1:e.position<i.position?-1:0}),r.forEach(function(e){var i=e._id;o.actions().push(o.require(i))})}),t.on("render",function(){function e(){var e=0,i=0,t=null;for(e=o.children.length,i=0;i<e;i++)t=o.children[i],$(t).removeClass("active")}var i=0,t=0,r=null,n=document.getElementById("designer-menubar-header"),o=document.getElementById("designer-menubar-items"),s=document.getElementById("designer-menubar-actions"),d=this;n.insertAdjacentHTML("afterbegin",this.header().html().source()),this.items().forEach(function(e){o.insertAdjacentHTML("beforeend","<li>"+e.html().source()+"</>")});var a=function(){e(),$(this).addClass("active")};for(i=o.children.length,t=0;t<i;t++)(r=o.children[t]).addEventListener("click",a),r.addEventListener("click",function(){this.click()}.bind(d.items(t)));this.actions().forEach(function(e){s.insertAdjacentHTML("afterbegin","<li>"+e.html().source()+"</>")}),i>0&&(this.designer().context(this.items(0).name()),r=o.children[0],$(r).addClass("active"))});var r=this.require("ToolBar");r.on("init",function(e){var i=[],t=this;(i=this.require("db").collections().ToolBarItem.find({type:this.designer().type()})).sort(function(e,i){return e.position>i.position?1:e.position<i.position?-1:0}),i.forEach(function(e){var i=e._id;t.items().push(t.require(i))})}),r.on("render",function(){var e=document.getElementById("designer-toolbar-items"),i=0,t=0,r=this;for(this.items().forEach(function(i){e.insertAdjacentHTML("beforeend","<li>"+i.html().source()+"</>")}),t=e.children.length,i=0;i<t;i++)e.children[i].addEventListener("click",function(){this.click()}.bind(r.items(i)))});var n=this.require("Workspace");n.on("init",function(e){new(this.require("Editor"))(this.require("designer").isCordova()?{_id:"editor",type:"codemirror",context:"model",editor:CodeMirror($("#designer-editor")[0],{lineNumbers:!0,styleActiveLine:!0,mode:"application/json",theme:"eclipse",tabSize:2,autoCloseBrackets:!0})}:{_id:"editor",type:"ace",context:"model",editor:ace.edit("designer-editor")})}),n.on("render",function(){this.require("editor").render()}),this.require("Server").on("start",function(){var e="",i=null,t=this.require("editor"),r=this.require("designer"),n="",o=null;this.require("storage").on("changed",function(e){void 0!==e["system-designer-message"]&&$db.RuntimeMessage.insert(e["system-designer-message"].newValue)},!0),new(this.require("RuntimeChannel"))({_id:"channel"}).on("send",function(e){if(0!==e.event.indexOf("$system")){var i=this.require("storage").get("system-designer-config"),t=this.require("designer"),r=[];t.isCordova()&&((r=t.messages()).push(e),t.messages(r)),this.require("storage").set("system-designer-message",e),void 0!==i&&void 0!==i.debugType&&"server"===i.debugType&&i.urlServer&&$.post(i.urlServer+":8888/"+e.event,encodeURIComponent(JSON.stringify(e.data)))}}),e=document.location.href.split("#")[1].split("?")[0],systemId=document.location.href.split("#")[2].split("?")[0],i=this.require("storage").get(systemId),model=i.models[e],r.store().uuid(e),r.store().data(model),n=i.models[e]._name,o=r.getGeneratedModel(n),r.store().extra(o),document.title="model "+model._name+" · system "+i.name,t.initValue(JSON.stringify(model,null,"\t"),2)},!0);var o=this.require("Designer");o.on("init",function(e){var i=null,t=null,r=null,n=null,o=null;this.type(window.location.href.split(".html")[0].split("/")[window.location.href.split(".html")[0].split("/").length-1].split("?")[0]),i=new(this.require("Store")),t=new(this.require("MenuBar"))({designer:this}),r=new(this.require("ToolBar"))({designer:this}),n=new(this.require("Workspace"))({designer:this}),o=new(this.require("Server"))({designer:this}),this.store(i),this.menubar(t),this.toolbar(r),this.workspace(n),this.server(o)}),o.on("render",function(){var e="",i=null,t=null;this.isCordova()&&this.updateCordovaContext(),e=document.location.href.split("#")[2].split("?")[0],i=this.require("storage").get(e),t=new(this.require("System"))(i),this.system(t),this.menubar().render(),this.toolbar().render(),this.workspace().render(),this.server().start(),this.updateRouter()}),o.on("updateRouter",function(){var e=[],i=0,t=0,r="",n="";for(r=decodeURIComponent(document.location.href.split("#")[1]),collection=document.location.href.split("#")[2],t=(e=$("#designer-menubar-items > li > a")).length,i=0;i<t;i++)n=e[i].href,context=n.split("#")[n.split("#").length-1],e[i].href="#"+r+"#"+collection+"#"+context}),o.on("clear",function(){this.refresh()}),o.on("context",function(e){this.workspace().clear(),this.workspace().refresh()}),o.on("save",function(){var e=this.require("editor").getValue(),i=this.require("designer"),t=this.require("message"),r=null,n="",o=null;try{r=JSON.parse(e)}catch(e){return void t.danger("Can not save your model: your model has an invalid structure.")}if(r._name)if(r._id){for(n in r){if(-1!==n.indexOf(" "))return void t.danger("Invalid property name '"+n+"’. <br>Space is not authorized in the name of a property.");if(propVal=r[n],"object"==typeof propVal&&!Array.isArray(propVal)&&0===n.indexOf("_"))return void t.danger("Invalid property name '"+n+"’. <br>A property name can not start with '_'.")}o=i.store().extra();for(n in r)if(0!==n.indexOf("_")&&void 0===o[n])return void t.danger("Invalid property name '"+n+"’. <br>'"+n+"’ must be defined in the schema.");i.store().data()._name===r._name?(i.store().data(r),i.store().uuid()!==i.store().data()._id&&(this.require("channel").$editorUpdateModelId(i.store().uuid(),i.store().data()._id),i.store().uuid(i.store().data()._id)),this.require("channel").$editorUpdateModel(i.store().uuid(),i.store().data()),t.clean(),t.success("Model saved.")):t.danger("You can not modify the name of a model.")}else t.danger("The property '_id' is missing.");else t.danger("The property '_name' is missing.")}),e.on("start",function(){new(this.require("Designer"))({_id:"designer"}).render()}),e.start()});