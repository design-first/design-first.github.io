/*
* System Designer
*
* https://designfirst.io/systemdesigner/
*
* Copyright 2017 Erwan Carriou
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*    http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/

runtime.on("ready",function(){var e=this.system("design"),t=this.require("DialogCopyright");t.on("init",function(e){var t="";$("#designer-dialog-copyright").empty(),t=this.require("dialog-modal-copyright.html"),document.querySelector("#designer-dialog-copyright").insertAdjacentHTML("afterbegin",t.source().replace(/{{title}}/gi,this.title()).replace(/{{message}}/gi,this.message())),document.getElementById("designer-dialog-copyright-modal-ok").addEventListener("click",function(e){this.ok()}.bind(this))}),t.on("show",function(){$("#designer-dialog-copyright-modal").modal("show")}),t.on("hide",function(){$("#designer-dialog-copyright-modal").modal("hide")}),this.require("MenuItem").on("click",function(){this.require("designer").context(this.name())});var i=this.require("MenuBar");i.on("init",function(e){var t=[],i=[],r=[],n=[],s=this,o=null,a=!1;(o=this.require("storage").get("system-designer-config"))&&o.advancedMode&&(a=!0),t=this.require("db").collections().MenuHeader.find({type:this.designer().type()}),this.header(this.require(t[0]._id)),(i=this.require("db").collections().MenuItem.find({type:this.designer().type()})).sort(function(e,t){return e.position>t.position?1:e.position<t.position?-1:0}),i.forEach(function(e){var t=e._id;"json"===e.name?a&&s.items().push(s.require(t)):s.items().push(s.require(t))}),r=this.require("db").collections().MenuAction.find({type:this.designer().type()}),n=this.require("db").collections().MenuSearch.find({type:this.designer().type()}),(r=r.concat(n)).sort(function(e,t){return e.position>t.position?1:e.position<t.position?-1:0}),r.forEach(function(e){var t=e._id;s.actions().push(s.require(t))})}),i.on("render",function(){function e(){var e=0,t=0,i=null;for(e=s.children.length,t=0;t<e;t++)i=s.children[t],$(i).removeClass("active")}var t=0,i=0,r=null,n=document.getElementById("designer-menubar-header"),s=document.getElementById("designer-menubar-items"),o=document.getElementById("designer-menubar-actions"),a=this;n.insertAdjacentHTML("afterbegin",this.header().html().source()),this.items().forEach(function(e){s.insertAdjacentHTML("beforeend","<li>"+e.html().source()+"</>")});var d=function(){e(),$(this).addClass("active")};for(t=s.children.length,i=0;i<t;i++)(r=s.children[i]).addEventListener("click",d),r.addEventListener("click",function(){this.click()}.bind(a.items(i)));this.actions().forEach(function(e){o.insertAdjacentHTML("afterbegin","<li>"+e.html().source()+"</>")}),t>0&&(this.designer().context(this.items(0).name()),r=s.children[0],$(r).addClass("active"))}),this.require("1f1781882618115").on("click",function(){var e=this.require("editor"),t=this.require("designer"),i={},r={};0===e.getValue().indexOf("{")?t.store().data(JSON.parse(e.getValue())):(i=t.store().extra())&&i.context&&((r=t.store().data())[i.context]=e.getValue(),t.store().data(r)),(i={}).context="name",t.store().extra(i),e.setEditor("text",t.store().data().name,1)}),this.require("1f1781882618114").on("click",function(){var e=this.require("editor"),t=this.require("designer"),i={},r={};0===e.getValue().indexOf("{")?t.store().data(JSON.parse(e.getValue())):(i=t.store().extra())&&i.context&&((r=t.store().data())[i.context]=e.getValue(),t.store().data(r)),(i={}).context="description",t.store().extra(i),e.setEditor("text",t.store().data().description,1)}),this.require("1f1781882618116").on("click",function(){var e=this.require("editor"),t=this.require("designer"),i={},r={};0===e.getValue().indexOf("{")?t.store().data(JSON.parse(e.getValue())):(i=t.store().extra())&&i.context&&((r=t.store().data())[i.context]=e.getValue(),t.store().data(r)),(i={}).context="version",t.store().extra(i),e.setEditor("text",t.store().data().version,1)}),this.require("1f1781882618102").on("click",function(){var e=this.require("editor"),t=this.require("designer");e.setEditor("json",JSON.stringify(t.store().data(),null,"\t"),2)});var r=this.require("ToolBar");r.on("init",function(e){var t=[],i=this;(t=this.require("db").collections().ToolBarItem.find({type:this.designer().type()})).sort(function(e,t){return e.position>t.position?1:e.position<t.position?-1:0}),t.forEach(function(e){var t=e._id;i.items().push(i.require(t))})}),r.on("render",function(){var e=document.getElementById("designer-toolbar-items"),t=0,i=0,r=this;for(this.items().forEach(function(t){e.insertAdjacentHTML("beforeend","<li>"+t.html().source()+"</>")}),i=e.children.length,t=0;t<i;t++)e.children[t].addEventListener("click",function(){this.click()}.bind(r.items(t)))});var n=this.require("Workspace");n.on("init",function(e){new(this.require("Editor"))(this.require("designer").isCordova()?{_id:"editor",type:"codemirror",context:"system",editor:CodeMirror($("#designer-editor")[0],{lineNumbers:!0,styleActiveLine:!0,mode:"text/x-textile",theme:"eclipse",tabSize:2,autoCloseBrackets:!0})}:{_id:"editor",type:"ace",context:"system",editor:ace.edit("designer-editor")})}),n.on("render",function(){this.require("editor").render()}),this.require("Server").on("start",function(){var t="",i={},r=this.require("editor"),n=this.require("designer");this.require("storage").on("changed",function(e){void 0!==e["system-designer-message"]&&$db.RuntimeMessage.insert(e["system-designer-message"].newValue)},!0),new(this.require("RuntimeChannel"))({_id:"channel"}).on("send",function(e){if(0!==e.event.indexOf("$system")){var t=this.require("storage").get("system-designer-config"),i=this.require("designer"),r=[];i.isCordova()&&((r=i.messages()).push(e),i.messages(r)),this.require("storage").set("system-designer-message",e),void 0!==t&&void 0!==t.debugType&&"server"===t.debugType&&t.urlServer&&$.post(t.urlServer+":8888/"+e.event,encodeURIComponent(JSON.stringify(e.data)))}}),t=document.location.href.split("#")[1].split("?")[0],e=this.require("storage").get(t),n.store().uuid(t),n.store().data(e),document.title="system "+e.name,i.context="name",n.store().extra(i),r.initValue(n.store().data().name,1)},!0);var s=this.require("Designer");s.on("init",function(e){var t=null,i=null,r=null,n=null,s=null;this.type(window.location.href.split(".html")[0].split("/")[window.location.href.split(".html")[0].split("/").length-1]),t=new(this.require("Store")),i=new(this.require("MenuBar"))({designer:this}),r=new(this.require("ToolBar"))({designer:this}),n=new(this.require("Workspace"))({designer:this}),s=new(this.require("Server"))({designer:this}),this.store(t),this.menubar(i),this.toolbar(r),this.workspace(n),this.server(s)}),s.on("render",function(){this.isCordova()&&this.updateCordovaContext(),this.menubar().render(),this.toolbar().render(),this.workspace().render(),this.server().start(),this.updateRouter(),$(function(){$('[data-toggle="tooltip"]').tooltip({container:"body",delay:{show:1e3,hide:100}})})}),s.on("updateRouter",function(){var e=[],t=0,i=0,r="";for(i=(e=$("#designer-menubar-items > li > a")).length,t=0;t<i;t++)r=e[t].href,context=r.split("#")[r.split("#").length-1].split("?")[0],e[t].href="#"+this.store().uuid()+"#"+context}),s.on("clear",function(){this.refresh()}),s.on("context",function(e){this.workspace().clear(),this.workspace().refresh()}),s.on("save",function(){var e=this.require("editor").getValue(),t=this.require("designer"),i=t.store().data();switch(t.context()){case"name":-1!==(e=e.trim()).indexOf(" ")&&(e=e.replace(/ /gi,"-"),this.require("editor").setValue(e)),i.name=e,document.title="system "+i.name;break;case"description":i.description=e;break;case"version":i.version=e;break;case"json":i=JSON.parse(e),document.title="system "+i.name}t.store().data(i),this.require("channel").$editorUpdateSystem(t.store().uuid(),t.store().data()),this.require("message").clean(),this.require("message").success("System saved.")}),e.on("start",function(){new(this.require("Designer"))({_id:"designer"}).render()}),e.start()});