/*
* System Designer
*
* https://designfirst.io/systemdesigner/
*
* Copyright 2017 Erwan Carriou
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*    http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
"undefined"!=typeof global&&"undefined"==typeof window&&(global.require=require);var messages=[],lastPage="index.html";runtime.on("ready",function(){var a=runtime.system("app-designer-testing");a.on("start",function(){var a=null,b=null,c=null,d="",e="",f="";"undefined"!=typeof cordova&&(f=function(){var a={},b=[];return b=document.location.href.split("?"),b.length>1&&(b=b[1].split("&"),b.forEach(function(b){var c="",d="";c=b.split("=")[0].trim(),d=b.split("=")[1].trim(),a[c]=decodeURIComponent(d)})),a}(),e=null,Object.keys(f).length&&(e=JSON.parse(f.system),this.require("storage").set(e._id,e),lastPage=f.ref),setTimeout(function(){if(!document.getElementById("system-designer-back")){var a=null,b=null,c=null,d=null;a=document.createDocumentFragment(),b=document.createElement("div"),b.setAttribute("id","system-designer-back"),b.setAttribute("style","top:5px;left:10px;position:absolute;"),c=document.createElement("a"),c.setAttribute("href","javascript:systemDesignerBack()"),c.setAttribute("style","text-decoration:none; color:#337AB7;"),d=document.createElement("span"),d.setAttribute("style","font-family: 'Helvetica Neue';"),d.textContent=" < System Designer",c.appendChild(d),b.appendChild(c),a.appendChild(b),document.body.appendChild(a)}},2e3)),"undefined"!=typeof global&&"undefined"!=typeof window&&delete module,d=document.location.href.split("#")[1].split("?")[0].split("/")[0],e=this.require("storage").get(d),delete e.classInfo,c=this.require("db"),a=this.require("RuntimeChannel"),b=new a({_id:"channel",_core:!0}),b.on("send",function(a){this.require("designer");"undefined"!=typeof cordova&&messages.push(a);try{JSON.stringify(a),this.require("storage").set("system-designer-message",a)}catch(a){}},!0,!0),b.on("$designerCreateSchema",function(a,b){this.require("logger").level("warn"),this.require("metamodel").schema(b),this.require("metamodel").create(),this.require("logger").level("debug")},!0,!0),b.on("$editorUpdateSchema",function(a,b){this.require("logger").level("warn"),this.require("metamodel").schema(b),this.require("metamodel").create(),this.require("logger").level("debug")},!0,!0),b.on("$designerDeleteSchema",function(a){this.require("logger").level("warn");var b=$db.RuntimeSchema.find({_id:a}),c="",d="";b.length&&(c=b[0]._name,$db.RuntimeSchema.remove({_id:a}),b=$db.RuntimeModel.find({_name:c}),b.length&&(d=b[0]._id,$db.RuntimeModel.remove({_id:d}),$component.removeFromMemory(c)),b=$db.RuntimeGeneratedModel.find({_name:c}),b.length&&(d=b[0]._id,$db.RuntimeGeneratedModel.remove({_id:d}),$component.removeFromMemory(c)),this.require("metamodel").create()),this.require("logger").level("debug")},!0,!0),b.on("$designerCreateModel",function(a,b){this.require("logger").level("warn"),this.require("metamodel").model(b),this.require("metamodel").create(),this.require("logger").level("debug")},!0,!0),b.on("$editorUpdateModel",function(a,b){this.require("logger").level("warn"),this.require("metamodel").model(b),this.require("metamodel").create(),this.require("logger").level("debug")},!0,!0),b.on("$designerUpdateModel",function(a,b){this.require("logger").level("warn"),this.require("metamodel").model(b),this.require("metamodel").create(),this.require("logger").level("debug")},!0,!0),b.on("$designerDeleteModel",function(a){this.require("logger").level("warn");var b=$db.RuntimeModel.find({_id:a}),c="",d="";b.length&&(c=b[0]._name,$db.RuntimeModel.remove({_id:a}),$component.removeFromMemory(c)),b=$db.RuntimeGeneratedModel.find({_name:c}),b.length&&(d=b[0]._id,$db.RuntimeGeneratedModel.remove({_id:d}),$component.removeFromMemory(c)),this.require("metamodel").create(),this.require("logger").level("debug")},!0,!0),b.on("$designerCreateType",function(a,b){this.require("logger").level("warn"),this.require("metamodel").type(b),this.require("metamodel").create(),this.require("logger").level("debug")},!0,!0),b.on("$editorUpdateType",function(a,b){this.require("logger").level("warn"),this.require("metamodel").type(b),this.require("metamodel").create(),this.require("logger").level("debug")},!0,!0),b.on("$editorDeleteType",function(a){this.require("logger").level("warn"),$db.RuntimeType.remove({name:a}),this.require("metamodel").create(),this.require("logger").level("debug")},!0,!0),b.on("$designerDeleteType",function(a){this.require("logger").level("warn"),$db.RuntimeType.remove({name:a}),this.require("metamodel").create(),this.require("logger").level("debug")},!0,!0),b.on("$designerCreateComponent",function(a,b){$db[a].insert(b)},!0,!0),b.on("$editorUpdateComponent",function(a,b,c){$db[b].update({_id:a},c,{upsert:!0})},!0,!0),b.on("$designerUpdateComponent",function(a,b,c){$db[b].update({_id:a},c,{upsert:!0})},!0,!0),b.on("$editorDeleteComponent",function(a,b){$db[b].remove({_id:a})},!0,!0),b.on("$designerDeleteComponent",function(a,b){$db[b].remove({_id:a})},!0,!0),b.on("$designerCreateBehavior",function(a){$db.RuntimeBehavior.insert(a)},!0,!0),b.on("$editorUpdateBehavior",function(a,b){this.require(a)&&(this.require(a).action(b.action),"main"===b.state&&this.require(b.component).main(),"start"===b.state&&this.require(b.component).start())},!0,!0),b.on("$designerUpdateBehavior",function(a,b){this.require(a)&&(this.require(a).action(b.action),"main"===b.state&&this.require(b.component).main(),"start"===b.state&&this.require(b.component).start())},!0,!0),b.on("$editorDeleteBehavior",function(a){$db.RuntimeBehavior.remove({_id:a})},!0,!0),b.on("$designerDeleteBehavior",function(a){$db.RuntimeBehavior.remove({_id:a})},!0,!0),b.on("$designerSync",function(){this.$appLoadSystem(JSON.parse(this.require("db").system()))},!0,!0),this.require("storage").on("changed",function(a){void 0!==a["system-designer-message"]&&$db.RuntimeMessage.insert(a["system-designer-message"].newValue)},!0,!0),this.require("logger").on("warn",function(a){if("info"===this.level()||"warn"===this.level()||"debug"===this.level()){var b=new Date,c=b.toTimeString(),d=b.getMilliseconds();c=c.split(" ")[0].trim(),c=c.replace(":","h"),c=c.replace(":","m"),c=c.split("m")[0].trim(),c=c+":"+d,this.require("channel").$appLogWarn("["+c+"] "+a)}},!0,!0),this.require("logger").on("error",function(a){var b=new Date,c=b.toTimeString(),d=b.getMilliseconds();c=c.split(" ")[0].trim(),c=c.replace(":","h"),c=c.replace(":","m"),c=c.split("m")[0].trim(),c=c+":"+d,this.require("channel").$appLogError("["+c+"] "+a)},!0,!0),this.require("logger").info("loading the system...");var g=this.require("db").system(e);this.require("logger").info("the system is loaded"),document.title=e.name,this.require("logger").on("debug",function(a){if("debug"===this.level()){var b=new Date,c=b.toTimeString(),d=b.getMilliseconds();c=c.split(" ")[0].trim(),c=c.replace(":","h"),c=c.replace(":","m"),c=c.split("m")[0].trim(),c=c+":"+d,this.require("channel").$appLogDebug("["+c+"] "+a)}},!0,!0),this.require("logger").on("info",function(a){if("info"===this.level()||"debug"===this.level()){var b=new Date,c=b.toTimeString(),d=b.getMilliseconds();c=c.split(" ")[0].trim(),c=c.replace(":","h"),c=c.replace(":","m"),c=c.split("m")[0].trim(),c=c+":"+d,this.require("channel").$appLogInfo("["+c+"] "+a)}},!0,!0),c.on("insert",function(a){0!==a.collection.indexOf("Runtime")&&this.require("channel").$runtimeCreateComponent(a.collection,a.document)}),c.on("remove",function(a){0!==a.collection.indexOf("Runtime")&&this.require("channel").$runtimeDeleteComponent(a.id,a.collection)}),c.on("update",function(a){0!==a.collection.indexOf("Runtime")&&this.require("channel").$runtimeUpdateComponent(a.id,a.collection,a.field,a.value)}),this.require("logger").level("debug"),this.require(g).main&&this.require(g).main(),this.require(g).start&&this.require(g).start()},!0,!0),a.start()},!0,!0);