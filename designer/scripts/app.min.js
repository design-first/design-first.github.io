/*
* System Designer
*
* https://designfirst.io/systemdesigner/
*
* Copyright 2017 Erwan Carriou
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*    http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/

"undefined"!=typeof global&&"undefined"==typeof window&&(global.require=require);var messages=[],lastPage="index.html";runtime.on("ready",function(){var e=runtime.system("app-designer-testing");e.on("start",function(){var e=null,t=null,i="",r="",n="";"undefined"!=typeof cordova&&(n=function(){var e={},t=[];return(t=document.location.href.split("?")).length>1&&(t=t[1].split("&")).forEach(function(t){var i="",r="";i=t.split("=")[0].trim(),r=t.split("=")[1].trim(),e[i]=decodeURIComponent(r)}),e}(),r=null,Object.keys(n).length&&(r=JSON.parse(n.system),this.require("storage").set(r._id,r),lastPage=n.ref),setTimeout(function(){if(!document.getElementById("system-designer-back")){var e=null,t=null,i=null,r=null;e=document.createDocumentFragment(),(t=document.createElement("div")).setAttribute("id","system-designer-back"),t.setAttribute("style","top:5px;left:10px;position:absolute;font-size:18px;font-family:Helvetica,Arial,sans-serif;z-index:999999;background-color:white;"),(i=document.createElement("a")).setAttribute("href","javascript:systemDesignerBack()"),i.setAttribute("style","text-decoration:none; color:#337AB7;"),(r=document.createElement("span")).setAttribute("style","font-family: 'Helvetica Neue';"),r.textContent=" < System Designer",i.appendChild(r),t.appendChild(i),e.appendChild(t),document.body.appendChild(e)}},1e3)),"undefined"!=typeof global&&"undefined"!=typeof window&&delete module,i=document.location.href.split("#")[1].split("?")[0].split("/")[0],delete(r=this.require("storage").get(i)).classInfo,t=this.require("db"),(e=new(this.require("RuntimeChannel"))({_id:"channel",_core:!0})).on("send",function(e){this.require("designer");"undefined"!=typeof cordova&&messages.push(e);try{JSON.stringify(e),this.require("storage").set("system-designer-message",e)}catch(e){}},!0,!0),e.on("$designerCreateSchema",function(e,t){this.require("logger").level("warn"),this.require("metamodel").schema(t),this.require("metamodel").create(),this.require("logger").level("debug")},!0,!0),e.on("$editorUpdateSchema",function(e,t){this.require("logger").level("warn"),this.require("metamodel").schema(t),this.require("metamodel").create(),this.require("logger").level("debug")},!0,!0),e.on("$designerDeleteSchema",function(e){this.require("logger").level("warn");var t=$db.RuntimeSchema.find({_id:e}),i="",r="";t.length&&(i=t[0]._name,$db.RuntimeSchema.remove({_id:e}),(t=$db.RuntimeModel.find({_name:i})).length&&(r=t[0]._id,$db.RuntimeModel.remove({_id:r}),$component.removeFromMemory(i)),(t=$db.RuntimeGeneratedModel.find({_name:i})).length&&(r=t[0]._id,$db.RuntimeGeneratedModel.remove({_id:r}),$component.removeFromMemory(i)),this.require("metamodel").create()),this.require("logger").level("debug")},!0,!0),e.on("$designerCreateModel",function(e,t){this.require("logger").level("warn"),this.require("metamodel").model(t),this.require("metamodel").create(),this.require("logger").level("debug")},!0,!0),e.on("$editorUpdateModel",function(e,t){this.require("logger").level("warn"),this.require("metamodel").model(t),this.require("metamodel").create(),this.require("logger").level("debug")},!0,!0),e.on("$designerUpdateModel",function(e,t){this.require("logger").level("warn"),this.require("metamodel").model(t),this.require("metamodel").create(),this.require("logger").level("debug")},!0,!0),e.on("$designerDeleteModel",function(e){this.require("logger").level("warn");var t=$db.RuntimeModel.find({_id:e}),i="",r="";t.length&&(i=t[0]._name,$db.RuntimeModel.remove({_id:e}),$component.removeFromMemory(i)),(t=$db.RuntimeGeneratedModel.find({_name:i})).length&&(r=t[0]._id,$db.RuntimeGeneratedModel.remove({_id:r}),$component.removeFromMemory(i)),this.require("metamodel").create(),this.require("logger").level("debug")},!0,!0),e.on("$designerCreateType",function(e,t){this.require("logger").level("warn"),this.require("metamodel").type(t),this.require("metamodel").create(),this.require("logger").level("debug")},!0,!0),e.on("$editorUpdateType",function(e,t){this.require("logger").level("warn"),this.require("metamodel").type(t),this.require("metamodel").create(),this.require("logger").level("debug")},!0,!0),e.on("$editorDeleteType",function(e){this.require("logger").level("warn"),$db.RuntimeType.remove({name:e}),this.require("metamodel").create(),this.require("logger").level("debug")},!0,!0),e.on("$designerDeleteType",function(e){this.require("logger").level("warn"),$db.RuntimeType.remove({name:e}),this.require("metamodel").create(),this.require("logger").level("debug")},!0,!0),e.on("$designerCreateComponent",function(e,t){$db[e].insert(t)},!0,!0),e.on("$editorUpdateComponent",function(e,t,i){$db[t].update({_id:e},i,{upsert:!0})},!0,!0),e.on("$designerUpdateComponent",function(e,t,i){$db[t].update({_id:e},i,{upsert:!0})},!0,!0),e.on("$editorDeleteComponent",function(e,t){$db[t].remove({_id:e})},!0,!0),e.on("$designerDeleteComponent",function(e,t){$db[t].remove({_id:e})},!0,!0),e.on("$designerCreateBehavior",function(e){$db.RuntimeBehavior.insert(e)},!0,!0),e.on("$editorUpdateBehavior",function(e,t){this.require(e)&&(this.require(e).action(t.action),"main"===t.state&&this.require(t.component).main(),"start"===t.state&&this.require(t.component).start())},!0,!0),e.on("$designerUpdateBehavior",function(e,t){this.require(e)&&(this.require(e).action(t.action),"main"===t.state&&this.require(t.component).main(),"start"===t.state&&this.require(t.component).start())},!0,!0),e.on("$editorDeleteBehavior",function(e){$db.RuntimeBehavior.remove({_id:e})},!0,!0),e.on("$designerDeleteBehavior",function(e){$db.RuntimeBehavior.remove({_id:e})},!0,!0),e.on("$designerSync",function(){this.$appLoadSystem(JSON.parse(this.require("db").system()))},!0,!0),this.require("storage").on("changed",function(e){void 0!==e["system-designer-message"]&&$db.RuntimeMessage.insert(e["system-designer-message"].newValue)},!0,!0),this.require("logger").on("warn",function(e){if("info"===this.level()||"warn"===this.level()||"debug"===this.level()){var t=new Date,i=t.toTimeString(),r=t.getMilliseconds();i=(i=(i=(i=(i=i.split(" ")[0].trim()).replace(":","h")).replace(":","m")).split("m")[0].trim())+":"+r,this.require("channel").$appLogWarn("["+i+"] "+e)}},!0,!0),this.require("logger").on("error",function(e){var t=new Date,i=t.toTimeString(),r=t.getMilliseconds();i=(i=(i=(i=(i=i.split(" ")[0].trim()).replace(":","h")).replace(":","m")).split("m")[0].trim())+":"+r,this.require("channel").$appLogError("["+i+"] "+e)},!0,!0),this.require("logger").info("loading the system...");var o=this.require("db").system(r);this.require("logger").info("the system is loaded"),document.title=r.name,this.require("logger").on("debug",function(e){if("debug"===this.level()){var t=new Date,i=t.toTimeString(),r=t.getMilliseconds();i=(i=(i=(i=(i=i.split(" ")[0].trim()).replace(":","h")).replace(":","m")).split("m")[0].trim())+":"+r,this.require("channel").$appLogDebug("["+i+"] "+e)}},!0,!0),this.require("logger").on("info",function(e){if("info"===this.level()||"debug"===this.level()){var t=new Date,i=t.toTimeString(),r=t.getMilliseconds();i=(i=(i=(i=(i=i.split(" ")[0].trim()).replace(":","h")).replace(":","m")).split("m")[0].trim())+":"+r,this.require("channel").$appLogInfo("["+i+"] "+e)}},!0,!0),t.on("insert",function(e){0!==e.collection.indexOf("Runtime")&&this.require("channel").$runtimeCreateComponent(e.collection,e.document)},!1,!0),t.on("remove",function(e){0!==e.collection.indexOf("Runtime")&&this.require("channel").$runtimeDeleteComponent(e.id,e.collection)},!1,!0),t.on("update",function(e){0!==e.collection.indexOf("Runtime")&&this.require("channel").$runtimeUpdateComponent(e.id,e.collection,e.field,e.value)},!1,!0),this.require("logger").level("debug"),this.require(o).main&&this.require(o).main(),this.require(o).start&&this.require(o).start()},!0,!0),e.start()},!0,!0);