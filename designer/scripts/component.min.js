/*
* System Designer
*
* https://system-designer.github.io
*
* Copyright 2016 Erwan Carriou
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*    http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
runtime.on("ready",function(){var a=this.system("design"),b=this.require("DialogCopyright");b.on("init",function(a){var b="",c=null;$("#designer-dialog-copyright").empty(),b=this.require("dialog-modal-copyright.html"),document.querySelector("#designer-dialog-copyright").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title()).replace(/{{message}}/gi,this.message())),c=document.getElementById("designer-dialog-copyright-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this))}),b.on("show",function(){$("#designer-dialog-copyright-modal").modal("show")}),b.on("hide",function(){$("#designer-dialog-copyright-modal").modal("hide")});var c=this.require("MenuBar");c.on("init",function(a){var b=[],c=[],d=[],e=[],f=this;b=this.require("db").collections().MenuHeader.find({type:this.designer().type()}),this.header(this.require(b[0]._id)),c=this.require("db").collections().MenuItem.find({type:this.designer().type()}),c.sort(function(a,b){return a.position>b.position?1:a.position<b.position?-1:0}),c.forEach(function(a){var b=a._id;f.items().push(f.require(b))}),d=this.require("db").collections().MenuAction.find({type:this.designer().type()}),e=this.require("db").collections().MenuSearch.find({type:this.designer().type()}),d=d.concat(e),d.sort(function(a,b){return a.position>b.position?1:a.position<b.position?-1:0}),d.forEach(function(a){var b=a._id;f.actions().push(f.require(b))})}),c.on("render",function(){function a(){var a=0,b=0,c=null;for(a=f.children.length,b=0;b<a;b++)c=f.children[b],$(c).removeClass("active")}var b=0,c=0,d=null,e=document.getElementById("designer-menubar-header"),f=document.getElementById("designer-menubar-items"),g=document.getElementById("designer-menubar-actions"),h=this;e.insertAdjacentHTML("afterbegin",this.header().html().source()),this.items().forEach(function(a){f.insertAdjacentHTML("beforeend","<li>"+a.html().source()+"</>")});var i=function(){a(),$(this).addClass("active")};for(b=f.children.length,c=0;c<b;c++)d=f.children[c],d.addEventListener("click",i),d.addEventListener("click",function(){this.click()}.bind(h.items(c)));this.actions().forEach(function(a){g.insertAdjacentHTML("afterbegin","<li>"+a.html().source()+"</>")}),b>0&&(this.designer().context(this.items(0).name()),d=f.children[0],$(d).addClass("active"))});var d=this.require("MenuItem");d.on("click",function(){var a=this.require("designer"),b=this.require("editor"),c=null,d="",e="",f="";a.oldContext(a.context()),a.context(this.name()),c=a.store().extra(),d=a.oldContext(),e=a.context(),f=b.getValue(),d&&("runtimeComponent"!==d?"json"===c[d]?a.store().data()[d]=JSON.parse(b.getValue()):a.store().data()[d]=b.getValue():a.store().data(JSON.parse(b.getValue()))),component=a.store().data(),"runtimeComponent"!==e?"json"===c[e]?b.setEditor(c[e],JSON.stringify(component[e],null,"\t"),2):b.setEditor(c[e],component[e],1,!0):b.setEditor("json",JSON.stringify(a.store().data(),null,"\t"),2)});var e=this.require("ToolBar");e.on("init",function(a){var b=[],c=this;b=this.require("db").collections().ToolBarItem.find({type:this.designer().type()}),b.sort(function(a,b){return a.position>b.position?1:a.position<b.position?-1:0}),b.forEach(function(a){var b=a._id;c.items().push(c.require(b))})}),e.on("render",function(){var a=document.getElementById("designer-toolbar-items"),b=0,c=0,d=null,e=this;for(this.items().forEach(function(b){a.insertAdjacentHTML("beforeend","<li>"+b.html().source()+"</>")}),c=a.children.length,b=0;b<c;b++)d=a.children[b],d.addEventListener("click",function(){this.click()}.bind(e.items(b)))});var f=this.require("Workspace");f.on("init",function(a){var b=null,c=null,d=null;b=this.require("Editor"),c=this.require("designer"),d=new b(c.isCordova()?{_id:"editor",type:"codemirror",context:"component",editor:CodeMirror($("#designer-editor")[0],{lineNumbers:!0,styleActiveLine:!0,mode:"application/json",theme:"eclipse",tabSize:2,autoCloseBrackets:!0})}:{_id:"editor",type:"ace",context:"component",editor:ace.edit("designer-editor")})}),f.on("render",function(){this.require("editor").render()});var g=this.require("Server");g.on("start",function(){function a(a){var b="",c=0,d=[];if(Object.keys(a)){for(b in a)h.require("db").collections().HTML.insert({_id:"menu-item-property-"+b+".html",source:'<a id="designer-menu-item-property-'+b+'" href="#'+b+'">'+b+"</a>"}),d=h.require("db").collections().MenuItem.insert({name:b,html:"menu-item-property-"+b+".html",position:c+10,type:"component"}),h.require("designer").menubar().items().push(h.require(d[0]));h.require("designer").menubar().items().sort(function(a,b){var c=runtime.require(a),d=runtime.require(b);return c.position()>d.position()?1:c.position()<d.position()?-1:0});h.require("designer").menubar().render()}}var b=null,c=null,d="",e="",f=null,g="",h=this,i=this.require("designer"),j={},k="",l="",m=null;this.require("storage").on("changed",function(a){"undefined"!=typeof a["system-designer-message"]&&$db.RuntimeMessage.insert(a["system-designer-message"].newValue)},!0),b=this.require("RuntimeChannel"),c=new b({_id:"channel"}),c.on("send",function(a){if(0!==a.event.indexOf("$system")){var b=this.require("storage"),c=b.get("system-designer-config"),d=this.require("designer"),e=[];b.set("system-designer-message",a),d.isCordova()&&(e=d.messages(),e.push(a),d.messages(e)),"undefined"!=typeof c.debugType&&"server"===c.debugType&&c.urlServer&&$.post(c.urlServer+":8888/"+a.event,encodeURIComponent(JSON.stringify(a.data)))}}),d=decodeURIComponent(document.location.href.split("#")[1].split("?")[0]),g=document.location.href.split("#")[2].split("?")[0],systemId=document.location.href.split("#")[3].split("?")[0],e=this.require("storage").get(systemId),component=e.components[g][d],model=i.getGeneratedModel(g),i.store().uuid(d),i.store().collection(g),i.store().data(component);for(k in component)if(model[k]&&model[k].type)switch(!0){case"html"===model[k].type:j[k]="html";break;case"javascript"===model[k].type:j[k]="javascript";break;case"css"===model[k].type:j[k]="css";break;case"json"===model[k].type:j[k]="json";break;case"object"===model[k].type:j[k]="json";break;case"text"===model[k].type:j[k]="text";break;default:f=e.types,!f||"undefined"==typeof f[model[k].type]||"object"!==f[model[k].type].type&&"json"!==f[model[k].type].type||(j[k]="json")}i.store().extra(j),a(j),document.title="component "+d+" · system "+e.name,m=this.require("editor"),0===Object.keys(j).length?m.setEditor("json",JSON.stringify(component,null,"\t"),2):(l=Object.keys(j)[0],"json"===j[l]?m.setEditor(j[l],JSON.stringify(component[l],null,"\t"),2):m.setEditor(j[l],component[l],1,!0))},!0);var h=this.require("Designer");h.on("init",function(a){var b=null,c=null,d=null,e=null,f=null,g=null,h=null,i=null,j=null,k=null;this.type(window.location.href.split(".html")[0].split("/")[window.location.href.split(".html")[0].split("/").length-1]),b=this.require("Store"),c=new b,d=this.require("MenuBar"),e=new d({designer:this}),f=this.require("ToolBar"),g=new f({designer:this}),h=this.require("Workspace"),i=new h({designer:this}),j=this.require("Server"),k=new j({designer:this}),this.store(c),this.menubar(e),this.toolbar(g),this.workspace(i),this.server(k)}),h.on("render",function(){var a="",b=null,c=null,d=null;this.isCordova()&&this.updateCordovaContext(),a=document.location.href.split("#")[3].split("?")[0],c=this.require("storage").get(a),b=this.require("System"),d=new b(c),this.system(d),this.toolbar().render(),this.workspace().render(),this.server().start(),this.updateRouter(),$(function(){$('[data-toggle="tooltip"]').tooltip({container:"body",delay:{show:1e3,hide:100}})})}),h.on("updateRouter",function(){var a=[],b=0,c=0,d="",e="",f="";for(d=decodeURIComponent(document.location.href.split("#")[1]),collection=document.location.href.split("#")[2],e=document.location.href.split("#")[3].split("?")[0],a=$("#designer-menubar-items > li > a"),c=a.length,b=0;b<c;b++)f=a[b].href,context=f.split("#")[f.split("#").length-1],a[b].href="#"+d+"#"+collection+"#"+e+"#"+context}),h.on("clear",function(){this.refresh()}),h.on("context",function(a){this.workspace().clear(),this.workspace().refresh()}),h.on("save",function(){var a=this.require("editor").getValue(),b=this.require("designer"),c=this.require("message"),d=b.store().data(),e=b.store().extra();if("runtimeComponent"===b.context()){try{d=JSON.parse(a)}catch(a){return void c.danger("Can not save your component: your component has an invalid structure.")}if(!d._id)return void c.danger("The property '_id' is missing.");if(d._id&&d._id.indexOf(" ")!==-1)return void c.danger("Invalid '_id'. <br>Space is not authorized in the value of '_id'.")}else"json"===e[b.context()]?d[b.context()]=JSON.parse(a):d[b.context()]=a;b.store().data(d),b.store().uuid()!==b.store().data()._id&&(this.require("channel").$editorDeleteComponent(b.store().uuid(),b.store().collection()),b.store().uuid(b.store().data()._id),document.title="component "+b.store().uuid()+" · "+document.title.split("·")[1].trim()),this.require("channel").$editorUpdateComponent(b.store().uuid(),b.store().collection(),b.store().data()),this.require("message").success("Component saved.")}),a.on("start",function(){var a=null,b=null;a=this.require("Designer"),b=new a({_id:"designer"}),b.render()}),a.start()});