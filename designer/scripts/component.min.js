/*
* System Designer
*
* https://designfirst.io/systemdesigner/
*
* Copyright 2017 Erwan Carriou
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*    http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/

runtime.on("ready",function(){var e=this.system("design"),t=this.require("DialogCopyright");t.on("init",function(e){var t="";$("#designer-dialog-copyright").empty(),t=this.require("dialog-modal-copyright.html"),document.querySelector("#designer-dialog-copyright").insertAdjacentHTML("afterbegin",t.source().replace(/{{title}}/gi,this.title()).replace(/{{message}}/gi,this.message())),document.getElementById("designer-dialog-copyright-modal-ok").addEventListener("click",function(e){this.ok()}.bind(this))}),t.on("show",function(){$("#designer-dialog-copyright-modal").modal("show")}),t.on("hide",function(){$("#designer-dialog-copyright-modal").modal("hide")});var i=this.require("MenuBar");i.on("init",function(e){var t=[],i=[],n=[],r=[],o=this;t=this.require("db").collections().MenuHeader.find({type:this.designer().type()}),this.header(this.require(t[0]._id)),(i=this.require("db").collections().MenuItem.find({type:this.designer().type()})).sort(function(e,t){return e.position>t.position?1:e.position<t.position?-1:0}),i.forEach(function(e){var t=e._id;o.items().push(o.require(t))}),n=this.require("db").collections().MenuAction.find({type:this.designer().type()}),r=this.require("db").collections().MenuSearch.find({type:this.designer().type()}),(n=n.concat(r)).sort(function(e,t){return e.position>t.position?1:e.position<t.position?-1:0}),n.forEach(function(e){var t=e._id;o.actions().push(o.require(t))})}),i.on("render",function(){function e(){var e=0,t=0,i=null;for(e=o.children.length,t=0;t<e;t++)i=o.children[t],$(i).removeClass("active")}var t=0,i=0,n=null,r=document.getElementById("designer-menubar-header"),o=document.getElementById("designer-menubar-items"),s=document.getElementById("designer-menubar-actions"),d=this;r.insertAdjacentHTML("afterbegin",this.header().html().source()),this.items().forEach(function(e){o.insertAdjacentHTML("beforeend","<li>"+e.html().source()+"</>")});var a=function(){e(),$(this).addClass("active")};for(t=o.children.length,i=0;i<t;i++)(n=o.children[i]).addEventListener("click",a),n.addEventListener("click",function(){this.click()}.bind(d.items(i)));this.actions().forEach(function(e){s.insertAdjacentHTML("afterbegin","<li>"+e.html().source()+"</>")}),t>0&&(this.designer().context(this.items(0).name()),n=o.children[0],$(n).addClass("active"))}),this.require("MenuItem").on("click",function(){var e=this.require("designer"),t=this.require("editor"),i=null,n="",r="";e.oldContext(e.context()),e.context(this.name()),i=e.store().extra(),n=e.oldContext(),r=e.context(),t.getValue(),n&&("runtimeComponent"!==n?"json"===i[n]?e.store().data()[n]=JSON.parse(t.getValue()):e.store().data()[n]=t.getValue():e.store().data(JSON.parse(t.getValue()))),component=e.store().data(),"runtimeComponent"!==r?"json"===i[r]?t.setEditor(i[r],JSON.stringify(component[r],null,"\t"),2):t.setEditor(i[r],component[r],1,!0):t.setEditor("json",JSON.stringify(e.store().data(),null,"\t"),2)});var n=this.require("ToolBar");n.on("init",function(e){var t=[],i=this;(t=this.require("db").collections().ToolBarItem.find({type:this.designer().type()})).sort(function(e,t){return e.position>t.position?1:e.position<t.position?-1:0}),t.forEach(function(e){var t=e._id;i.items().push(i.require(t))})}),n.on("render",function(){var e=document.getElementById("designer-toolbar-items"),t=0,i=0,n=this;for(this.items().forEach(function(t){e.insertAdjacentHTML("beforeend","<li>"+t.html().source()+"</>")}),i=e.children.length,t=0;t<i;t++)e.children[t].addEventListener("click",function(){this.click()}.bind(n.items(t)))});var r=this.require("Workspace");r.on("init",function(e){new(this.require("Editor"))(this.require("designer").isCordova()?{_id:"editor",type:"codemirror",context:"component",editor:CodeMirror($("#designer-editor")[0],{lineNumbers:!0,styleActiveLine:!0,mode:"application/json",theme:"eclipse",tabSize:2,autoCloseBrackets:!0})}:{_id:"editor",type:"ace",context:"component",editor:ace.edit("designer-editor")})}),r.on("render",function(){this.require("editor").render()}),this.require("Server").on("start",function(){var e="",t="",i=null,n="",r=this,o=this.require("designer"),s={},d="",a="",c=null;this.require("storage").on("changed",function(e){void 0!==e["system-designer-message"]&&$db.RuntimeMessage.insert(e["system-designer-message"].newValue)},!0),new(this.require("RuntimeChannel"))({_id:"channel"}).on("send",function(e){if(0!==e.event.indexOf("$system")){var t=this.require("storage"),i=t.get("system-designer-config"),n=this.require("designer"),r=[];t.set("system-designer-message",e),n.isCordova()&&((r=n.messages()).push(e),n.messages(r)),void 0!==i.debugType&&"server"===i.debugType&&i.urlServer&&$.post(i.urlServer+":8888/"+e.event,encodeURIComponent(JSON.stringify(e.data)))}}),e=decodeURIComponent(document.location.href.split("#")[1].split("?")[0]),n=document.location.href.split("#")[2].split("?")[0],systemId=document.location.href.split("#")[3].split("?")[0],t=this.require("storage").get(systemId),component=t.components[n][e],model=o.getGeneratedModel(n),o.store().uuid(e),o.store().collection(n),o.store().data(component);for(d in component)if(model[d]&&model[d].type)switch(!0){case"html"===model[d].type:s[d]="html";break;case"javascript"===model[d].type:s[d]="javascript";break;case"css"===model[d].type:s[d]="css";break;case"json"===model[d].type:case"object"===model[d].type:s[d]="json";break;case"text"===model[d].type:s[d]="text";break;default:!(i=t.types)||void 0===i[model[d].type]||"object"!==i[model[d].type].type&&"json"!==i[model[d].type].type||(s[d]="json")}o.store().extra(s),function(e){var t="",i=[];if(Object.keys(e)){for(t in e)r.require("db").collections().HTML.insert({_id:"menu-item-property-"+t+".html",source:'<a id="designer-menu-item-property-'+t+'" href="#'+t+'">'+t+"</a>"}),i=r.require("db").collections().MenuItem.insert({name:t,html:"menu-item-property-"+t+".html",position:10,type:"component"}),r.require("designer").menubar().items().push(r.require(i[0]));r.require("designer").menubar().items().sort(function(e,t){var i=runtime.require(e),n=runtime.require(t);return i.position()>n.position()?1:i.position()<n.position()?-1:0}),r.require("designer").menubar().render()}}(s),document.title="component "+e+" · system "+t.name,c=this.require("editor"),0===Object.keys(s).length?c.setEditor("json",JSON.stringify(component,null,"\t"),2):"json"===s[a=Object.keys(s)[0]]?c.setEditor(s[a],JSON.stringify(component[a],null,"\t"),2):c.setEditor(s[a],component[a],1,!0)},!0);var o=this.require("Designer");o.on("init",function(e){var t=null,i=null,n=null,r=null,o=null;this.type(window.location.href.split(".html")[0].split("/")[window.location.href.split(".html")[0].split("/").length-1]),t=new(this.require("Store")),i=new(this.require("MenuBar"))({designer:this}),n=new(this.require("ToolBar"))({designer:this}),r=new(this.require("Workspace"))({designer:this}),o=new(this.require("Server"))({designer:this}),this.store(t),this.menubar(i),this.toolbar(n),this.workspace(r),this.server(o)}),o.on("render",function(){var e="",t=null,i=null;this.isCordova()&&this.updateCordovaContext(),e=document.location.href.split("#")[3].split("?")[0],t=this.require("storage").get(e),i=new(this.require("System"))(t),this.system(i),this.toolbar().render(),this.workspace().render(),this.server().start(),this.updateRouter(),$(function(){$('[data-toggle="tooltip"]').tooltip({container:"body",delay:{show:1e3,hide:100}})})}),o.on("updateRouter",function(){var e=[],t=0,i=0,n="",r="",o="";for(n=decodeURIComponent(document.location.href.split("#")[1]),collection=document.location.href.split("#")[2],r=document.location.href.split("#")[3].split("?")[0],i=(e=$("#designer-menubar-items > li > a")).length,t=0;t<i;t++)o=e[t].href,context=o.split("#")[o.split("#").length-1],e[t].href="#"+n+"#"+collection+"#"+r+"#"+context}),o.on("clear",function(){this.refresh()}),o.on("context",function(e){this.workspace().clear(),this.workspace().refresh()}),o.on("save",function(){var e=this.require("editor").getValue(),t=this.require("designer"),i=this.require("message"),n=t.store().data(),r=t.store().extra();if("runtimeComponent"===t.context()){try{n=JSON.parse(e)}catch(e){return void i.danger("Can not save your component: your component has an invalid structure.")}if(!n._id)return void i.danger("The property '_id' is missing.");if(n._id&&-1!==n._id.indexOf(" "))return void i.danger("Invalid '_id'. <br>Space is not authorized in the value of '_id'.")}else"json"===r[t.context()]?n[t.context()]=JSON.parse(e):n[t.context()]=e;t.store().data(n),t.store().uuid()!==t.store().data()._id&&(this.require("channel").$editorDeleteComponent(t.store().uuid(),t.store().collection()),t.store().uuid(t.store().data()._id),document.title="component "+t.store().uuid()+" · "+document.title.split("·")[1].trim()),this.require("channel").$editorUpdateComponent(t.store().uuid(),t.store().collection(),t.store().data()),this.require("message").clean(),this.require("message").success("Component saved.")}),e.on("start",function(){new(this.require("Designer"))({_id:"designer"}).render()}),e.start()});