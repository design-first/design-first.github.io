/*
* System Designer
*
* https://designfirst.io/systemdesigner/
*
* Copyright 2017 Erwan Carriou
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*    http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
runtime.on("ready",function(){var a=this.system("design"),b=this.require("DialogImport");b.on("init",function(a){var b="",c=null;$(".modal-backdrop").remove(),$("#designer-dialog-import").empty(),b=this.require("dialog-modal-import.html"),document.querySelector("#designer-dialog-import").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title()).replace(/{{message}}/gi,this.message())),c=document.getElementById("designer-dialog-import-modal-cancel"),c.addEventListener("click",function(a){this.cancel()}.bind(this)),c=document.getElementById("designer-dialog-import-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this))}),b.on("show",function(){$("#designer-dialog-import-modal").modal("show")}),b.on("hide",function(){$("#designer-dialog-import-modal").modal("hide")});var c=this.require("DialogCheck");c.on("init",function(a){var b="",c=null;$("#designer-dialog-check").empty(),b=this.require("dialog-modal-check.html"),document.querySelector("#designer-dialog-check").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title()).replace(/{{message}}/gi,this.message())),c=document.getElementById("designer-dialog-check-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this))}),c.on("show",function(){$("#designer-dialog-check-modal").modal("show")}),c.on("hide",function(){$("#designer-dialog-check-modal").modal("hide")}),c.on("ok",function(){this.hide()});var d=this.require("DialogWelcome");d.on("init",function(a){var b="",c=null;$("#designer-dialog-welcome").empty(),b=this.require("dialog-modal-welcome.html"),document.querySelector("#designer-dialog-welcome").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title())),c=document.getElementById("designer-dialog-welcome-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this))}),d.on("show",function(){$("#designer-dialog-welcome-modal").modal("show")}),d.on("hide",function(){$("#designer-dialog-welcome-modal").modal("hide")});var e=this.require("DialogSync");e.on("init",function(a){var b="",c=null;$("#designer-dialog-sync").empty(),b=this.require("dialog-modal-sync.html"),document.querySelector("#designer-dialog-sync").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title())),c=document.getElementById("designer-dialog-sync-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this)),c=document.getElementById("designer-dialog-type-creation-hasHTML"),c.addEventListener("click",function(a){$("#designer-dialog-type-creation-hasHTML")[0].checked?$("#designer-dialog-sync-options-log-level").show():$("#designer-dialog-sync-options-log-level").hide()}.bind(this)),c=document.getElementById("designer-dialog-sync-commit"),c.addEventListener("click",function(a){$("#designer-dialog-sync-comments-area").show(),$("#designer-dialog-sync-options-area").show(),$("#designer-dialog-sync-options-node").show(),$("#designer-dialog-type-creation-hasHTML")[0].checked&&$("#designer-dialog-sync-options-log-level").show()}.bind(this)),c=document.getElementById("designer-dialog-sync-refresh"),c.addEventListener("click",function(a){$("#designer-dialog-sync-comments-area").hide(),$("#designer-dialog-sync-options-area").hide(),$("#designer-dialog-sync-options-log-level").hide(),$("#designer-dialog-sync-options-node").hide()}.bind(this))}),e.on("show",function(){$("#designer-dialog-sync-modal").modal("show")}),e.on("hide",function(){$("#designer-dialog-sync-modal").modal("hide")});var f=this.require("DialogShare");f.on("init",function(a){var b=null,c=null,d="";$("#designer-dialog-share").empty(),d=this.require("db").collections().System.find({_id:this.require("designer").system().id()})[0],b=this.require("dialog-modal-share.html"),document.querySelector("#designer-dialog-share").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title()).replace(/{{message}}/gi,window.location.toString().split("#")[0]+"?system="+encodeURIComponent(JSON.stringify(d)))),c=document.getElementById("designer-dialog-share-modal-cancel"),c.addEventListener("click",function(a){this.cancel()}.bind(this)),c=document.getElementById("designer-dialog-share-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this))}),f.on("show",function(){$("#designer-dialog-share-modal").modal("show")}),f.on("hide",function(){$("#designer-dialog-share-modal").modal("hide")});var g=this.require("DialogCopyright");g.on("init",function(a){var b="",c=null;$("#designer-dialog-copyright").empty(),b=this.require("dialog-modal-copyright.html"),document.querySelector("#designer-dialog-copyright").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title()).replace(/{{message}}/gi,this.message())),c=document.getElementById("designer-dialog-copyright-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this))}),g.on("show",function(){$("#designer-dialog-copyright-modal").modal("show")}),g.on("hide",function(){$("#designer-dialog-copyright-modal").modal("hide")});var h=this.require("DialogConfig");h.on("init",function(a){var b="",c=null,d=this,e=null;d.require("designer");$("#designer-dialog-config").empty(),b=this.require("dialog-modal-config.html"),document.querySelector("#designer-dialog-config").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title())),e=this.require("storage").get("system-designer-config"),e||(e={}),"undefined"==typeof e.debugType&&(e.debugType="client",this.require("storage").set("system-designer-config",e)),"client"===e.debugType?($("#designer-dialog-config-radio-client").attr("checked",!0),$("#designer-dialog-config-server-form").hide()):($("#designer-dialog-config-radio-server").attr("checked",!0),$("#designer-dialog-config-client-form").hide()),e.urlClient&&($("#designer-dialog-config-url-client")[0].value=e.urlClient),e.urlServer&&($("#designer-dialog-config-url-server")[0].value=e.urlServer),e.githubToken&&($("#designer-dialog-config-github-token")[0].value=atob(e.githubToken)),e.githubRepository&&($("#designer-dialog-config-github-repository")[0].value=e.githubRepository),e.advancedMode&&$("#designer-dialog-config-advanced-mode-isAdvanced").attr("checked",!0),c=document.getElementById("designer-dialog-config-radio-client"),c.addEventListener("click",function(a){var b=this.require("storage").get("system-designer-config");b||(b={}),b.debugType="client",this.require("storage").set("system-designer-config",b),$("#designer-dialog-config-client-form").show(),$("#designer-dialog-config-server-form").hide()}.bind(this)),c=document.getElementById("designer-dialog-config-radio-server"),c.addEventListener("click",function(a){var b=this.require("storage").get("system-designer-config");b||(b={}),b.debugType="server",this.require("storage").set("system-designer-config",b),$("#designer-dialog-config-client-form").hide(),$("#designer-dialog-config-server-form").show()}.bind(this)),c=document.getElementById("designer-dialog-config-url-client"),c.addEventListener("keydown",function(a){if(13===a.keyCode)return a.stopPropagation(),a.preventDefault(),$("#designer-dialog-config-url-client").val()&&this.ok(),!1}.bind(this)),c=document.getElementById("designer-dialog-config-github-token"),c.addEventListener("keydown",function(a){if(13===a.keyCode)return a.stopPropagation(),a.preventDefault(),$("#designer-dialog-config-github-token").val()&&this.ok(),!1}.bind(this)),c=document.getElementById("designer-dialog-config-github-repository"),c.addEventListener("keydown",function(a){if(13===a.keyCode)return a.stopPropagation(),a.preventDefault(),$("#designer-dialog-config-github-repository").val()&&this.ok(),!1}.bind(this)),c=document.getElementById("designer-dialog-config-url-server"),c.addEventListener("keydown",function(a){if(13===a.keyCode)return a.stopPropagation(),a.preventDefault(),$("#designer-dialog-config-url-server").val()&&this.ok(),!1}.bind(this)),c=document.getElementById("designer-dialog-config-advanced-mode-isAdvanced"),c.addEventListener("click",function(a){var b=this.require("storage").get("system-designer-config");b||(b={}),b.advancedMode=$("#designer-dialog-config-advanced-mode-isAdvanced").prop("checked"),this.require("storage").set("system-designer-config",b)}.bind(this)),c=document.getElementById("designer-dialog-config-modal-cancel"),c.addEventListener("click",function(a){this.cancel()}.bind(this)),c=document.getElementById("designer-dialog-config-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this))}),h.on("show",function(){$("#designer-dialog-config-modal").modal("show")}),h.on("hide",function(){$("#designer-dialog-config-modal").modal("hide")}),h.on("ok",function(){var a=this.require("storage").get("system-designer-config");a||(a={}),a.urlClient=$("#designer-dialog-config-url-client")[0].value,a.urlServer=$("#designer-dialog-config-url-server")[0].value,a.githubToken=btoa($("#designer-dialog-config-github-token")[0].value),a.githubRepository=$("#designer-dialog-config-github-repository")[0].value,this.require("storage").set("system-designer-config",a)});var j=this.require("DialogImportFile");j.on("init",function(a){var b="",c=null,d=this,e=[],f="",g=[],h="",i="",j="",k=0,l=0,m="";for($("#designer-dialog-import-file").empty(),e=this.require("db").collections().JSON.find(),k=e.length,l=0;l<k;l++)f=this.require(e[l]._id),m=m+'<a class="list-group-item" id="designer-dialog-import-file-modal-library-'+f.id()+'"><h4 class="list-group-item-heading">'+JSON.parse(decodeURIComponent(f.source())).description.substr(0,40).split("\n")[0].split(".")[0]+'</h4><p class="list-group-item-text">v'+JSON.parse(decodeURIComponent(f.source())).version+"</p></a>";for(g=this.require("storage").get("system-designer-systems"),g&&(j=g.systems),k=j.length,l=0;l<k;l++)h=this.require("storage").get(j[l]),this.require("designer").system()&&this.require("designer").system().id()===h._id||(i=i+'<a class="list-group-item" id="designer-dialog-import-file-modal-systems-'+h._id+'"><h4 class="list-group-item-heading">'+h.name+'</h4><p class="list-group-item-text">v'+h.version+"</p></a>");b=this.require("dialog-modal-import-file.html"),document.querySelector("#designer-dialog-import-file").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title()).replace(/{{library}}/gi,m).replace(/{{systems}}/gi,i)),""===i?($("#designer-dialog-import-modal-from-systems-input").hide(),this.require("designer").isCordova()&&($("#designer-dialog-import-modal-from-library-form").show(),$("#designer-dialog-import-modal-type-import").hide())):this.require("designer").isCordova()&&($("#designer-dialog-import-modal-from-library-form").show(),$("#designer-dialog-import-modal-type-import").show()),this.require("designer").isCordova()&&($("#designer-dialog-import-modal-from-file").attr("checked",!1),$("#designer-dialog-import-modal-from-library").attr("checked",!0)),this.require("designer").system()||$("#designer-dialog-import-file-modal-merge").hide();var n=function(a){var b="",c=null,e=0,f=0;if($(this).hasClass("active"))$(this).removeClass("active"),d.data(null);else{for(b=this.getAttribute("id").replace("designer-dialog-import-file-modal-systems-",""),d.data(d.require("storage").get(b)),c=document.getElementById("designer-dialog-import-file-modal-systems"),e=c.children.length,f=0;f<e;f++)$(c.children[f]).removeClass("active");$(this).addClass("active")}};for(k=j.length,l=0;l<k;l++)h=d.require("storage").get(g.systems[l]),this.require("designer").system()&&this.require("designer").system().id()===h._id||(c=document.getElementById("designer-dialog-import-file-modal-systems-"+h._id),c.addEventListener("click",n));var o=function(a){var b="",c=null,e=0,f=0;if($(this).hasClass("active"))$(this).removeClass("active"),d.data(null);else{for(b=this.getAttribute("id").replace("designer-dialog-import-file-modal-library-",""),d.data(JSON.parse(decodeURIComponent(d.require(b).source()))),c=document.getElementById("designer-dialog-import-file-modal-library"),e=c.children.length,f=0;f<e;f++)$(c.children[f]).removeClass("active");$(this).addClass("active")}};for(k=e.length,l=0;l<k;l++)f=this.require(e[l]._id),c=document.getElementById("designer-dialog-import-file-modal-library-"+f.id()),c.addEventListener("click",o);c=document.getElementById("designer-dialog-import-modal-from-file"),c.addEventListener("click",function(a){$("#designer-dialog-import-modal-from-file-form").show(),$("#designer-dialog-import-modal-from-systems-form").hide(),$("#designer-dialog-import-modal-from-library-form").hide(),$("#designer-dialog-import-file-modal-import").show(),$("#designer-dialog-import-file-modal-merge").removeClass("btn-primary"),$("#designer-dialog-import-file-modal-merge").addClass("btn-default")}.bind(this)),c=document.getElementById("designer-dialog-import-modal-from-library"),c.addEventListener("click",function(a){$("#designer-dialog-import-modal-from-library-form").show(),$("#designer-dialog-import-modal-from-systems-form").hide(),$("#designer-dialog-import-modal-from-file-form").hide(),$("#designer-dialog-import-file-modal-import").show(),$("#designer-dialog-import-file-modal-merge").removeClass("btn-primary"),$("#designer-dialog-import-file-modal-merge").addClass("btn-default")}.bind(this)),c=document.getElementById("designer-dialog-import-modal-from-systems"),c.addEventListener("click",function(a){$("#designer-dialog-import-modal-from-library-form").hide(),$("#designer-dialog-import-modal-from-systems-form").show(),$("#designer-dialog-import-modal-from-file-form").hide(),$("#designer-dialog-import-file-modal-import").hide(),$("#designer-dialog-import-file-modal-merge").removeClass("btn-default"),$("#designer-dialog-import-file-modal-merge").addClass("btn-primary")}.bind(this)),c=document.getElementById("designer-dialog-import-file-modal-cancel"),c.addEventListener("click",function(a){this.cancel()}.bind(this)),c=document.getElementById("designer-dialog-import-file-modal-merge"),c.addEventListener("click",function(a){this.mergeSystem()}.bind(this)),c=document.getElementById("designer-dialog-import-file-modal-import"),c.addEventListener("click",function(a){this.importSystem()}.bind(this)),c=document.getElementById("designer-dialog-import-file-modal-file"),c.addEventListener("change",function(a){a.stopPropagation(),a.preventDefault();var b=a.target.files,c=new FileReader,d="",e=this;c.onload=function(a){d+=a.target.result},c.onloadend=function(){try{e.data(JSON.parse(d))}catch(a){e.data({})}},c.readAsText(b[0],"UTF-8")}.bind(this))}),j.on("show",function(){$("#designer-dialog-import-file-modal").modal("show")}),j.on("hide",function(){$("#designer-dialog-import-file-modal").modal("hide")});var k=this.require("DialogDropFile");k.on("init",function(a){var b=null,c=null;$("#designer-dialog-drop-file").empty(),b=this.require("dialog-modal-drop-file.html"),document.querySelector("#designer-dialog-drop-file").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title()).replace(/{{message}}/gi,this.message())),c=document.getElementById("designer-dialog-drop-file-modal-cancel"),c.addEventListener("click",function(a){this.cancel()}.bind(this)),c=document.getElementById("designer-dialog-drop-file-modal-merge"),c.addEventListener("click",function(a){this.mergeSystem()}.bind(this)),c=document.getElementById("designer-dialog-drop-file-modal-import"),c.addEventListener("click",function(a){this.importSystem()}.bind(this)),this.require("designer").system()||$("#designer-dialog-drop-file-modal-merge").hide()}),k.on("mergeSystem",function(){function a(a){var b="",c="";for(c in l.system().models())if(l.system().models()[c]._name===a){b=c;break}return b}function b(a){var b="",c="";for(c in l.system().schemas())if(l.system().schemas()[c]._name===a){b=c;break}return b}function c(a,b,c){var d={},e="",f=!1;for(e in c)if(d=c[e],d.component===a&&d.state===b){f=!0;break}return f}function d(a,d,e,f){var g={},h="",i=!0;return h=b(f.component),g=d[h],!g||"method"!==g[f.state]&&"event"!==g[f.state]||(i=!c(f.component,f.state,e)),"main"!==f.state&&"start"!==f.state&&"stop"!==f.state||f.component!==a||(i=!1),i}var e=null,f="",g="",h="",i="",j="",k="",l=this.require("designer"),m={},n={},o={},p={},q={},r=(l.system(),this.require("message"));if(e=this.data(),Object.keys(e).length){q=JSON.parse(JSON.stringify(l.system().behaviors())),m=JSON.parse(JSON.stringify(l.system().schemas()));for(f in e.behaviors)f!==e._id&&d(e._id,m,q,e.behaviors[f])?q[f]=e.behaviors[f]:"main"!==e.behaviors[f].state&&"start"!==e.behaviors[f].state&&"stop"!==e.behaviors[f].state||e.behaviors[f].component!==e._id||l.mergeBehavior(q,e.behaviors[f],l.system().id(),e.name);l.system().behaviors(q),m=JSON.parse(JSON.stringify(l.system().schemas()));for(f in e.schemas)if(m[f])for(h in e.schemas[f])m[f][h]=e.schemas[f][h];else if(b(e.schemas[f]._name))for(h in e.schemas[f])0!==h.indexOf("_")&&(m[b(e.schemas[f]._name)][h]=e.schemas[f][h]);else m[f]=e.schemas[f];for(k in m)l.syncModel(m[k]);n=JSON.parse(JSON.stringify(l.system().models()));for(f in e.models)if(n[f])for(h in e.models[f])n[f][h]=e.models[f][h];else if(a(e.models[f]._name))for(h in e.models[f])0!==h.indexOf("_")&&(n[a(e.models[f]._name)][h]=e.models[f][h]);else n[f]=e.models[f];for(j in n)l.syncBehavior(n[j]);o=JSON.parse(JSON.stringify(l.system().types()));for(f in e.types)if(o[f])for(h in e.types[f])o[f][h]=e.types[f][h];else o[f]=e.types[f];p=JSON.parse(JSON.stringify(l.system().components()));for(g in e.components){p[g]||(p[g]={});for(i in e.components[g])if(p[g][i])for(h in e.components[g][i])p[g][i][h]=e.components[g][i][h];else p[g][i]=e.components[g][i]}l.system().components(p);for(j in n)l.syncComponent(n[j]);l.system().schemas(m),l.system().models(n),l.system().types(o),l.system().behaviors(q),l.system().components(p),l.save(),l.spaces().render(),l.workspace().refresh(),l.updateRouter(),this.hide(),r.success("Composition of the system is done.")}else r.danger("The system you try to import is invalid.")}),k.on("importSystem",function(){var a=this.require("System"),b=null,c=this.require("designer"),d=this.require("message");c.system()&&c.system().destroy(),b=new a(this.data()),c.system(b),c.logs().forEach(function(a){this.logs().pop()}.bind(c)),c.save(),c.space(b.name()),c.spaces().render(),c.workspace().refresh(),c.updateRouter(),this.hide(),c.save(),d.success("Importation of the system is done.")}),k.on("show",function(){$("#designer-dialog-drop-file-modal").modal("show")}),k.on("hide",function(){$("#designer-dialog-drop-file-modal").modal("hide")});var l=this.require("DialogTypeCreation");l.on("init",function(a){var b="",c=null;$("#designer-dialog-type-creation").empty(),b=this.require("dialog-modal-type-creation.html"),document.querySelector("#designer-dialog-type-creation").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title())),c=document.getElementById("designer-dialog-type-creation-name"),c.addEventListener("keydown",function(a){if(13===a.keyCode)return a.stopPropagation(),a.preventDefault(),$("#designer-dialog-type-creation-name").val()&&this.ok(),!1}.bind(this)),c=document.getElementById("designer-dialog-type-creation-modal-cancel"),c.addEventListener("click",function(a){this.cancel()}.bind(this)),c=document.getElementById("designer-dialog-type-creation-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this)),$("#designer-dialog-type-creation-modal").on("shown.bs.modal",function(){$("#designer-dialog-type-creation-name").focus()})}),l.on("show",function(){$("#designer-dialog-type-creation-modal").modal("show")}),l.on("hide",function(){$("#designer-dialog-type-creation-modal").modal("hide")});var m=this.require("DialogExport");m.on("init",function(a){var b="",c=null,d=this.require("designer").system();$("#designer-dialog-export").empty(),b=this.require("dialog-modal-export.html"),document.querySelector("#designer-dialog-export").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title())),d.master()===!0&&$("#designer-dialog-export-isMaster").attr("checked",!0),d.subsystem()===!0&&$("#designer-dialog-export-isSubsystem").attr("checked",!0),c=document.getElementById("designer-dialog-export-modal-cancel"),c.addEventListener("click",function(a){this.cancel()}.bind(this)),c=document.getElementById("designer-dialog-export-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this)),c=document.getElementById("designer-dialog-export-json"),c.addEventListener("click",function(a){$("#designer-dialog-export-options").show(),$("#designer-dialog-export-options-log-level").hide()}.bind(this)),c=document.getElementById("designer-dialog-export-html"),c.addEventListener("click",function(a){$("#designer-dialog-export-options").hide(),$("#designer-dialog-export-options-log-level").show()}.bind(this)),c=document.getElementById("designer-dialog-export-node"),c.addEventListener("click",function(a){$("#designer-dialog-export-options").hide(),$("#designer-dialog-export-options-log-level").show()}.bind(this)),c=document.getElementById("designer-dialog-export-modal"),c.addEventListener("keydown",function(a){if(13===a.keyCode)return a.stopPropagation(),a.preventDefault(),this.ok(),!1}.bind(this))}),m.on("show",function(){$("#designer-dialog-export-modal").modal("show")}),m.on("hide",function(){$("#designer-dialog-export-modal").modal("hide")});var n=this.require("DialogSchemaCreation");n.on("init",function(a){var b="",c=null;$("#designer-dialog-schema-creation").empty(),b=this.require("dialog-modal-schema-creation.html"),document.querySelector("#designer-dialog-schema-creation").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title())),c=document.getElementById("designer-dialog-schema-creation-name"),c.addEventListener("keydown",function(a){if(13===a.keyCode)return a.stopPropagation(),a.preventDefault(),$("#designer-dialog-schema-creation-name").val()&&this.ok(),!1}.bind(this)),c=document.getElementById("designer-dialog-schema-creation-modal-cancel"),c.addEventListener("click",function(a){this.cancel()}.bind(this)),c=document.getElementById("designer-dialog-schema-creation-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this)),$("#designer-dialog-schema-creation-modal").on("shown.bs.modal",function(){$("#designer-dialog-schema-creation-name").focus()})}),n.on("show",function(){$("#designer-dialog-schema-creation-modal").modal("show")}),n.on("hide",function(){$("#designer-dialog-schema-creation-modal").modal("hide")});var o=this.require("DialogSystemCreation");o.on("init",function(a){var b="",c=null;$("#designer-dialog-system-creation").empty(),b=this.require("dialog-modal-system-creation.html"),document.querySelector("#designer-dialog-system-creation").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title())),c=document.getElementById("designer-dialog-system-creation-name"),c.addEventListener("keydown",function(a){if(13===a.keyCode)return a.stopPropagation(),a.preventDefault(),$("#designer-dialog-system-creation-name").val()&&this.ok(),!1}.bind(this)),c=document.getElementById("designer-dialog-system-creation-modal-cancel"),c.addEventListener("click",function(a){this.cancel()}.bind(this)),c=document.getElementById("designer-dialog-system-creation-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this)),$("#designer-dialog-system-creation-modal").on("shown.bs.modal",function(){$("#designer-dialog-system-creation-name").focus()})}),o.on("show",function(){$("#designer-dialog-system-creation-modal").modal("show")}),o.on("hide",function(){$("#designer-dialog-system-creation-modal").modal("hide")});var p=this.require("DialogModelCreation");p.on("init",function(a){var b="",c=null;$("#designer-dialog-model-creation").empty(),b=this.require("dialog-modal-model-creation.html"),document.querySelector("#designer-dialog-model-creation").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title())),c=document.getElementById("designer-dialog-model-creation-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this))}),p.on("show",function(){$("#designer-dialog-model-creation-modal").modal("show")}),p.on("hide",function(){$("#designer-dialog-model-creation-modal").modal("hide")});var q=this.require("DialogBehaviorCreation");q.on("init",function(a){function b(a){var b=a,c="";for(c in g.system().components())if("undefined"!=typeof g.system().components()[c][a]){b=c;break}return b}var c="",d=null,e="",f=[],g=this.require("designer"),h=this.require("designer").space();g.system().schemas(),g.system().models();$("#designer-dialog-behavior-creation").empty(),h!==g.system().name()?f=Object.keys(this.require("designer").getGeneratedSchema(b(h))):(f.push("start"),f.push("stop")),f.sort(),f.forEach(function(a){e=e+'<option value="'+a+'">'+a+"</option>"}),c=this.require("dialog-modal-behavior-creation.html"),document.querySelector("#designer-dialog-behavior-creation").insertAdjacentHTML("afterbegin",c.source().replace(/{{title}}/gi,this.title()).replace(/{{states}}/gi,e)),d=document.getElementById("designer-dialog-behavior-creation-state"),d.addEventListener("keydown",function(a){if(13===a.keyCode)return a.stopPropagation(),a.preventDefault(),$("#designer-dialog-behavior-creation-state").val()&&this.ok(),!1}.bind(this)),d=document.getElementById("designer-dialog-behavior-creation-modal-cancel"),d.addEventListener("click",function(a){this.cancel()}.bind(this)),d=document.getElementById("designer-dialog-behavior-creation-modal-ok"),d.addEventListener("click",function(a){this.ok()}.bind(this)),$("#designer-dialog-behavior-creation-modal").on("shown.bs.modal",function(){$("#designer-dialog-behavior-creation-state").focus()})}),q.on("show",function(){$("#designer-dialog-behavior-creation-modal").modal("show")}),q.on("hide",function(){$("#designer-dialog-behavior-creation-modal").modal("hide")});var r=this.require("DialogComponentCreation");r.on("init",function(a){var b="",c="",d=null,e="",f=this.require("designer"),g=f.system().models();$("#designer-dialog-component-creation").empty();for(c in g)e=e+'<option value="'+c+'">'+c+"</option>";b=this.require("dialog-modal-component-creation.html"),document.querySelector("#designer-dialog-component-creation").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title()).replace(/{{models}}/gi,e)),d=document.getElementById("designer-dialog-component-creation-modal-cancel"),d.addEventListener("click",function(a){this.cancel()}.bind(this)),d=document.getElementById("designer-dialog-component-creation-modal-ok"),d.addEventListener("click",function(a){this.ok()}.bind(this))}),r.on("show",function(){$("#designer-dialog-component-creation-modal").modal("show")}),r.on("hide",function(){$("#designer-dialog-component-creation-modal").modal("hide")});var s=this.require("DialogRuntimeComponentInfo");s.on("init",function(a){var b="",c=null;$("#designer-dialog-runtimecomponent-info").empty(),b=this.require("dialog-modal-runtimecomponent-info.html"),document.querySelector("#designer-dialog-runtimecomponent-info").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title())),c=document.getElementById("designer-dialog-runtimecomponent-info-modal-ok"),c.addEventListener("click",function(a){this.hide()}.bind(this))}),s.on("show",function(){$("#designer-dialog-runtimecomponent-info-modal").modal("show")}),s.on("hide",function(){$("#designer-dialog-runtimecomponent-info-modal").modal("hide")});var t=this.require("ModelSystem");t.on("render",function(){var a=null,b=this,c="",d="",e="";a=this.require("model-system.html");for(d in this.document())["name","description","version"].indexOf(d)!==-1&&(e=this.document()[d],e=e.replace(/\n/g,"<br>"),c=c+"<tr><td>"+d+"</td><td>"+e+"</td></tr>");document.querySelector("#designer-workspace").insertAdjacentHTML("afterbegin",a.source().replace(/{{title}}/gi,this.title()).replace(/{{_id}}/gi,this.uuid()).replace(/{{content}}/gi,c)),a=document.getElementById("designer-system-"+this.uuid()).children[0].children[1],a&&a.addEventListener("click",function(a){this.require("designer").open("system.html#"+b.uuid()+"#description")}.bind(this)),a=document.getElementById("designer-system-"+this.uuid()+"-edit"),a&&a.addEventListener("click",function(a){this.require("designer").open("system.html#"+b.uuid()+"#description")}.bind(this)),a=document.getElementById("designer-system-"+this.uuid()+"-export"),a&&a.addEventListener("click",function(a){var b=(this.document().name,JSON.parse(JSON.stringify(this.document())));delete b.classInfo,this.require("designer").saveAs(b,this.document().name+".json")}.bind(this)),a=document.getElementById("designer-system-"+this.uuid()+"-delete"),a&&a.addEventListener("click",function(a){var b=this.require("storage").get("system-designer-systems"),c=this.require("designer"),d=this.require("System"),e=this.uuid();this.require("storage").remove(e),b.systems.splice(b.systems.indexOf(e),1),this.require("storage").set("system-designer-systems",b),c.system().destroy(),c.logs().forEach(function(a){this.logs().pop()}.bind(c)),b.systems.length&&c.system(new d(this.require("storage").get(b.systems[0]))),$("#designer-system-"+this.uuid()).remove(),this.destroy(),c.space(""),c.spaces().render(),c.workspace().refresh()}.bind(this))}),t.on("hide",function(){$("#designer-system-"+this.uuid()).hide()}),t.on("show",function(){$("#designer-system-"+this.uuid()).show()});var u=this.require("ModelType");u.on("render",function(){function a(a){var b="",c="";for(c in d.require("designer").system().models())if(d.require("designer").system().models()[c]._name===a){b=c;break}return b}function b(b,c){var e="";return e=Array.isArray(c)?c[0].indexOf("@")!==-1?"@RuntimeComponent"!==c[0]?'<div class="list-group-item" style="text-align: left">'+b+'<a href="#'+d.require("designer").system().id()+"#models#"+a(c[0].replace("@",""))+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+c[0].replace("@","")+"</a> [ ]</div>":'<div class="list-group-item" style="text-align: left">'+b+c[0].replace("@","")+" [ ]</div>":["any","boolean","string","number","object","function","array","html","javascript","css","json","text","date"].indexOf(c[0])===-1?'<div class="list-group-item" style="text-align: left">'+b+'<a href="#'+d.require("designer").system().id()+"#types#"+c[0]+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+c[0].replace("@","")+"</a> [ ]</div>":'<div class="list-group-item" style="text-align: left">'+b+c[0]+" [ ]</div>":c.indexOf("@")!==-1?"@RuntimeComponent"!==c?'<div class="list-group-item" style="text-align: left">'+b+'<a href="#'+d.require("designer").system().id()+"#models#"+a(c.replace("@",""))+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+c.replace("@","")+"</a></div>":'<div class="list-group-item" style="text-align: left">'+b+c.replace("@","")+"</div>":["any","boolean","string","number","object","function","array","html","javascript","css","json","text","date"].indexOf(c)===-1?'<div class="list-group-item" style="text-align: left">'+b+'<a href="#'+d.require("designer").system().id()+"#types#"+c+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+c+"</a></div>":'<div class="list-group-item" style="text-align: left">'+b+c+"</div>"}var c=null,d=this,e="",f="",g="",h="";if(h=this.require("designer").system().id(),c=this.require("model-type.html"),this.document().schema)for(f in this.document().schema)this.document().schema.hasOwnProperty(f)&&(g=this.document().schema[f].type,e+=b(f+" : ",g));this.document().value&&this.document().value.forEach(function(a){e=e+'<div class="list-group-item" style="text-align: left">'+a+"</div>"}),this.document().schema||this.document().value||(g=this.document().type,e=e+'<div class="list-group-item" style="text-align: left"><i>alias</i> : '+g+"</div>"),""===e&&(e+='<a class="list-group-item" style="text-align: left"><br/><br/></a>'),document.querySelector("#designer-workspace").insertAdjacentHTML("afterbegin",c.source().replace(/{{title}}/gi,this.title()).replace(/{{id}}/gi,this.uuid()).replace(/{{content}}/gi,e)),
c=document.getElementById("designer-type-"+this.uuid()).children[0].children[1],c&&c.addEventListener("click",function(a){this.require("designer").open("type.html#"+d.uuid()+"#"+h)}.bind(this)),c=document.getElementById("designer-type-"+this.uuid()+"-edit"),c&&c.addEventListener("click",function(a){this.require("designer").open("type.html#"+d.uuid()+"#"+h)}.bind(this)),c=document.getElementById("designer-type-"+this.uuid()+"-export"),c&&c.addEventListener("click",function(a){var b={name:"type "+this.document().name,master:!1,subsystem:!0,version:"0.0.1",description:"Type "+this.document().name,schemas:{},models:{},behaviors:{},types:{},components:{}};b.name=b.name.trim(),b.name=b.name.replace(/ /gi,"-"),b.name=b.name.toLocaleLowerCase(),b.types[this.document().name]=this.document(),this.require("designer").saveAs(b,"type."+this.document().name.replace(/ /gi,"-").toLowerCase()+".json")}.bind(this)),c=document.getElementById("designer-type-"+this.uuid()+"-delete"),c&&c.addEventListener("click",function(a){var b=this.require("designer");types=b.system().types(),delete types[this.title()],b.system().types(types),$("#designer-type-"+this.title()).remove(),this.require("channel").$designerDeleteType(this.uuid()),this.destroy(),b.save(),b.space(""),b.spaces().render(),b.workspace().refresh()}.bind(this))}),u.on("hide",function(){$("#designer-type-"+this.title()).hide()}),u.on("show",function(){$("#designer-type-"+this.title()).show()});var v=this.require("ModelSchema");v.on("render",function(){var a=null,b="",c=this,d="",e="",f="";f=this.uuid()||this.title(),systemId=this.require("designer").system().id(),a=this.require("model-schema.html");for(d in this.document())this.document().hasOwnProperty(d)&&0!==d.indexOf("_")&&(e=this.document()[d],b=b+"<tr><td>"+d+"</td><td>"+e+"</td></tr>");""===b&&(b+="<tr><td><br/><br/><br/></td><td><br/><br/><br/></td></tr>"),document.querySelector("#designer-workspace").insertAdjacentHTML("afterbegin",a.source().replace(/{{title}}/gi,this.title()).replace(/{{id}}/gi,f).replace(/{{content}}/gi,b)),this.editable()?(a=document.getElementById("designer-schema-"+f).children[0].children[1],a&&a.addEventListener("click",function(a){this.require("designer").open("schema.html#"+c.uuid()+"#"+systemId)}.bind(this)),a=document.getElementById("designer-schema-"+f+"-edit"),a&&a.addEventListener("click",function(a){this.require("designer").open("schema.html#"+c.uuid()+"#"+systemId)}.bind(this)),a=document.getElementById("designer-schema-"+f+"-export"),a&&a.addEventListener("click",function(a){var b={name:"schema "+this.document()._name,master:!1,subsystem:!0,version:"0.0.1",description:"Schema "+this.document()._name,schemas:{},models:{},behaviors:{},types:{},components:{}};b.name=b.name.trim(),b.name=b.name.replace(/ /gi,"-"),b.name=b.name.toLocaleLowerCase(),b.schemas[this.document()._id]=this.document(),this.require("designer").saveAs(b,"schema."+this.document()._name.replace(/ /gi,"-").toLowerCase()+".json")}.bind(this)),a=document.getElementById("designer-schema-"+f+"-delete"),a&&a.addEventListener("click",function(a){var b=this.require("designer");b.deleteSchema(this.uuid()),$("#designer-schema-"+this.uuid()).remove(),this.require("channel").$designerDeleteSchema(this.uuid()),this.destroy(),jsPlumb.deleteEveryEndpoint(),b.save(),b.space(""),b.spaces().render(),b.workspace().refresh()}.bind(this))):($("#designer-schema-"+f+" > div > div > div > button").hide(),a=document.getElementById("designer-schema-"+f).children[0].children[1],a&&a.addEventListener("click",function(a){var b=null;"RuntimeComponent"!==this.title()?this.require("designer").system().schemas()[c.uuid()]?this.require("designer").open("index.html#"+this.require("designer").system().id()+"#schemas#"+c.uuid(),"_self"):this.require("message").warning("Your schema ‘"+c.title()+"’ has not been yet created."):(b=this.require("DialogRuntimeComponentInfo"),b=new b({title:"RuntimeComponent schema"}),b.show())}.bind(this)))}),v.on("hide",function(){$("#designer-schema-"+this.uuid()).hide()}),v.on("show",function(){$("#designer-schema-"+this.uuid()).show()});var w=this.require("ModelClass");w.on("render",function(){function a(a){var b="",d="";for(d in c.require("designer").system().models())if(c.require("designer").system().models()[d]._name===a){b=d;break}return b}var b=null,c=this,d="",e="",f="",g="",h="",i="",j="",k=null,l="",m=null,n="";l=this.uuid()||this.title(),n=this.require("designer").system().id(),k=function(b){o=b.type.indexOf("@")!==-1?o+b.name+' : <a href="#'+this.require("designer").system().id()+"#models#"+a(b.type.replace("@",""))+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+b.type.replace("@","")+"</a>, ":["any","boolean","string","number","object","function","array","html","javascript","css","errorParam","json","text","date"].indexOf(b.type)===-1?o+b.name+' : <a href="#'+this.require("designer").system().id()+"#types#"+b.type+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+b.type.replace("@","")+"</a>, ":o+b.name+" : "+b.type+", "};for(d in this.document())if(this.document().hasOwnProperty(d))switch(i=this.document()[d],!0){case"undefined"!=typeof i.type:e=Array.isArray(i.type)?i.type[0].indexOf("@")!==-1?"123751cb591de26"!==l&&"@RuntimeComponent"!==i.type[0]?e+'<div class="list-group-item" style="text-align: left">+ '+d+' : <a href="#'+this.require("designer").system().id()+"#models#"+a(i.type[0].replace("@",""))+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+i.type[0].replace("@","")+"</a> [ ]</div>":e+'<div class="list-group-item" style="text-align: left">+ '+d+" : "+i.type[0].replace("@","")+" [ ]</div>":["any","boolean","string","number","object","function","array","html","javascript","css","json","text","date"].indexOf(i.type[0])===-1?"123751cb591de26"!==l?e+'<div class="list-group-item" style="text-align: left">+ '+d+' : <a href="#'+this.require("designer").system().id()+"#types#"+i.type[0]+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+i.type[0].replace("@","")+"</a> [ ]</div>":e+'<div class="list-group-item" style="text-align: left">+ '+d+" : "+i.type[0].replace("@","")+" [ ]</div>":e+'<div class="list-group-item" style="text-align: left">+ '+d+" : "+i.type[0]+" [ ]</div>":i.type.indexOf("@")!==-1?"123751cb591de26"!==l&&"@RuntimeComponent"!==i.type?e+'<div class="list-group-item" style="text-align: left">+ '+d+' : <a href="#'+this.require("designer").system().id()+"#models#"+a(i.type.replace("@",""))+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+i.type.replace("@","")+"</a></div>":e+'<div class="list-group-item" style="text-align: left">+ '+d+" : "+i.type.replace("@","")+"</div>":["any","boolean","string","number","object","function","array","html","javascript","css","json","text","date"].indexOf(i.type)===-1&&"123751cb591de26"!==l?e+'<div class="list-group-item" style="text-align: left">+ '+d+' : <a href="#'+this.require("designer").system().id()+"#types#"+i.type+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+i.type+"</a></div>":e+'<div class="list-group-item" style="text-align: left">+ '+d+" : "+i.type+"</div>";break;case"undefined"!=typeof i.params:j="undefined";var o="(";i.params.forEach(k.bind(this)),o+=")",o=o.replace(", )",")"),"undefined"!=typeof i.result?(j=i.result,"123751cb591de26"!==l?(j.indexOf("@")!==-1&&(j='<a href="#'+this.require("designer").system().id()+"#models#"+a(j.replace("@",""))+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+j.replace("@","")+"</a>"),g=g+'<div class="list-group-item" style="text-align: left">+ <a href="#'+this.require("designer").system().id()+"#behaviors#"+this.document()._name+"#"+d+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+d+"</a>"+o+" : "+j+"</div>"):g=g+'<div class="list-group-item" style="text-align: left">+ '+d+o+" : "+j+"</div>"):"123751cb591de26"!==l?(j.indexOf("@")!==-1&&(j='<a href="#'+this.require("designer").system().id()+"#models#"+a(j.replace("@",""))+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+j.replace("@","")+"</a>"),g=g+'<div class="list-group-item" style="text-align: left">+ <a href="#'+this.require("designer").system().id()+"#behaviors#"+this.document()._name+"#"+d+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+d+"</a>"+o+"</div>"):g=g+'<div class="list-group-item" style="text-align: left">+ '+d+o+"</div>";break;case d.indexOf("_")!==-1:break;default:j="undefined","undefined"!=typeof i.result?(j=i.result,"123751cb591de26"!==l?(j.indexOf("@")!==-1&&(j='<a href="#'+this.require("designer").system().id()+"#models#"+a(j.replace("@",""))+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+j.replace("@","")+"</a>"),g=g+'<div class="list-group-item" style="text-align: left">+ <a href="#'+this.require("designer").system().id()+"#behaviors#"+this.document()._name+"#"+d+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+d+"</a>() : "+j+"</div>"):g=g+'<div class="list-group-item" style="text-align: left">+ '+d+"() : "+j+"</div>"):"123751cb591de26"!==l?(j.indexOf("@")!==-1&&(j='<a href="#'+this.require("designer").system().id()+"#models#"+a(j.replace("@",""))+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+j.replace("@","")+"</a>"),g=g+'<div class="list-group-item" style="text-align: left">+ <a href="#'+this.require("designer").system().id()+"#behaviors#"+this.document()._name+"#"+d+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+d+"</a>()</div>"):g=g+'<div class="list-group-item" style="text-align: left">+ '+d+"()</div>"}""===e&&(e+='<a class="list-group-item" style="text-align: left"><br/></a>'),""===g&&(g+='<a class="list-group-item" style="text-align: left"><br/></a>'),m=this.require("model-class.html"),document.querySelector("#designer-workspace").insertAdjacentHTML("afterbegin",m.source().replace(/{{title}}/gi,this.title()).replace(/{{_id}}/gi,l).replace(/{{attributes}}/gi,e).replace(/{{collections}}/gi,f).replace(/{{methods}}/gi,g).replace(/{{events}}/gi,h)),this.editable()?(b=document.getElementById("designer-model-"+l).children[0].children[1],b&&b.addEventListener("click",function(a){this.require("designer").open("model.html#"+c.uuid()+"#"+n)}.bind(this)),b=document.getElementById("designer-model-"+l+"-export"),b&&b.addEventListener("click",function(a){var b={name:"model "+this.document()._name,master:!1,subsystem:!0,version:"0.0.1",description:"Model "+this.document()._name,schemas:{},models:{},behaviors:{},types:{},components:{}};b.name=b.name.trim(),b.name=b.name.replace(/ /gi,"-"),b.name=b.name.toLocaleLowerCase(),b.models[this.document()._id]=this.document(),this.require("designer").saveAs(b,"model."+this.document()._name.replace(/ /gi,"-").toLowerCase()+".json")}.bind(this)),b=document.getElementById("designer-model-"+l+"-edit"),b&&b.addEventListener("click",function(a){this.require("designer").open("model.html#"+c.uuid()+"#"+n)}.bind(this))):($("#designer-model-"+l+" > div > div > div > button").hide(),b=document.getElementById("designer-model-"+l).children[0].children[1],b&&b.addEventListener("click",function(a){var b=null;"RuntimeComponent"!==this.title()?this.require("designer").system().models()[c.uuid()]?this.require("designer").open("index.html#"+this.require("designer").system().id()+"#models#"+c.uuid(),"_self"):this.require("message").warning("Your schema ‘"+c.title()+"’ has not been yet created."):(b=this.require("DialogRuntimeComponentInfo"),b=new b({title:"RuntimeComponent model"}),b.show())}.bind(this)))}),w.on("hide",function(){$("#designer-class-"+this.uuid()).hide()}),w.on("show",function(){$("#designer-class-"+this.uuid()).show()});var x=this.require("ModelBehavior");x.on("render",function(){var a="",b=null,c=this,d="";d=this.require("designer").system().id(),a=this.require("model-behavior.html"),document.querySelector("#designer-workspace").insertAdjacentHTML("afterbegin",a.source().replace(/{{_id}}/gi,this.uuid()).replace(/{{title}}/gi,this.title()).replace(/{{content}}/gi,this.content())),b=document.getElementById("designer-behavior-"+this.uuid()).children[0].children[1],b&&b.addEventListener("click",function(a){this.require("designer").open("behavior.html#"+c.uuid()+"#"+d+"#action")}.bind(this)),b=document.getElementById("designer-behavior-"+this.uuid()+"-edit"),b&&b.addEventListener("click",function(a){this.require("designer").open("behavior.html#"+c.uuid()+"#"+d+"#action")}.bind(this)),b=document.getElementById("designer-behavior-"+this.uuid()+"-export"),b&&b.addEventListener("click",function(a){var b=this.document().state,c="",d={name:"behavior "+b,master:!1,subsystem:!0,version:"0.0.1",description:"Behavior "+b,schemas:{},models:{},behaviors:{},types:{},components:{}};d.name=d.name.trim(),d.name=d.name.replace(/ /gi,"-"),d.name=d.name.toLocaleLowerCase(),d.behaviors[this.document()._id]=this.document(),c=this.document().component===this.require("designer").system().id()?"behavior."+this.require("designer").system().name()+"."+b.replace(/ /gi,"-").toLowerCase()+".json":"behavior."+this.document().component+"."+b.replace(/ /gi,"-").toLowerCase()+".json",this.require("designer").saveAs(d,c)}.bind(this)),b=document.getElementById("designer-behavior-"+this.uuid()+"-delete"),b&&b.addEventListener("click",function(a){var b=this.require("designer");behaviors=b.system().behaviors(),delete behaviors[this.uuid()],b.system().behaviors(behaviors),$("#designer-behavior-"+this.uuid()).fadeOut(400,function(){$(this).remove()}),this.require("channel").$designerDeleteBehavior(this.uuid()),this.destroy(),b.save()}.bind(this))}),x.on("hide",function(){$("#designer-behavior-"+this.uuid()).hide()}),x.on("show",function(){$("#designer-behavior-"+this.uuid()).show()});var y=this.require("ModelComponent");y.on("render",function(){function a(a){var b="",c="";for(c in h.require("designer").system().schemas())if(h.require("designer").system().schemas()[c]._name===a){b=h.require("designer").system().schemas()[c];break}return b}function b(a){var b="",c="";for(c in h.require("designer").system().models())if(h.require("designer").system().models()[c]._name===a){b=h.require("designer").system().models()[c];break}return b}function c(a){var b="",c="",d="";for(c in h.require("designer").system().components())for(d in h.require("designer").system().components()[c])if(d===a){b=c;break}return b}function d(a){var b=model[i].type[0].replace("@","");h.require("designer").system().components();"RuntimeComponent"===b&&(b=c(a)),m=m+'<a href="#'+runtime.require("designer").system().id()+"#components#"+b+"#"+a+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+a+"</a>,<br>"}var e=null,f=null,g="",h=this,i="",j="",k="",l="",m="",n="",o=null;l=this.require("designer").system().id(),o=a(this.model()),model=b(this.model());for(i in this.document())if(this.document().hasOwnProperty(i)&&"_id"!==i)switch(j=this.document()[i],k=JSON.stringify(j),!0){case"link"===o[i]:"string"==typeof j?(n=model[i].type.replace("@",""),"RuntimeComponent"===n&&(n=c(j)),g=g+"<tr><td>"+i+'</td><td><a href="#'+this.require("designer").system().id()+"#components#"+n+"#"+j+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+j+"</a></td></tr>"):g=g+"<tr><td>"+i+"</td><td>"+k+"</td></tr>";break;case"collection"===o[i]:Array.isArray(j)&&model[i].type[0].indexOf("@")!==-1?(j.forEach(d),g=g+"<tr><td>"+i+"</td><td>["+m+"]</td></tr>",g=g.replace(",<br>]","]")):g=k.length<25?g+"<tr><td>"+i+"</td><td>"+k+"</td></tr>":g+"<tr><td>"+i+"</td><td>"+k.substring(0,25)+" ...</td></tr>";break;default:g=k.length<25?"string"==typeof j?g+"<tr><td>"+i+"</td><td>"+j+"</td></tr>":g+"<tr><td>"+i+"</td><td>"+k+"</td></tr>":"string"==typeof j?g+"<tr><td>"+i+"</td><td>"+j.substring(0,25)+" ...</td></tr>":g+"<tr><td>"+i+"</td><td>"+k.substring(0,25)+" ...</td></tr>"}""===g&&(g+="<tr><td><br/><br/></td><td><br/><br/></td></tr>"),e=this.require("model-component.html"),document.querySelector("#designer-workspace").insertAdjacentHTML("afterbegin",e.source().replace(/{{title}}/gi,this.title()).replace(/{{_id}}/gi,this.uuid().replace(/\./g,"-")).replace(/{{content}}/gi,g)),f=document.getElementById("designer-component-"+this.uuid().replace(/\./g,"-")).children[0].children[1],f&&f.addEventListener("click",function(a){this.require("designer").open("component.html#"+encodeURIComponent(h.title())+"#"+encodeURIComponent(h.model())+"#"+l)}.bind(this)),f=document.getElementById("designer-component-"+this.uuid().replace(/\./g,"-")+"-edit"),f&&f.addEventListener("click",function(a){this.require("designer").open("component.html#"+encodeURIComponent(h.title())+"#"+encodeURIComponent(h.model())+"#"+l)}.bind(this)),f=document.getElementById("designer-component-"+this.uuid().replace(/\./g,"-")+"-export"),f&&f.addEventListener("click",function(a){var b=this.document()._id,c={name:"component "+b,master:!1,subsystem:!0,version:"0.0.1",description:"Component "+b,schemas:{},models:{},behaviors:{},types:{},components:{}};c.name=c.name.trim(),c.name=c.name.replace(/ /gi,"-"),c.name=c.name.toLocaleLowerCase(),c.models[this.model()],c.components[this.model()]={},c.components[this.model()][this.document()._id]=this.document(),this.require("designer").saveAs(c,"component."+b.replace(/ /gi,"-").toLowerCase()+".json")}.bind(this)),f=document.getElementById("designer-component-"+this.uuid().replace(/\./g,"-")+"-delete"),f&&f.addEventListener("click",function(a){var b=this.require("designer"),c=b.system().components();delete c[this.model()][this.uuid()],b.system().components(c),$("#designer-component-"+this.uuid().replace(/\./g,"-")).fadeOut(400,function(){$(this).remove()}),this.require("channel").$designerDeleteComponent(this.uuid(),this.model()),this.destroy(),b.save()}.bind(this))}),y.on("hide",function(){$("#designer-component-"+this.uuid()).hide()}),y.on("show",function(){$("#designer-component-"+this.uuid()).show()});var z=this.require("ModelLog");z.on("render",function(){var a=null,b="";htmlComp=this.require("model-log.html"),this.require("designer").logs().forEach(function(a){switch(a.type()){case"debug":b=b+'<p class="text-muted">'+a.log()+"</p>";break;case"info":b=b+'<p class="text-info">'+a.log()+"</p>";break;case"warn":b=b+'<p class="text-warning">'+a.log()+"</p>";break;case"error":b=b+'<p class="text-danger">'+a.log()+"</p>"}}),document.querySelector("#designer-workspace").insertAdjacentHTML("afterbegin",htmlComp.source().replace("{{logs}}",b)),a=document.getElementById("designer-log-clean"),a.addEventListener("click",function(a){this.require("designer").logs().forEach(function(a){this.logs().pop()}.bind(this.require("designer"))),document.querySelector("#designer-loug-output").innerHTML=""}.bind(this))}),z.on("hide",function(){$("#designer-log").hide()}),z.on("show",function(){$("#designer-log").show()});var A=this.require("MenuBar");A.on("init",function(a){var b=[],c=[],d=[],e=this;b=this.require("db").collections().MenuHeader.find({type:"designer"}),this.header(this.require(b[0]._id)),c=this.require("db").collections().MenuItem.find({type:"designer"}),c.sort(function(a,b){return a.position>b.position?1:a.position<b.position?-1:0}),c.forEach(function(a){var b=a._id;e.items().push(e.require(b))}),d=this.require("db").collections().MenuAction.find({type:"designer"}),d.sort(function(a,b){return a.position>b.position?1:a.position<b.position?-1:0}),d.forEach(function(a){var b=a._id;e.actions().push(e.require(b))})}),A.on("render",function(){function a(){var a=0,b=0,c=null;for(a=f.children.length,b=0;b<a;b++)c=f.children[b],$(c).removeClass("active")}var b=0,c=0,d=null,e=document.getElementById("designer-menubar-header"),f=document.getElementById("designer-menubar-items"),g=document.getElementById("designer-menubar-actions"),h=this,i=window.location.href.split("#"),j=window.location.href.split("?messages="),k=[],l="system",m="",n=this.require("designer");e.insertAdjacentHTML("afterbegin",this.header().html().source()),this.items().forEach(function(a){f.insertAdjacentHTML("beforeend","<li>"+a.html().source()+"</>")});var o=function(){a(),$(this).addClass("active")};for(b=f.children.length,c=0;c<b;c++)d=f.children[c],d.addEventListener("click",o),d.addEventListener("click",function(){this.click()}.bind(h.items(c)));for(this.actions().forEach(function(a){g.insertAdjacentHTML("afterbegin","<li>"+a.html().source()+"</>")}),i.length>2&&0!==i[2].length&&(l=i[2],l=l.split("?")[0]),i.length>3&&(m=i[3],m=m.split("?")[0]),i.length>4&&n.state().component(i[4].split("?")[0]),c=0;c<b;c++)this.items(c).name()===l&&(d=f.children[c],$(d).addClass("active"));m&&n.space(m),n.context(l);var p=this;$("#designer-menu-action-search").on("keyup",function(a){var b=$("#designer-menu-action-search").val();p.designer().filter(b)}),n.updateRouter(),j[1]&&(k=JSON.parse(decodeURIComponent(j[1])),n.messages(k))});var B=this.require("ToolBar");B.on("init",function(a){var b=[],c=this;b=this.require("db").collections().ToolBarItem.find({type:"designer"}),b.sort(function(a,b){return a.position>b.position?1:a.position<b.position?-1:0}),b.forEach(function(a){var b=a._id;c.items().push(c.require(b))})}),B.on("render",function(){var a=document.getElementById("designer-toolbar-items"),b=0,c=0,d=null,e=this;for(this.items().forEach(function(b){a.insertAdjacentHTML("beforeend","<li>"+b.html().source()+"</>")}),c=a.children.length,b=0;b<c;b++)d=a.children[b],d.addEventListener("click",function(a){2!==a.detail&&this.click()}.bind(e.items(b)))});var C=this.require("Spaces");C.on("init",function(a){}),C.on("clear",function(){this.require("designer").space(""),$("#designer-spaces-items").empty()}),C.on("render",function(){function a(){var a=0,b=0,c=null;for(a=i.children.length,b=0;b<a;b++)c=i.children[b],$(c).removeClass("active")}function b(a,b){var c="",d="";for(d in b)if("undefined"!=typeof b[d][a]){c=d;break}return c}var c=null,d=this.designer().system(),e=this.require("SpaceItem"),f=null,g="",h="",i=document.getElementById("designer-spaces-items"),j=document.getElementById("designer-spaces-system-items"),k=document.getElementById("designer-spaces-components-items"),l=this,m="",n=null,o=[],p=!1,q="";switch($("#designer-spaces-help").empty(),this.designer().context()){case"system":$("#designer-spaces-spaces-system").hide(),$("#designer-spaces-spaces-components").hide(),document.getElementById("designer-spaces-type").innerHTML="Systems",document.getElementById("designer-spaces-help").insertAdjacentHTML("beforeend",this.require("help-system.html").source());break;case"schemas":$("#designer-spaces-spaces-system").hide(),$("#designer-spaces-spaces-components").hide(),document.getElementById("designer-spaces-type").innerHTML="Schemas",document.getElementById("designer-spaces-help").insertAdjacentHTML("beforeend",this.require("help-schemas.html").source());break;case"models":$("#designer-spaces-spaces-system").hide(),$("#designer-spaces-spaces-components").hide(),document.getElementById("designer-spaces-type").innerHTML="Models",document.getElementById("designer-spaces-help").insertAdjacentHTML("beforeend",this.require("help-models.html").source());break;case"types":$("#designer-spaces-spaces-system").hide(),$("#designer-spaces-spaces-components").hide(),document.getElementById("designer-spaces-type").innerHTML="Types",document.getElementById("designer-spaces-help").insertAdjacentHTML("beforeend",this.require("help-types.html").source());break;case"behaviors":$("#designer-spaces-spaces-system").show(),$("#designer-spaces-spaces-components").show(),document.getElementById("designer-spaces-type").innerHTML="Models",document.getElementById("designer-spaces-system-header").innerHTML="System",document.getElementById("designer-spaces-components-header").innerHTML="Components",document.getElementById("designer-spaces-help").insertAdjacentHTML("beforeend",this.require("help-behaviors.html").source());break;case"components":$("#designer-spaces-spaces-system").hide(),$("#designer-spaces-spaces-components").hide(),document.getElementById("designer-spaces-type").innerHTML="Models",document.getElementById("designer-spaces-help").insertAdjacentHTML("beforeend",this.require("help-components.html").source());break;case"logs":$("#designer-spaces-spaces-system").hide(),$("#designer-spaces-spaces-components").hide(),document.getElementById("designer-spaces-type").innerHTML="Logs",document.getElementById("designer-spaces-help").insertAdjacentHTML("beforeend",this.require("help-logs.html").source())}if($("#designer-spaces-items").empty(),$("#designer-spaces-system-items").empty(),$("#designer-spaces-components-items").empty(),d)switch(this.designer().context()){case"system":this.items().forEach(function(a){this.items().pop()}.bind(this));var r=this.require("storage").get("system-designer-systems"),s=[],t=0,u=0;for(r&&(s=r.systems),t=s.length,u=0;u<t;u++)d=this.require("storage").get(s[u]),f=new e({name:d.name,uuid:d._id}),this.items().push(f);for(this.items().sort(function(a,b){var c=runtime.require(a),d=runtime.require(b),e=0;return c.name()>d.name()&&(e=1),c.name()<d.name()&&(e=-1),e}),this.items().forEach(function(a){i.insertAdjacentHTML("beforeend",'<li id="designer-space-'+a.name()+'" class=""><a href="#'+a.uuid()+"#system#"+a.name()+'">'+a.name()+"</a></li>")}),n=function(){a(),$(this).addClass("active")},t=i.children.length,u=0;u<t;u++)c=i.children[u],c.addEventListener("click",n),c.addEventListener("click",function(){this.click()}.bind(l.items(u)));this.items().forEach(function(a){a.on("click",function(){var a=this.require("designer"),b=this.require("storage").get(this.uuid()),c=this.require("System");b&&a.system(new c(b)),a.logs().forEach(function(a){this.logs().pop()}.bind(a))})}),t>0&&($("#designer-space-"+this.require("designer").space()).length?$("#designer-space-"+this.require("designer").space()).addClass("active"):this.require("designer").system()?$("#designer-space-"+this.require("designer").system().name()).length&&($("#designer-space-"+this.require("designer").system().name()).addClass("active"),this.require("designer").space(this.require("designer").system().name())):(c=i.children[0],$(c).addClass("active"),this.require("designer").space(this.items(0).name())));break;case"schemas":this.items().forEach(function(a){this.items().pop()}.bind(this));for(m in d.schemas())f=new e({name:d.schemas()[m]._name,uuid:m}),this.items().push(f);for(this.items().sort(function(a,b){var c=runtime.require(a),d=runtime.require(b),e=0;return c.name()>d.name()&&(e=1),c.name()<d.name()&&(e=-1),e}),this.items().forEach(function(a){i.insertAdjacentHTML("beforeend",'<li id="designer-space-'+a.uuid()+'" class=""><a href="#'+d.id()+"#schemas#"+a.uuid()+'">'+a.name()+"</a></li>")}),n=function(){a(),$(this).addClass("active")},t=i.children.length,u=0;u<t;u++)c=i.children[u],c.addEventListener("click",n),c.addEventListener("click",function(){this.click()}.bind(l.items(u)));t>0?$("#designer-space-"+this.require("designer").space()).length?$("#designer-space-"+this.require("designer").space()).addClass("active"):(c=i.children[0],$(c).addClass("active"),this.require("designer").space(this.items(0).uuid())):this.require("designer").space("");break;case"models":this.items().forEach(function(a){this.items().pop()}.bind(this));for(m in d.models())f=new e({name:d.models()[m]._name,uuid:m}),this.items().push(f);for(this.items().sort(function(a,b){var c=runtime.require(a),d=runtime.require(b),e=0;return c.name()>d.name()&&(e=1),c.name()<d.name()&&(e=-1),e}),this.items().forEach(function(a){i.insertAdjacentHTML("beforeend",'<li id="designer-space-'+a.uuid()+'" class=""><a href="#'+d.id()+"#models#"+a.uuid()+'">'+a.name()+"</a></li>")}),n=function(){a(),$(this).addClass("active")},t=i.children.length,u=0;u<t;u++)c=i.children[u],c.addEventListener("click",n),c.addEventListener("click",function(){this.click()}.bind(l.items(u)));t>0?$("#designer-space-"+this.require("designer").space()).length?$("#designer-space-"+this.require("designer").space()).addClass("active"):(c=i.children[0],$(c).addClass("active"),this.require("designer").space(this.items(0).uuid())):this.require("designer").space("");break;case"types":this.items().forEach(function(a){this.items().pop()}.bind(this));for(m in d.types())f=new e({name:m}),this.items().push(f);for(this.items().sort(function(a,b){var c=runtime.require(a),d=runtime.require(b),e=0;return c.name()>d.name()&&(e=1),c.name()<d.name()&&(e=-1),e}),this.items().forEach(function(a){i.insertAdjacentHTML("beforeend",'<li id="designer-space-'+a.name()+'" class=""><a href="#'+d.id()+"#types#"+a.name()+'">'+a.name()+"</a></li>")}),n=function(){a(),$(this).addClass("active")},t=i.children.length,u=0;u<t;u++)c=i.children[u],c.addEventListener("click",n),c.addEventListener("click",function(){this.click()}.bind(l.items(u)));t>0&&($("#designer-space-"+this.require("designer").space()).length?$("#designer-space-"+this.require("designer").space()).addClass("active"):(c=i.children[0],$(c).addClass("active"),this.require("designer").space(this.items(0).name())));break;case"behaviors":this.items().forEach(function(a){this.items().pop()}.bind(this));for(m in d.models())f=new e({name:d.models()[m]._name,uuid:m}),this.items().push(f);for(this.items().sort(function(a,b){var c=runtime.require(a),d=runtime.require(b),e=0;return c.name()<d.name()&&(e=1),c.name()>d.name()&&(e=-1),e}),this.items().reverse(),this.items().forEach(function(a){o.push(a.name()),i.insertAdjacentHTML("beforeend",'<li id="designer-space-'+a.name()+'" class=""><a href="#'+d.id()+"#behaviors#"+a.name()+'">'+a.name()+"</a></li>")}),n=function(){a(),$(this).addClass("active")},t=i.children.length,u=0;u<t;u++)c=i.children[u],c.addEventListener("click",n),c.addEventListener("click",function(){this.click()}.bind(l.items(u)));for(this.systems().forEach(function(a){this.systems().pop()}.bind(this)),this.systems().sort(function(a,b){var c=runtime.require(a),d=runtime.require(b),e=0;return c.name()<d.name()&&(e=1),c.name()>d.name()&&(e=-1),e}),this.require("storage").get("system-designer-systems")&&this.require("storage").get("system-designer-systems").systems.length&&(f=new e({name:this.require("designer").system().name(),uuid:this.require("designer").system().id()}),this.systems().push(f)),this.systems().reverse(),this.systems().forEach(function(a){j.insertAdjacentHTML("beforeend",'<li id="designer-space-'+a.name()+'" class=""><a href="#'+d.id()+"#behaviors#"+a.name()+'">'+a.name()+"</a></li>")}),n=function(){a(),$(this).addClass("active")},t=j.children.length,u=0;u<t;u++)c=j.children[u],c.addEventListener("click",n),c.addEventListener("click",function(){this.click()}.bind(l.systems(u)));if(g=this.designer().space(),o.indexOf(g)!==-1?(p=!0,q=g):(q=b(g,this.designer().system().components()),q&&(p=!0)),p){this.components().forEach(function(a){this.components().pop()}.bind(this));for(h in d.components()[q])f=new e({name:h,uuid:h}),this.components().push(f);for(this.components().sort(function(a,b){var c=runtime.require(a),d=runtime.require(b),e=0;return c.name()<d.name()&&(e=1),c.name()>d.name()&&(e=-1),e}),this.components().reverse(),this.components().forEach(function(a){o.push(a.name()),k.insertAdjacentHTML("beforeend",'<li id="designer-space-'+a.name().replace(/\./g,"-")+'" class=""><a href="#'+d.id()+"#behaviors#"+a.name()+'">'+a.name()+"</a></li>")}),n=function(){a(),$(this).addClass("active")},t=k.children.length,u=0;u<t;u++)c=k.children[u],c.addEventListener("click",n),c.addEventListener("click",function(){this.click()}.bind(l.components(u)))}this.items().length>0&&$("#designer-space-"+this.require("designer").space().replace(/\./g,"-")).length?$("#designer-space-"+this.require("designer").space().replace(/\./g,"-")).addClass("active"):(c=j.children[0],$(c).addClass("active"),this.require("designer").space(this.systems(0).name()));break;case"components":this.items().forEach(function(a){this.items().pop()}.bind(this));for(m in d.models())f=new e({name:d.models()[m]._name,uuid:m}),this.items().push(f);for(this.items().sort(function(a,b){var c=runtime.require(a),d=runtime.require(b),e=0;
return c.name()>d.name()&&(e=1),c.name()<d.name()&&(e=-1),e}),this.items().forEach(function(a){i.insertAdjacentHTML("beforeend",'<li id="designer-space-'+a.name()+'" class=""><a href="#'+d.id()+"#components#"+a.name()+'">'+a.name()+"</a></li>")}),n=function(){a(),$(this).addClass("active")},t=i.children.length,u=0;u<t;u++)c=i.children[u],c.addEventListener("click",n),c.addEventListener("click",function(){this.click()}.bind(l.items(u)));t>0&&($("#designer-space-"+this.require("designer").space()).length?$("#designer-space-"+this.require("designer").space()).addClass("active"):(c=i.children[0],$(c).addClass("active"),this.require("designer").space(this.items(0).name())));break;case"logs":i.insertAdjacentHTML("beforeend",'<li class="active"><a href="#'+d.id()+'#logs">Console output</a></li>')}});var D=this.require("Workspace");D.on("init",function(a){var b=this;$("html").on("dragenter dragover",!1).on("drop",function(a){a.stopPropagation(),a.preventDefault();var c=a.originalEvent.dataTransfer.files,d=new FileReader,e="";d.onload=function(a){e+=a.target.result},d.onloadend=function(){var a=JSON.parse(e),c=b.require("DialogDropFile");c=new c(b.require("designer").system()?{title:"A system has been found",message:"You can import the system or compose it with the current system."}:{title:"A system has been found",message:"You can import the system."}),c.data(a),c.show()},d.readAsText(c[0],"UTF-8")})}),D.on("create",function(){function a(a){var b="",c="";for(c in f.system().models())if(f.system().models()[c]._name===a){b=c;break}return b}var b="",c=null,d=null,e=this.require("designer").system();switch(this.designer().context()){case"system":c=this.require("DialogSystemCreation"),d=new c({title:"Create a new system"}),d.show(),d.on("ok",function(){function a(a){var b=runtime.require("storage").get("system-designer-systems"),c=[],d=/[\#\&\(\)\[\]\'\"\*\,\;\:\%]/i,e=0,g=!0;for(b&&(c=b.systems),length=c.length,e=0;e<length;e++)if(f=runtime.require("storage").get(c[e]),f.name===a){g=!1;break}return g=g&&null===a.match(d)}var b=this.require("designer"),c=null,d="",e="",f={},g=this.require("System"),h=null,i=null;c=$("#designer-dialog-system-creation-name").val(),c=c.trim(),c=c.replace(/ /gi,"-"),c&&a(c)&&(d=b.generateId(),e=b.generateId(),f={name:c,master:!0,subsystem:!1,version:"0.0.1",description:"",schemas:{},models:{},behaviors:{},types:{},components:{},_id:d},f.behaviors[e]={_id:e,component:d,state:"start",action:"function start() { \n\t\n}",useCoreAPI:!1,core:!1},b.system()&&b.system().destroy(),b.system(new g(f)),h=this.require("ModelSystem"),i=new h({title:c}),i.uuid=d,i.document(JSON.parse(JSON.stringify(f))),i.content(JSON.stringify(f)),b.save(),this.hide(),b.space(c),b.spaces().render(),b.workspace().refresh(),this.require("message").success("System created. You can now begin to create schemas."))});break;case"schemas":e&&Object.keys(e).length&&(c=this.require("DialogSchemaCreation"),d=new c({title:"Create a new schema"}),d.show(),d.on("ok",function(){function a(a){var b=!0,c=/[\#\&\(\)\[\]\'\"\*\,\;\:\%]/i,d="";for(d in runtime.require("designer").system().schemas())if(runtime.require("designer").system().schemas()[d]._name===a){b=!1;break}return runtime.require("designer").system().name()===a&&(b=!1),b=b&&null===a.match(c)}var c=this.require("designer"),d=null,e={},f={},g=null,h=null;d=$("#designer-dialog-schema-creation-name").val(),d=d.trim(),d=d.replace(/ /gi,"_"),d&&a(d)&&(b=c.generateId().toString(),e={_id:b,_name:d,_inherit:["RuntimeComponent"]},f=c.system().schemas(),f[b]=e,c.system().schemas(f),g=this.require("ModelSchema"),h=new g({title:d}),h.document(JSON.parse(JSON.stringify(e))),h.content(JSON.stringify(e)),h.uuid(b),c.save(),c.createModel(e),this.require("channel").$designerCreateSchema(d,e),this.hide(),c.space(b),c.spaces().render(),c.workspace().refresh(),c.updateRouter(),this.require("message").success("Schema created. A model has been also generated."))}));break;case"models":e&&Object.keys(e).length&&(c=this.require("DialogModelCreation"),d=new c({title:"Create a new model"}),d.show(),d.on("ok",function(){this.hide()}));break;case"types":e&&Object.keys(e).length&&(c=this.require("DialogTypeCreation"),d=new c({title:"Create a new type"}),d.show(),d.on("ok",function(){var a=this.require("designer"),b=null,c=!1,d={},e=a.system().types(),f=null,g=null,h="";b=$("#designer-dialog-type-creation-name").val(),c=$("#designer-dialog-type-creation-isEnum")[0].checked,b=b.trim(),b=b.replace(/ /gi,"_"),b&&(h=a.generateId().toString(),d=c?{_id:h,name:b,type:"any",value:["value1","value2"]}:{_id:h,name:b,type:"object",schema:{property1:{type:"any",mandatory:!1,default:""},property2:{type:"any",mandatory:!1,default:""}}},e[b]=d,a.system().types(e),f=this.require("ModelType"),g=new f({title:b}),g.uuid=b,g.document(JSON.parse(JSON.stringify(d))),g.content(JSON.stringify(d)),a.save(),this.require("channel").$designerCreateType(b,d),this.hide(),a.space(b),a.spaces().render(),a.workspace().refresh(),this.require("message").success("Type created. You can use it in your model."))}));break;case"components":if(e&&Object.keys(e).length){var f=this.require("designer"),g=(f.system().schemas(),f.system().models(),f.system().components()),h={},i=null,j=null,k="",l="",m="",n=null,o=null;if(k=a(f.space()),l=f.space(),o=f.getGeneratedSchema(l),Object.keys(o).length){m=f.generateId(),h={_id:m};var p=[];for(var q in o)"property"===o[q]&&p.push(q),"link"===o[q]&&p.push(q),"collection"===o[q]&&p.push(q);p.sort(),n=f.getGeneratedModel(l),length=p.length;for(var r=0;r<length;r++)n&&n[p[r]]&&(h[p[r]]=n[p[r]].default);g[l]||(g[l]={}),g[l][m]=h,f.system().components(g),i=this.require("ModelComponent"),j=new i({title:m}),j.model(l),j.uuid(m.toString()),j.document(JSON.parse(JSON.stringify(h))),j.content(JSON.stringify(h)),j.render(),$("#designer-component-"+m.toString()).hide(),$("#designer-component-"+m.toString()).fadeIn(1e3),f.save(),this.require("channel").$designerCreateComponent(l,h)}else this.require("message").warning("There is no schema. Create a schema before creating a component.")}break;case"behaviors":e&&Object.keys(e).length&&(c=this.require("DialogBehaviorCreation"),d=new c({title:"Create a new behavior"}),d.show(),d.on("ok",function(){function a(a){var b="",c="";for(c in g.system().schemas())if(g.system().schemas()[c]._name===a){b=c;break}return b}function c(a){var b="",c="";for(c in g.system().models())if(g.system().models()[c]._name===a){b=c;break}return b}function d(a,c,d){var e=!1;if(f(c)){for(b in g.system().behaviors())if(g.system().behaviors()[b].state===a&&g.system().behaviors()[b].component===d){e=!0;break}}else for(b in g.system().behaviors())if(g.system().behaviors()[b].state===a&&g.system().behaviors()[b].component===c){e=!0;break}return e}function e(a){var b=a,c="";for(c in g.system().components())if("undefined"!=typeof g.system().components()[c][a]){b=c;break}return b}function f(a){var b=!1;return Object.keys(g.system().components()).indexOf(a)!==-1&&(b=!0),b}var g=this.require("designer"),h=g.system().schemas(),i=(g.system().models(),null),j=g.system().behaviors(),k=this.require("message"),l="",m="",n=null,o={},p="",q="\t\n",r=null,s=null,t="",u="",v="",w="",x=!0,y=0,z=0,A="";if(t=e(g.space()),u=$("#designer-dialog-behavior-creation-state").val(),A=g.space(),t&&u){if(v=g.generateId(),t!==g.system().name()){if(l=a(t),m=c(t),i=g.getGeneratedModel(t),i[u]&&(n=i[u].params),n&&n.length)for(z=n.length,y=0;y<z;y++)w=0===y?n[y].name:w+", "+n[y].name;if("property"!==h[l][u]&&"link"!==h[l][u]||(w="value"),"collection"===h[l][u]&&(w="value, type"),"method"===h[l][u]&&d(u,g.space(),t)&&(x=!1),"init"===u&&(w="conf",d(u,g.space(),t)&&(x=!1)),"destroy"===u&&d(u,g.space(),t)&&(x=!1),"error"===u&&(w="data",d(u,g.space(),t)&&(x=!1)),i[u]&&(p=i[u].result),p)switch(p){case"string":q="\tvar result = '';\n\treturn result;\n";break;case"array":q="\tvar result = [];\n\treturn result;\n";break;case"number":q="\tvar result = 0;\n\treturn result;\n";break;case"object":q="\tvar result = {};\n\treturn result;\n";break;default:q="\tvar result = {};\n\treturn result;\n"}}else A=g.system().id(),d(u,A,t)&&(x=!1);x?(o="destroy"!==u?{_id:v,component:A,state:u,action:"function "+u+"("+w+") { \n"+q+"}",useCoreAPI:!1,core:!1}:{_id:v,component:A,state:"destroy",action:"function destroy() { \n\n  // destroy the component\n  $component.destroy(this.id());\n}",useCoreAPI:!0,core:!1},j[v]=o,g.system().behaviors(j),r=this.require("ModelBehavior"),s=new r({uuid:v}),s.title(u),s.document(o),s.content(JSON.parse(JSON.stringify(o.action))),this.hide(),s.render(),Prism.highlightAll(),$("#designer-behavior-"+v.toString()).hide(),$("#designer-behavior-"+v.toString()).fadeIn(1e3),g.save(),this.require("channel").$designerCreateBehavior(o)):(this.hide(),k.warning("Can not create two behaviors for a method."))}}))}}),D.on("refresh",function(){function a(a){var b="",c="";for(c in s.schemas())if(s.schemas()[c]._name===a){b=c;break}return b}function b(a){var b="",c="";for(c in s.models())if(s.models()[c]._name===a){b=c;break}return b}var c=null,d=null,e=null,f=null,g=null,h=null,i="",j="",k="",l=null,m=null,n=null,o=null,p=null,q=null,r=null,s=this.designer().system(),t=this.designer().space(),u="",v=[],w=null,x=null,y=[],z=0,A=0,B=0;if(s){switch(this.clear(),window.scrollTo(0,0),B="system "+s.name(),B!==document.title&&(document.title=B),this.designer().context()){case"system":for(x=this.require("storage").get("system-designer-systems"),x&&(y=x.systems),A=y.length,z=0;z<A;z++)s=this.require("storage").get(y[z]),s.name===t&&(c=this.require("ModelSystem"),h=new c({title:s.name}),h.uuid(s._id),h.document(JSON.parse(JSON.stringify(s))),h.content(JSON.stringify(s)),h.render());""===t&&A>0&&this.require("message").warning("System not found.");break;case"schemas":if(t)for(j in s.schemas())if(s.schemas()[j]._id===t){for(d=this.require("ModelSchema"),v=[],s.schemas()[j]._inherit&&(w=s.schemas()[j]._inherit.slice(),w.reverse()),A=0,w&&(A=w.length),z=0;z<A;z++){if(u=a(w[z]),f=new d({title:w[z]}),"RuntimeComponent"===w[z]){u="111df11e2b19fde";var C={_id:"RuntimeComponent",_name:"RuntimeComponent",_core:!0,classInfo:"property",id:"property",destroy:"method",error:"event",init:"method",off:"method",on:"method",require:"method"};f.document(C),f.content(JSON.stringify(C)),v.push(u),f.uuid(u)}else s.schemas()[a(w[z])]?(f.document(JSON.parse(JSON.stringify(s.schemas()[a(w[z])]))),f.content(JSON.stringify(s.schemas()[a(w[z])])),v.push(a(w[z])),f.uuid(a(w[z]))):(v.push(w[z]),f.uuid(w[z]));f.render()}for(f=new d({title:s.schemas()[j]._name}),f.uuid(j),f.document(JSON.parse(JSON.stringify(s.schemas()[j]))),f.content(JSON.stringify(s.schemas()[j])),f.editable(!0),f.render(),A=v.length,z=0;z<A;z++)this.designer().linkModel(j,v[z])}break;case"models":if(t)for(j in s.models())if(s.models()[j]._id===t){for(e=this.require("ModelClass"),k=a(s.models()[j]._name),v=[],k&&s.schemas()[k]._inherit&&(w=s.schemas()[k]._inherit.slice(),w.reverse()),A=0,w&&(A=w.length),z=0;z<A;z++){if(u=a(w[z]),l=new e({title:w[z]}),"RuntimeComponent"===w[z]){u="123751cb591de26";var D={_name:"RuntimeComponent",_core:!0,classInfo:{type:"@RuntimeClassInfo",readOnly:!1,mandatory:!1,default:{}},id:{type:"string",readOnly:!0,mandatory:!1,default:""},destroy:{params:[]},error:{params:[{name:"data",type:"errorParam"}]},init:{params:[{name:"conf",type:"object"}]},off:{params:[{name:"state",type:"string"},{name:"behaviorId",type:"string",mandatory:!1}]},on:{params:[{name:"state",type:"string"},{name:"handler",type:"function"},{name:"useCoreAPI",type:"boolean",mandatory:!1},{name:"isCore",type:"boolean",mandatory:!1}],result:"string"},require:{params:[{name:"id",type:"string"}],result:"RuntimeComponent"}};l.document(D),l.content(JSON.stringify(D)),v.push(u),l.uuid(u)}else s.models()[b(w[z])]?(l.document(JSON.parse(JSON.stringify(s.models()[b(w[z])]))),l.content(JSON.stringify(s.models()[b(w[z])])),v.push(b(w[z])),l.uuid(b(w[z]))):(v.push(w[z]),l.uuid(u));l.render()}for(l=new e({title:s.models()[j]._name}),l.uuid(j),l.document(JSON.parse(JSON.stringify(s.models()[j]))),l.content(JSON.stringify(s.models()[j])),l.editable(!0),l.render(),A=v.length,z=0;z<A;z++)this.designer().linkModel(j,v[z])}break;case"types":if(t)for(i in s.types())s.types()[i].name===t&&(m=this.require("ModelType"),n=new m({title:i}),n.uuid(i),n.document(JSON.parse(JSON.stringify(s.types()[t]))),n.content(JSON.stringify(s.types()[t])),n.render());break;case"components":if(t)if(this.require("designer").state().component())i=this.require("designer").state().component(),s.components()[t][i]&&(o=this.require("ModelComponent"),p=new o({title:i}),p.uuid(i),p.model(t),p.document(JSON.parse(JSON.stringify(s.components()[t][i]))),p.content(JSON.stringify(s.components()[t][i])),p.render());else for(i in s.components()[t])o=this.require("ModelComponent"),p=new o({title:i}),p.uuid(i),p.model(t),p.document(JSON.parse(JSON.stringify(s.components()[t][i]))),p.content(JSON.stringify(s.components()[t][i])),p.render();break;case"behaviors":if(t){i=this.require("designer").state().component();for(j in s.behaviors())s.behaviors()[j].component===t&&(i&&s.behaviors()[j].state===i||""===i)&&(q=this.require("ModelBehavior"),r=new q({uuid:s.behaviors()[j]._id}),r.title(s.behaviors()[j].state),r.document(s.behaviors()[j]),r.content(JSON.parse(JSON.stringify(s.behaviors()[j].action))),r.render()),t===this.require("designer").system().name()&&s.behaviors()[j].component===this.require("designer").system().id()&&(q=this.require("ModelBehavior"),r=new q({uuid:s.behaviors()[j]._id}),r.title(s.behaviors()[j].state),r.document(s.behaviors()[j]),r.content(JSON.parse(JSON.stringify(s.behaviors()[j].action))),r.render());Prism.highlightAll()}break;case"logs":g=this.require("ModelLog"),modelLog=new g,modelLog.render()}this.designer().filter()&&this.designer().filter(this.designer().filter())}else document.title="System Designer",x=this.require("storage").get("system-designer-systems"),x&&x.systems&&x.systems.length&&this.require("message").warning("System not found.")}),D.on("clear",function(){$("#designer-workspace").empty(),jsPlumb.ready(function(){jsPlumb.deleteEveryEndpoint()})});var E=this.require("Server");E.on("start",function(){var a=null,b=null;a=this.require("RuntimeChannel"),b=new a({_id:"channel"}),b.on("send",function(a){if(0!==a.event.indexOf("$system")){var b=this.require("storage").get("system-designer-config");this.require("storage").set("system-designer-message",a),this.require("designer").debugWindow()&&this.require("designer").debugWindow().postMessage(JSON.stringify(a),"*"),"undefined"!=typeof b&&"undefined"!=typeof b.debugType&&"server"===b.debugType&&b.urlServer&&$.post(b.urlServer+":8888/"+a.event,encodeURIComponent(JSON.stringify(a.data)))}}),b.on("$appLogDebug",function(a){var b="",c=null;c=this.require("Log"),b=new c({type:"debug",log:a.replace("runtime:","").replace(/\[[^\]]+\]/,"<strong>debug:</strong> ")}),this.require("designer").logs().push(b),this.require("message").info(a.replace(/\[[^\]]+\]/,"<strong>runtime:</strong> "))}),b.on("$appLogInfo",function(a){var b="",c=null;c=this.require("Log"),b=new c({type:"info",log:a.replace("runtime:","").replace(/\[[^\]]+\]/,"<strong>info:</strong> ")}),this.require("designer").logs().push(b),this.require("message").info(a.replace(/\[[^\]]+\]/,"<strong>runtime:</strong> "))}),b.on("$appLogWarn",function(a){var b="",c=null;c=this.require("Log"),b=new c({type:"warn",log:a.replace("runtime:","").replace(/\[[^\]]+\]/,"<strong>warning:</strong> ")}),this.require("designer").logs().push(b),this.require("message").warning(a.replace(/\[[^\]]+\]/,"<strong>runtime:</strong> "))}),b.on("$appLogError",function(a){var b="",c=null;c=this.require("Log"),b=new c({type:"error",log:a.replace("runtime:","").replace(/\[[^\]]+\]/,"<strong>error:</strong> ")}),this.require("designer").logs().push(b),this.require("message").danger(a.replace(/\[[^\]]+\]/,"<strong>runtime:</strong> "))}),b.on("$editorUpdateType",function(a,b){var c=this.require("designer"),d=c.system().types();d[a]=b,c.system().types(d),c.save(),c.space(b.name),c.spaces().render(),c.workspace().refresh()}),b.on("$editorDeleteType",function(a){var b=this.require("designer"),c=b.system().types(),d=[],e=null;d=this.require("db").collections().ModelType.find({uuid:a}),d.length&&(e=this.require(d[0]._id),e&&(e.hide(),e.destroy())),delete c[a],b.system().types(c),b.save(),b.workspace().refresh()}),b.on("$editorUpdateSchemaName",function(a,b){function c(a,b){var c="",d="";for(d in b)if(b[d]._name===a){c=d;break}return c}var d=this.require("designer"),e=d.system().schemas()[b]._name,f=d.system().models(),g=d.system().behaviors(),h=d.system().components(),i="",j="";i=c(e,d.system().models()),f[i]._name=a,d.system().models(f);for(j in g)g[j].component===e&&(g[j].component=a,d.system().behaviors(g));h[e]&&(h[a]=JSON.parse(JSON.stringify(h[e])),delete h[e],d.system().components(h)),d.save()}),b.on("$editorUpdateSchema",function(a,b){var c=this.require("designer"),d=c.system().schemas(),e=null,f=null,g="";jsPlumb.deleteEveryEndpoint(),c.syncModel(b),d[a]=b,c.system().schemas(d),c.save(),e=c.system().models();for(g in e)e[g]._name!==b._name&&(f=e[g],c.syncComponent(f,!0));c.space(a),c.spaces().render(),c.workspace().refresh()}),b.on("$designerDeleteSchema",function(a){var b=this.require("designer"),c=b.system().schemas(),d=[],e=null;d=this.require("db").collections().ModelSchema.find({uuid:a}),d.length&&(e=this.require(d[0]._id),e&&(e.hide(),e.destroy())),delete c[a],b.system().schemas(c),b.save(),b.workspace().refresh()}),b.on("$editorUpdateSchemaId",function(a,b){var c=this.require("designer"),d=c.system().schemas(),e=null;e=JSON.parse(JSON.stringify(d[a])),delete d[a],e._id=b,d[b]=e,c.system().schemas(d),c.save(),c.workspace().refresh()}),b.on("$editorUpdateModel",function(a,b){var c=this.require("designer"),d=c.system().models();jsPlumb.deleteEveryEndpoint(),d[a]=b,c.system().models(d),c.save(),c.syncBehavior(b),c.space(a),c.spaces().render(),c.workspace().refresh()}),b.on("$editorUpdateModelId",function(a,b){var c=this.require("designer"),d=c.system().models(),e=null;e=JSON.parse(JSON.stringify(d[a])),delete d[a],e._id=b,d[b]=e,c.system().models(d),c.save(),c.workspace().refresh()}),b.on("$editorUpdateBehavior",function(a,b){var c=this.require("designer"),d=c.system().behaviors();d[a]=b,c.system().behaviors(d),c.save(),c.workspace().refresh()}),b.on("$editorDeleteBehavior",function(a){var b=this.require("designer"),c=b.system().behaviors(),d=[],e=null;d=this.require("db").collections().ModelBehavior.find({uuid:a}),d.length&&(e=this.require(d[0]._id),e&&(e.hide(),e.destroy())),delete c[a],b.system().behaviors(c),b.save(),b.workspace().refresh()}),b.on("$editorUpdateComponent",function(a,b,c){var d=this.require("designer"),e=d.system().components();e[b][a]=c,d.system().components(e),d.save(),d.workspace().refresh()}),b.on("$editorDeleteComponent",function(a,b){var c=this.require("designer"),d=c.system().components(),e=[],f=null;e=this.require("db").collections().ModelComponent.find({uuid:a}),e.length&&(f=this.require(e[0]._id),f&&(f.hide(),f.destroy())),delete d[b][a],c.system().components(d),c.save(),c.workspace().refresh()}),b.on("$editorUpdateSystem",function(a,b){var c=this.require("System"),d=null,e=this.require("designer");e.system()&&e.system().destroy(),d=new c(b),e.system(d),e.save(),e.space(b.name),e.spaces().render(),e.workspace().refresh()}),b.on("$appLoadSystem",function(a){var b=null,c=null;"app-designer-testing"!==a.name&&(b=this.require("DialogImport"),c=new b({title:"A system has been found",message:"Do you want to import the system ?",data:a}),c.show(),c.on("ok",function(){var a=this.require("System"),b=null,c=this.require("designer"),d=this.require("message");c.system()&&c.system().destroy(),b=new a(this.data()),c.system(b),c.logs().forEach(function(a){this.logs().pop()}.bind(c)),c.save(),c.space(b.name()),c.spaces().render(),c.workspace().refresh(),c.updateRouter(),this.hide(),c.save(),d.success("Importation of the system is done.")}))}),b.on("$runtimeCreateComponent",function(a,b){var c=this.require("designer"),d=c.system().components();"undefined"!=typeof d[a]&&(delete b.classInfo,d[a][b._id]=b,c.system().components(d),c.save(),"components"===c.context()&&c.workspace().refresh())}),b.on("$runtimeDeleteComponent",function(a,b){var c=this.require("designer"),d=c.system().components();"undefined"!=typeof d[b]&&(delete d[b][a],c.system().components(d),c.save(),"components"===c.context()&&c.workspace().refresh())}),b.on("$runtimeUpdateComponent",function(a,b,c,d){var e=this.require("designer"),f=e.system().components();"undefined"!=typeof f[b]&&"undefined"!==f[b][a]&&(f[b][a][c]=d,e.system().components(f),e.save(),"components"===e.context()&&e.workspace().refresh())}),window.addEventListener("message",function(a){var b=null,c=this.require("storage").get("system-designer-config");c||(c={}),b=JSON.parse(a.data),b&&"undefined"!=typeof b.event&&"undefined"!=typeof b.from&&"undefined"!=typeof b.data&&$db.RuntimeMessage.insert(b)}.bind(b),!1),this.require("storage").on("changed",function(a){"undefined"!=typeof a["system-designer-message"]&&(this.require("designer").debugWindow()&&this.require("designer").debugWindow().postMessage(JSON.stringify(a["system-designer-message"].newValue),"*"),$db.RuntimeMessage.insert(a["system-designer-message"].newValue))},!0)},!0);var F=this.require("Designer");F.on("check",function(){var a=null,b=null;"undefined"==typeof SharedWorker&&(a=this.require("DialogCheck"),b=new a({title:"Hem... You will laugh",message:"Your browser has not all the features to use correctly System Designer.<br><br>Please use:<br><br>- Mozilla Firefox (recommended) or <br>- Google Chrome (desktop only).<br><br>"}),b.show())}),F.on("logs",function(a,b){var c=null,d="";if("add"===b&&"logs"===this.context()){switch(c=this.require(a),c.type()){case"debug":d=d+'<p class="text-muted">'+c.log()+"</p>";break;case"info":d=d+'<p class="text-info">'+c.log()+"</p>";break;case"warn":d=d+'<p class="text-warning">'+c.log()+"</p>";break;case"error":d=d+'<p class="text-danger">'+c.log()+"</p>"}document.querySelector("#designer-loug-output").insertAdjacentHTML("afterbegin",d)}}),F.on("welcome",function(){var a=null,b=null,c=null;c=this.require("storage").get("system-designer-config"),c||(c={}),"undefined"==typeof c.welcomeScreen&&(a=this.require("DialogWelcome"),b=new a({title:"Welcome to System Designer"}),b.show(),b.on("ok",function(){var a=this.require("storage").get("system-designer-config");a||(a={}),a.welcomeScreen=!1,this.require("storage").set("system-designer-config",a),this.hide()}))}),F.on("render",function(){var a=null,b=null,c=null,d=null,e=null,f=null,g=null,h=null,i=null,j=null,k=null,l="",m=null,n=null;a=this.require("MenuBar"),b=new a({designer:this}),c=this.require("ToolBar"),d=new c({designer:this}),e=this.require("Workspace"),f=new e({designer:this}),i=this.require("Spaces"),j=new i({designer:this}),m=this.require("Server"),n=new m({designer:this}),this.menubar(b),this.toolbar(d),this.workspace(f),this.spaces(j),this.server(n),this.require("logger").on("warn",function(a){this.require("message").warning(a)}),this.require("logger").on("error",function(a){this.require("message").danger(a)}),g=this.require("DesignerState"),h=new g,this.state(h),k=this.require("System");var o=this.require("storage").get("system-designer-systems");switch(!0){case window.location.href.split("#").length>1&&window.location.href.split("#")[1].length>0:l=window.location.href.split("#")[1],this.require("storage").get(l)&&(this.system(new k(this.require("storage").get(l))),this.refresh());break;default:o&&o.systems&&o.systems.length&&o.systems[0].length&&this.system(new k(this.require("storage").get(o.systems[0]))),this.refresh()}this.welcome();var p=this;window.onhashchange=function(a){var b=window.location.href.split("#"),c="",d="system",e="",f=0,g=0,h=null,i=null;for(b.length>1&&(c=b[1],c=c.split("?")[0]),b.length>2&&(d=b[2],d=d.split("?")[0]),b.length>3&&(e=b[3],e=e.split("?")[0]),b.length>4?p.state().component(b[4].split("?")[0]):p.state().component(""),b.length>1&&c?p.system(new k(p.require("storage").get(c))):o&&o.systems&&o.systems.length&&p.system(new k(p.require("storage").get(o.systems[0]))),p.space(e),p.context(d),i=document.getElementById("designer-menubar-items"),g=p.menubar().items().length,f=0;f<g;f++)h=i.children[f],$(h).removeClass("active");for(f=0;f<g;f++)p.menubar().items(f).name()===d&&(h=i.children[f],$(h).addClass("active"));p.updateRouter()},$(window).resize(function(){jsPlumb.repaintEverything()}),this.menubar().render(),this.toolbar().render(),this.spaces().render(),$(function(){$('[data-toggle="tooltip"]').tooltip({container:"body",delay:{show:2e3,hide:100},trigger:"hover"})}),this.server().start(),this.runMessages(this.messages()),this.messages([])}),F.on("filter",function(a){var b=[],c="";switch(this.context()){case"behaviors":c="ModelBehavior";break;case"schemas":c="ModelSchema";break;case"types":c="ModelType";break;case"models":c="ModelClass";break;case"components":c="ModelComponent";break;case"system":c="ModelSystem"}for(var d=this.require("db").collections()[c].find({}),e=0;e<d.length;e++)b.push(this.require(d[e]._id));switch(a.length>0?b.forEach(function(b){b.content().toLowerCase().indexOf(a.toLowerCase())===-1?b.hide():b.show()}):b.forEach(function(a){a.show()}),this.context()){case"schemas":case"models":jsPlumb.repaintEverything()}}),F.on("context",function(a){jsPlumb.ready(function(){jsPlumb.deleteEveryEndpoint()}),this.spaces().render(),this.workspace().clear(),this.workspace().refresh()}),F.on("space",function(a){"system"===this.context()&&this.updateRouter()}),F.on("updateRouter",function(){function a(a,b){var c="",d="";for(d in b)if(b[d]._name===a){c=d;break}return c}function b(a,b){var c="",d="";for(d in b)if(b[d]._name===a){c=d;break}return c}function c(a,b){var c="",d="";for(d in b)if(d===a){c=b[a]._name;break}return c}function d(a,b){var c="",d="";for(d in b)if(d===a){c=b[a]._name;break}return c}function e(a){var b="";return 2===a.split("#").length&&(b=a.split("#")[1]),a.split("#").length>2&&(b=a.split("#")[2]),b=b.split("#")[0],b=b.trim()}var f=[],g=0,h=0,i="",j="",k="",l="",m="",n="",o="",p="";switch(k=this.require("designer").context(),l=this.require("designer").space(),k){case"schemas":if(this.require("designer").system())for(l&&(m=d(l,this.require("designer").system().schemas()),p=a(m,this.require("designer").system().models())),f=$("#designer-menubar-items > li > a"),h=f.length,g=0;g<h;g++)j=f[g].href,i=e(j),f[g].href="#"+this.require("designer").system().id()+"#"+i,"models"===i&&p&&(f[g].href=f[g].href+"#"+p),"components"===i&&m&&(f[g].href=f[g].href+"#"+m),"behaviors"===i&&m&&(f[g].href=f[g].href+"#"+m);else for(f=$("#designer-menubar-items > li > a"),h=f.length,g=0;g<h;g++)j=f[g].href,i=e(j),f[g].href="##"+i;break;case"models":if(this.require("designer").system())for(l&&(o=c(l,this.require("designer").system().models()),n=b(o,this.require("designer").system().schemas())),f=$("#designer-menubar-items > li > a"),h=f.length,g=0;g<h;g++)j=f[g].href,i=e(j),f[g].href="#"+this.require("designer").system().id()+"#"+i,"schemas"===i&&n&&(f[g].href=f[g].href+"#"+n),"components"===i&&o&&(f[g].href=f[g].href+"#"+o),"behaviors"===i&&o&&(f[g].href=f[g].href+"#"+o);else for(f=$("#designer-menubar-items > li > a"),h=f.length,g=0;g<h;g++)j=f[g].href,i=e(j),f[g].href="##"+i;break;case"behaviors":if(this.require("designer").system())for(l&&(p=a(l,this.require("designer").system().models()),n=b(l,this.require("designer").system().schemas()),m=d(n,this.require("designer").system().schemas())),f=$("#designer-menubar-items > li > a"),h=f.length,g=0;g<h;g++)j=f[g].href,i=e(j),f[g].href="#"+this.require("designer").system().id()+"#"+i,"schemas"===i&&n&&(f[g].href=f[g].href+"#"+n),"models"===i&&p&&(f[g].href=f[g].href+"#"+p),"components"===i&&p&&(f[g].href=f[g].href+"#"+m);else for(f=$("#designer-menubar-items > li > a"),h=f.length,g=0;g<h;g++)j=f[g].href,i=e(j),f[g].href="##"+i;break;case"components":if(this.require("designer").system())for(l&&(p=a(l,this.require("designer").system().models()),n=b(l,this.require("designer").system().schemas()),m=d(n,this.require("designer").system().schemas())),f=$("#designer-menubar-items > li > a"),h=f.length,g=0;g<h;g++)j=f[g].href,i=e(j),f[g].href="#"+this.require("designer").system().id()+"#"+i,"schemas"===i&&n&&(f[g].href=f[g].href+"#"+n),"models"===i&&p&&(f[g].href=f[g].href+"#"+p),"behaviors"===i&&p&&(f[g].href=f[g].href+"#"+m);else for(f=$("#designer-menubar-items > li > a"),h=f.length,g=0;g<h;g++)j=f[g].href,i=e(j),f[g].href="##"+i;break;default:if(this.require("designer").system())for(f=$("#designer-menubar-items > li > a"),h=f.length,g=0;g<h;g++)j=f[g].href,i=e(j),f[g].href="#"+this.require("designer").system().id()+"#"+i;else for(f=$("#designer-menubar-items > li > a"),h=f.length,g=0;g<h;g++)j=f[g].href,i=e(j),f[g].href="##"+i}}),F.on("createBehavior",function(a,b,c,d){function e(a,b,c,d){var e={},f="",g=!1,h=!0;for(f in d)if(e=d[f],e.component===b&&e.state===c){g=!0;break}return g&&(h=!1),h}var f="\t\n",g=this.system().behaviors();if(e(a,b,c,g)){if(uuid=this.generateId(),methodDef=d.params,methodDef&&methodDef.length)for(length=methodDef.length,i=0;i<length;i++)0===i?params=methodDef[i].name:params=params+", "+methodDef[i].name;if(result=d.result,result)switch(result){case"string":f="\tvar result = '';\n\treturn result;\n";break;case"array":f="\tvar result = [];\n\treturn result;\n";break;case"number":f="\tvar result = 0;\n\treturn result;\n";break;case"object":f="\tvar result = {};\n\treturn result;\n";break;default:f="\tvar result = {};\n\treturn result;\n"}behavior={_id:uuid,component:b,state:c,action:"function "+c+"("+params+") { \n"+f+"}",useCoreAPI:!1,core:!1},g[uuid]=behavior,this.system().behaviors(g),this.save(),this.require("channel").$designerCreateBehavior(behavior)}}),F.on("deleteSchema",function(a){function b(a,b){var c="",d="";for(d in b)if(b[d]._name===a){c=d;break}return c}var c="",d="",e=null,f=this.system().schemas(),g=this.system().models(),h=this.system().behaviors(),i=this.system().components(),j=f[a]._name;delete i[j],this.system().components(i);for(c in h)e=h[c],e.component===j&&(delete h[c],this.system().behaviors(h));d=b(f[a]._name,g),d&&(delete g[d],this.system().models(g)),delete f[a],this.system().schemas(f)}),F.on("createModel",function(a){var b=(this.system().schemas(),this.system().models()),c=this.system().components(),d="",e="",f="",g=null,h=null;e=this.generateId(),h={_id:e,_name:a._name};for(f in a)if(0!==f.indexOf("_"))switch(!0){case"property"===a[f]:h[f]={type:"any",readOnly:!1,mandatory:!1,default:""};for(g in c[d])c[d][g][f]=h[f].default,this.require("channel").$designerUpdateComponent(g,d,c[d][g]);break;case"link"===a[f]:h[f]={type:"@RuntimeComponent",readOnly:!1,mandatory:!1,default:""};for(g in c[d])c[d][g][f]=h[f].default,this.require("channel").$designerUpdateComponent(g,d,c[d][g]);break;case"method"===a[f]:h[f]={params:[{name:"param",type:"any",mandatory:!1,default:null}],result:"any"};for(g in c[d])c[d][g][f]=h[f].default,this.require("channel").$designerUpdateComponent(g,d,c[d][g]);break;case"event"===a[f]:h[f]={params:[{name:"param",type:"any",mandatory:!1,default:null}]};for(g in c[d])c[d][g][f]=h[f].default,this.require("channel").$designerUpdateComponent(g,d,c[d][g]);break;case"collection"===a[f]:h[f]={type:["any"],readOnly:!1,mandatory:!1,default:[]};for(g in c[d])c[d][g][f]=h[f].default,this.require("channel").$designerUpdateComponent(g,d,c[d][g])}b[e]=h,this.system().models(b),this.require("channel").$designerCreateModel(h._id,h),this.system().components(c),this.save()}),F.on("syncComponent",function(a,b){var c=this.system().components(),d="",e="",f="",g=null,h=null;d=a._name,schema=this.getGeneratedSchema(d),g=this.getGeneratedModel(d);for(f in schema)switch(!0){case"property"===schema[f]:for(h in c[d])"undefined"==typeof c[d][h][f]&&(c[d][h][f]=g[f].default,
this.require("channel").$designerUpdateComponent(h,d,c[d][h]),this.system().components(c));break;case"link"===schema[f]:for(h in c[d])"undefined"==typeof c[d][h][f]&&(c[d][h][f]=g[f].default,this.require("channel").$designerUpdateComponent(h,d,c[d][h]),this.system().components(c));break;case"collection"===schema[f]:for(h in c[d])"undefined"==typeof c[d][h][f]&&(c[d][h][f]=g[f].default,this.require("channel").$designerUpdateComponent(h,d,c[d][h]),this.system().components(c))}if(b)for(e in c[d])for(f in c[d][e])"undefined"==typeof g[f]&&0!==f.indexOf("_")&&(delete c[d][e][f],this.require("channel").$designerDeleteComponent(e,d),this.system().components(c));this.save()}),F.on("syncModel",function(a){var b=this.system().schemas(),c=this.system().models(),d=this.system().components(),e=this.system().behaviors(),f="",g="",h="",i=null,j=null,k=null,l=null,m=!1;f=a._name;for(g in c)c[g]._name===a._name&&(k=c[g]);k||(m=!0,k={_id:this.generateId(),_name:f}),l=b[a._id];for(h in a)if(a.hasOwnProperty(h)&&l&&("undefined"==typeof l[h]||l[h]!==a[h])||m)switch(!0){case"property"===a[h]:k[h]={type:"any",readOnly:!1,mandatory:!1,default:""};for(i in d[f])d[f][i][h]=k[h].default,this.require("channel").$designerUpdateComponent(i,f,d[f][i]),this.system().components(d);break;case"link"===a[h]:k[h]={type:"@RuntimeComponent",readOnly:!1,mandatory:!1,default:""};for(i in d[f])d[f][i][h]=k[h].default,this.require("channel").$designerUpdateComponent(i,f,d[f][i]),this.system().components(d);break;case"method"===a[h]:("undefined"==typeof k[h]||"undefined"!=typeof k[h]&&"undefined"!=typeof k[h].type)&&(k[h]={params:[{name:"param",type:"any",mandatory:!1,default:null}],result:"any"},this.createBehavior("method",k._name,h,k[h]));break;case"event"===a[h]:"undefined"==typeof k[h]||"undefined"!=typeof k[h]&&"undefined"!=typeof k[h].type?(k[h]={params:[{name:"param",type:"any",mandatory:!1,default:null}]},this.createBehavior("event",k._name,h,k[h])):"undefined"!=typeof k[h].result&&delete k[h].result;break;case"collection"===a[h]:k[h]={type:["@RuntimeComponent"],readOnly:!1,mandatory:!1,default:[]};for(i in d[f])d[f][i][h]=k[h].default,this.require("channel").$designerUpdateComponent(i,f,d[f][i]),this.system().components(d);break;case 1!==h.indexOf("_"):"_id"!==h&&"_inherit"!==h&&(k[h]=a[h])}if(l)for(h in l)if(0!==h.indexOf("_")&&"undefined"==typeof a[h]){delete k[h];for(i in d[f])delete d[f][i][h],this.require("channel").$designerDeleteComponent(i,f),this.system().components(d);for(j in e)k&&e[j].component===k._name&&e[j].state===h&&(delete e[j],this.require("channel").$designerDeleteBehavior(j),this.system().behaviors(e))}c[k._id]=k,this.system().models(c),this.require("channel").$designerUpdateModel(k._id,k),this.save()}),F.on("syncBehavior",function(a){function b(a){var b="",c="";for(c in o.system().schemas())if(o.system().schemas()[c]._name===a){b=o.system().schemas()[c];break}return b}var c=this.system().behaviors(),d=null,e="",f="",g="",h=null,i=null,j=0,k=0,l="",m="",n=null,o=this;d=b(a._name);for(e in d)switch(!0){case"method"===d[e]:case"event"===d[e]:if(h=a[e],"object"!=typeof a[e]&&(h="method"===d[e]?{params:[{name:"param",type:"string",mandatory:!1,default:""}],result:"string"}:{params:[{name:"param",type:"string",mandatory:!1,default:""}]}),i=h.params,f="",i&&i.length)for(j=i.length,k=0;k<j;k++)f=0===k?i[k].name:f+", "+i[k].name;g="function "+e+"("+f+") ";for(l in c)n=c[l],n.component===a._name&&n.state===e&&(m=n.action.split("{"),m[0]=g,c[l].action=m.join("{"),this.system().behaviors(c),this.require("channel").$designerUpdateBehavior(n._id,n),this.save())}}),F.on("linkModel",function(a,b){jsPlumb.ready(function(){jsPlumb.setContainer("body"),jsPlumb.connect({paintStyle:{strokeStyle:"#7F949D",lineWidth:3},source:"designer-model-panel-"+a,target:"designer-model-panel-"+b,overlays:[["Arrow",{location:1}]]},{connector:["Flowchart"],anchor:["Left","Right"],endpoint:"Blank"})})}),F.on("save",function(){var a=this.require("storage").get("system-designer-systems"),b=this.require("designer"),c=this.require("db").collections().System.find({_id:b.system().id()})[0],d=c._id;c=JSON.parse(JSON.stringify(c)),delete c.classInfo,this.require("storage").set(d,c),a?a.systems.indexOf(d)===-1&&a.systems.push(d):a={systems:[d]},this.require("storage").set("system-designer-systems",a)}),F.on("runMessages",function(a){a.forEach(function(a){console.log(a),$db.RuntimeMessage.insert(a)})},!0),a.on("start",function(){var a=null;a=this.require("designer"),a.render()}),a.start()});