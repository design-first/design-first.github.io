/*
* System Designer
*
* https://designfirst.io/systemdesigner/
*
* Copyright 2017 Erwan Carriou
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*    http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/

runtime.on("ready",function(){var e=this.system("design"),t=this.require("DialogImport");t.on("init",function(e){var t="";$(".modal-backdrop").remove(),$("#designer-dialog-import").empty(),t=this.require("dialog-modal-import.html"),document.querySelector("#designer-dialog-import").insertAdjacentHTML("afterbegin",t.source().replace(/{{title}}/gi,this.title()).replace(/{{message}}/gi,this.message())),document.getElementById("designer-dialog-import-modal-cancel").addEventListener("click",function(e){this.cancel()}.bind(this)),document.getElementById("designer-dialog-import-modal-ok").addEventListener("click",function(e){this.ok()}.bind(this))}),t.on("show",function(){$("#designer-dialog-import-modal").modal("show")}),t.on("hide",function(){$("#designer-dialog-import-modal").modal("hide")});var s=this.require("DialogCheck");s.on("init",function(e){var t="";$("#designer-dialog-check").empty(),t=this.require("dialog-modal-check.html"),document.querySelector("#designer-dialog-check").insertAdjacentHTML("afterbegin",t.source().replace(/{{title}}/gi,this.title()).replace(/{{message}}/gi,this.message())),document.getElementById("designer-dialog-check-modal-ok").addEventListener("click",function(e){this.ok()}.bind(this))}),s.on("show",function(){$("#designer-dialog-check-modal").modal("show")}),s.on("hide",function(){$("#designer-dialog-check-modal").modal("hide")}),s.on("ok",function(){this.hide()});var n=this.require("DialogWelcome");n.on("init",function(e){var t="";$("#designer-dialog-welcome").empty(),t=this.require("dialog-modal-welcome.html"),document.querySelector("#designer-dialog-welcome").insertAdjacentHTML("afterbegin",t.source().replace(/{{title}}/gi,this.title())),document.getElementById("designer-dialog-welcome-modal-ok").addEventListener("click",function(e){this.ok()}.bind(this))}),n.on("show",function(){$("#designer-dialog-welcome-modal").modal("show")}),n.on("hide",function(){$("#designer-dialog-welcome-modal").modal("hide")});var r=this.require("DialogSync");r.on("init",function(e){var t="";$("#designer-dialog-sync").empty(),t=this.require("dialog-modal-sync.html"),document.querySelector("#designer-dialog-sync").insertAdjacentHTML("afterbegin",t.source().replace(/{{title}}/gi,this.title())),document.getElementById("designer-dialog-sync-modal-ok").addEventListener("click",function(e){this.ok()}.bind(this)),document.getElementById("designer-dialog-type-creation-hasHTML").addEventListener("click",function(e){$("#designer-dialog-type-creation-hasHTML")[0].checked?$("#designer-dialog-sync-options-log-level").show():$("#designer-dialog-sync-options-log-level").hide()}.bind(this)),document.getElementById("designer-dialog-sync-commit").addEventListener("click",function(e){$("#designer-dialog-sync-comments-area").show(),$("#designer-dialog-sync-options-area").show(),$("#designer-dialog-sync-options-node").show(),$("#designer-dialog-type-creation-hasHTML")[0].checked&&$("#designer-dialog-sync-options-log-level").show()}.bind(this)),document.getElementById("designer-dialog-sync-refresh").addEventListener("click",function(e){$("#designer-dialog-sync-comments-area").hide(),$("#designer-dialog-sync-options-area").hide(),$("#designer-dialog-sync-options-log-level").hide(),$("#designer-dialog-sync-options-node").hide()}.bind(this))}),r.on("show",function(){$("#designer-dialog-sync-modal").modal("show")}),r.on("hide",function(){$("#designer-dialog-sync-modal").modal("hide")});var o=this.require("DialogShare");o.on("init",function(e){var t=null,i="";$("#designer-dialog-share").empty(),i=this.require("db").collections().System.find({_id:this.require("designer").system().id()})[0],t=this.require("dialog-modal-share.html"),document.querySelector("#designer-dialog-share").insertAdjacentHTML("afterbegin",t.source().replace(/{{title}}/gi,this.title()).replace(/{{message}}/gi,window.location.toString().split("#")[0]+"?system="+encodeURIComponent(JSON.stringify(i)))),document.getElementById("designer-dialog-share-modal-cancel").addEventListener("click",function(e){this.cancel()}.bind(this)),document.getElementById("designer-dialog-share-modal-ok").addEventListener("click",function(e){this.ok()}.bind(this))}),o.on("show",function(){$("#designer-dialog-share-modal").modal("show")}),o.on("hide",function(){$("#designer-dialog-share-modal").modal("hide")});var a=this.require("DialogCopyright");a.on("init",function(e){var t="";$("#designer-dialog-copyright").empty(),t=this.require("dialog-modal-copyright.html"),document.querySelector("#designer-dialog-copyright").insertAdjacentHTML("afterbegin",t.source().replace(/{{title}}/gi,this.title()).replace(/{{message}}/gi,this.message())),document.getElementById("designer-dialog-copyright-modal-ok").addEventListener("click",function(e){this.ok()}.bind(this))}),a.on("show",function(){$("#designer-dialog-copyright-modal").modal("show")}),a.on("hide",function(){$("#designer-dialog-copyright-modal").modal("hide")});var d=this.require("DialogConfig");d.on("init",function(e){var t="",i=null;this.require("designer");$("#designer-dialog-config").empty(),t=this.require("dialog-modal-config.html"),document.querySelector("#designer-dialog-config").insertAdjacentHTML("afterbegin",t.source().replace(/{{title}}/gi,this.title())),(i=this.require("storage").get("system-designer-config"))||(i={}),void 0===i.debugType&&(i.debugType="client",this.require("storage").set("system-designer-config",i)),"client"===i.debugType?($("#designer-dialog-config-radio-client").attr("checked",!0),$("#designer-dialog-config-server-form").hide()):($("#designer-dialog-config-radio-server").attr("checked",!0),$("#designer-dialog-config-client-form").hide()),i.urlClient&&($("#designer-dialog-config-url-client")[0].value=i.urlClient),i.urlServer&&($("#designer-dialog-config-url-server")[0].value=i.urlServer),i.githubToken&&($("#designer-dialog-config-github-token")[0].value=atob(i.githubToken)),i.githubRepository&&($("#designer-dialog-config-github-repository")[0].value=i.githubRepository),i.advancedMode&&$("#designer-dialog-config-advanced-mode-isAdvanced").attr("checked",!0),document.getElementById("designer-dialog-config-radio-client").addEventListener("click",function(e){var t=this.require("storage").get("system-designer-config");t||(t={}),t.debugType="client",this.require("storage").set("system-designer-config",t),$("#designer-dialog-config-client-form").show(),$("#designer-dialog-config-server-form").hide()}.bind(this)),document.getElementById("designer-dialog-config-radio-server").addEventListener("click",function(e){var t=this.require("storage").get("system-designer-config");t||(t={}),t.debugType="server",this.require("storage").set("system-designer-config",t),$("#designer-dialog-config-client-form").hide(),$("#designer-dialog-config-server-form").show()}.bind(this)),document.getElementById("designer-dialog-config-url-client").addEventListener("keydown",function(e){if(13===e.keyCode)return e.stopPropagation(),e.preventDefault(),$("#designer-dialog-config-url-client").val()&&this.ok(),!1}.bind(this)),document.getElementById("designer-dialog-config-github-token").addEventListener("keydown",function(e){if(13===e.keyCode)return e.stopPropagation(),e.preventDefault(),$("#designer-dialog-config-github-token").val()&&this.ok(),!1}.bind(this)),document.getElementById("designer-dialog-config-github-repository").addEventListener("keydown",function(e){if(13===e.keyCode)return e.stopPropagation(),e.preventDefault(),$("#designer-dialog-config-github-repository").val()&&this.ok(),!1}.bind(this)),document.getElementById("designer-dialog-config-url-server").addEventListener("keydown",function(e){if(13===e.keyCode)return e.stopPropagation(),e.preventDefault(),$("#designer-dialog-config-url-server").val()&&this.ok(),!1}.bind(this)),document.getElementById("designer-dialog-config-advanced-mode-isAdvanced").addEventListener("click",function(e){var t=this.require("storage").get("system-designer-config");t||(t={}),t.advancedMode=$("#designer-dialog-config-advanced-mode-isAdvanced").prop("checked"),this.require("storage").set("system-designer-config",t)}.bind(this)),document.getElementById("designer-dialog-config-modal-cancel").addEventListener("click",function(e){this.cancel()}.bind(this)),document.getElementById("designer-dialog-config-modal-ok").addEventListener("click",function(e){this.ok()}.bind(this))}),d.on("show",function(){$("#designer-dialog-config-modal").modal("show")}),d.on("hide",function(){$("#designer-dialog-config-modal").modal("hide")}),d.on("ok",function(){var e=this.require("storage").get("system-designer-config");e||(e={}),e.urlClient=$("#designer-dialog-config-url-client")[0].value,e.urlServer=$("#designer-dialog-config-url-server")[0].value,e.githubToken=btoa($("#designer-dialog-config-github-token")[0].value),e.githubRepository=$("#designer-dialog-config-github-repository")[0].value,this.require("storage").set("system-designer-config",e)});var c=this.require("DialogImportFile");c.on("init",function(e){var t="",i=this,s=[],n="",r=[],o="",a="",d="",c=0,l=0,m="";for($("#designer-dialog-import-file").empty(),c=(s=this.require("db").collections().JSON.find()).length,l=0;l<c;l++)m=m+'<a class="list-group-item" id="designer-dialog-import-file-modal-library-'+(n=this.require(s[l]._id)).id()+'"><h4 class="list-group-item-heading">'+JSON.parse(decodeURIComponent(n.source())).description.substr(0,40).split("\n")[0].split(".")[0]+'</h4><p class="list-group-item-text">v'+JSON.parse(decodeURIComponent(n.source())).version+"</p></a>";for((r=this.require("storage").get("system-designer-systems"))&&(d=r.systems),c=d.length,l=0;l<c;l++)o=this.require("storage").get(d[l]),this.require("designer").system()&&this.require("designer").system().id()===o._id||(a=a+'<a class="list-group-item" id="designer-dialog-import-file-modal-systems-'+o._id+'"><h4 class="list-group-item-heading">'+o.name+'</h4><p class="list-group-item-text">v'+o.version+"</p></a>");t=this.require("dialog-modal-import-file.html"),document.querySelector("#designer-dialog-import-file").insertAdjacentHTML("afterbegin",t.source().replace(/{{title}}/gi,this.title()).replace(/{{library}}/gi,m).replace(/{{systems}}/gi,a)),""===a?($("#designer-dialog-import-modal-from-systems-input").hide(),this.require("designer").isCordova()&&($("#designer-dialog-import-modal-from-library-form").show(),$("#designer-dialog-import-modal-type-import").hide())):this.require("designer").isCordova()&&($("#designer-dialog-import-modal-from-library-form").show(),$("#designer-dialog-import-modal-type-import").show()),this.require("designer").isCordova()&&($("#designer-dialog-import-modal-from-file").attr("checked",!1),$("#designer-dialog-import-modal-from-library").attr("checked",!0)),this.require("designer").system()||$("#designer-dialog-import-file-modal-merge").hide();var h=function(e){var t="",s=null,n=0,r=0;if($(this).hasClass("active"))$(this).removeClass("active"),i.data(null);else{for(t=this.getAttribute("id").replace("designer-dialog-import-file-modal-systems-",""),i.data(i.require("storage").get(t)),n=(s=document.getElementById("designer-dialog-import-file-modal-systems")).children.length,r=0;r<n;r++)$(s.children[r]).removeClass("active");$(this).addClass("active")}};for(c=d.length,l=0;l<c;l++)o=i.require("storage").get(r.systems[l]),this.require("designer").system()&&this.require("designer").system().id()===o._id||document.getElementById("designer-dialog-import-file-modal-systems-"+o._id).addEventListener("click",h);var u=function(e){var t="",s=null,n=0,r=0;if($(this).hasClass("active"))$(this).removeClass("active"),i.data(null);else{for(t=this.getAttribute("id").replace("designer-dialog-import-file-modal-library-",""),i.data(JSON.parse(decodeURIComponent(i.require(t).source()))),n=(s=document.getElementById("designer-dialog-import-file-modal-library")).children.length,r=0;r<n;r++)$(s.children[r]).removeClass("active");$(this).addClass("active")}};for(c=s.length,l=0;l<c;l++)n=this.require(s[l]._id),document.getElementById("designer-dialog-import-file-modal-library-"+n.id()).addEventListener("click",u);document.getElementById("designer-dialog-import-modal-from-file").addEventListener("click",function(e){$("#designer-dialog-import-modal-from-file-form").show(),$("#designer-dialog-import-modal-from-systems-form").hide(),$("#designer-dialog-import-modal-from-library-form").hide(),$("#designer-dialog-import-file-modal-import").show(),$("#designer-dialog-import-file-modal-merge").removeClass("btn-primary"),$("#designer-dialog-import-file-modal-merge").addClass("btn-default")}.bind(this)),document.getElementById("designer-dialog-import-modal-from-library").addEventListener("click",function(e){$("#designer-dialog-import-modal-from-library-form").show(),$("#designer-dialog-import-modal-from-systems-form").hide(),$("#designer-dialog-import-modal-from-file-form").hide(),$("#designer-dialog-import-file-modal-import").show(),$("#designer-dialog-import-file-modal-merge").removeClass("btn-primary"),$("#designer-dialog-import-file-modal-merge").addClass("btn-default")}.bind(this)),document.getElementById("designer-dialog-import-modal-from-systems").addEventListener("click",function(e){$("#designer-dialog-import-modal-from-library-form").hide(),$("#designer-dialog-import-modal-from-systems-form").show(),$("#designer-dialog-import-modal-from-file-form").hide(),$("#designer-dialog-import-file-modal-import").hide(),$("#designer-dialog-import-file-modal-merge").removeClass("btn-default"),$("#designer-dialog-import-file-modal-merge").addClass("btn-primary")}.bind(this)),document.getElementById("designer-dialog-import-file-modal-cancel").addEventListener("click",function(e){this.cancel()}.bind(this)),document.getElementById("designer-dialog-import-file-modal-merge").addEventListener("click",function(e){this.mergeSystem()}.bind(this)),document.getElementById("designer-dialog-import-file-modal-import").addEventListener("click",function(e){this.importSystem()}.bind(this)),document.getElementById("designer-dialog-import-file-modal-file").addEventListener("change",function(e){e.stopPropagation(),e.preventDefault();var t=e.target.files,i=new FileReader,s="",n=this;i.onload=function(e){s+=e.target.result},i.onloadend=function(){try{n.data(JSON.parse(s))}catch(e){n.data({})}},i.readAsText(t[0],"UTF-8")}.bind(this))}),c.on("show",function(){$("#designer-dialog-import-file-modal").modal("show")}),c.on("hide",function(){$("#designer-dialog-import-file-modal").modal("hide")});var l=this.require("DialogDropFile");l.on("init",function(e){var t=null;$("#designer-dialog-drop-file").empty(),t=this.require("dialog-modal-drop-file.html"),document.querySelector("#designer-dialog-drop-file").insertAdjacentHTML("afterbegin",t.source().replace(/{{title}}/gi,this.title()).replace(/{{message}}/gi,this.message())),document.getElementById("designer-dialog-drop-file-modal-cancel").addEventListener("click",function(e){this.cancel()}.bind(this)),document.getElementById("designer-dialog-drop-file-modal-merge").addEventListener("click",function(e){this.mergeSystem()}.bind(this)),document.getElementById("designer-dialog-drop-file-modal-import").addEventListener("click",function(e){this.importSystem()}.bind(this)),this.require("designer").system()||$("#designer-dialog-drop-file-modal-merge").hide()}),l.on("mergeSystem",function(){function e(e){var t="",i="";for(i in l.system().models())if(l.system().models()[i]._name===e){t=i;break}return t}function t(e){var t="",i="";for(i in l.system().schemas())if(l.system().schemas()[i]._name===e){t=i;break}return t}function i(e,t,i,s){var n={},r="";for(r in s)if((n=s[r]).component===t&&n.state===i&&n._id!==e){delete s[n._id];break}}var s=null,n="",r="",o="",a="",d="",c="",l=this.require("designer"),m={},h={},u={},g={},p={},f=(l.system(),this.require("message"));if(s=this.data(),Object.keys(s).length){m=JSON.parse(JSON.stringify(l.system().schemas()));for(n in s.schemas)if(m[n])for(o in s.schemas[n])m[n][o]=s.schemas[n][o];else if(t(s.schemas[n]._name))for(o in s.schemas[n])0!==o.indexOf("_")&&(m[t(s.schemas[n]._name)][o]=s.schemas[n][o]);else m[n]=s.schemas[n];l.system().schemas(m),p=JSON.parse(JSON.stringify(l.system().behaviors()));for(n in s.behaviors)n!==s._id&&function(e,s,n,r){var o={},a="",d=!0;return a=t(r.component),o=s[a],o&&o[r.state]?"method"===o[r.state]&&i(r._id,r.component,r.state,n):d=!1,"main"!==r.state&&"start"!==r.state&&"stop"!==r.state||r.component!==e||(d=!1),d}(s._id,m,p,s.behaviors[n])?p[n]=s.behaviors[n]:"main"!==s.behaviors[n].state&&"start"!==s.behaviors[n].state&&"stop"!==s.behaviors[n].state||s.behaviors[n].component!==s._id||l.mergeBehavior(p,s.behaviors[n],l.system().id(),s.name);l.system().behaviors(p);for(c in m)l.syncModel(m[c]);h=JSON.parse(JSON.stringify(l.system().models()));for(n in s.models)if(h[n])for(o in s.models[n])h[n][o]=s.models[n][o];else if(e(s.models[n]._name))for(o in s.models[n])0!==o.indexOf("_")&&(h[e(s.models[n]._name)][o]=s.models[n][o]);else h[n]=s.models[n];l.system().models(h);for(d in h)l.syncBehavior(h[d]);u=JSON.parse(JSON.stringify(l.system().types()));for(n in s.types)if(u[n])for(o in s.types[n])u[n][o]=s.types[n][o];else u[n]=s.types[n];l.system().types(u),g=JSON.parse(JSON.stringify(l.system().components()));for(r in s.components){g[r]||(g[r]={});for(a in s.components[r])if(g[r][a])for(o in s.components[r][a])g[r][a][o]=s.components[r][a][o];else g[r][a]=s.components[r][a]}l.system().components(g);for(d in h)l.syncComponent(h[d]);l.system().schemas(m),l.system().models(h),l.system().types(u),l.system().behaviors(p),l.system().components(g),l.system().id()===s._id&&(l.system().version(s.version),l.system().description(s.description)),l.save(),l.spaces().render(),l.workspace().refresh(),l.updateRouter(),this.hide(),f.success("Composition of the system is done.")}else f.danger("The system you try to import is invalid.")}),l.on("importSystem",function(){var e=this.require("System"),t=null,i=this.require("designer"),s=this.require("message");i.system()&&i.system().destroy(),t=new e(this.data()),i.system(t),i.logs().forEach(function(e){this.logs().pop()}.bind(i)),i.save(),i.space(t.name()),i.spaces().render(),i.workspace().refresh(),i.updateRouter(),this.hide(),i.save(),s.success("Importation of the system is done.")}),l.on("show",function(){$("#designer-dialog-drop-file-modal").modal("show")}),l.on("hide",function(){$("#designer-dialog-drop-file-modal").modal("hide")});var m=this.require("DialogTypeCreation");m.on("init",function(e){var t="";$("#designer-dialog-type-creation").empty(),t=this.require("dialog-modal-type-creation.html"),document.querySelector("#designer-dialog-type-creation").insertAdjacentHTML("afterbegin",t.source().replace(/{{title}}/gi,this.title())),document.getElementById("designer-dialog-type-creation-name").addEventListener("keydown",function(e){if(13===e.keyCode)return e.stopPropagation(),e.preventDefault(),$("#designer-dialog-type-creation-name").val()&&this.ok(),!1}.bind(this)),document.getElementById("designer-dialog-type-creation-modal-cancel").addEventListener("click",function(e){this.cancel()}.bind(this)),document.getElementById("designer-dialog-type-creation-modal-ok").addEventListener("click",function(e){this.ok()}.bind(this)),$("#designer-dialog-type-creation-modal").on("shown.bs.modal",function(){$("#designer-dialog-type-creation-name").focus()})}),m.on("show",function(){$("#designer-dialog-type-creation-modal").modal("show")}),m.on("hide",function(){$("#designer-dialog-type-creation-modal").modal("hide")});var h=this.require("DialogExport");h.on("init",function(e){var t="",i=this.require("designer").system();$("#designer-dialog-export").empty(),t=this.require("dialog-modal-export.html"),document.querySelector("#designer-dialog-export").insertAdjacentHTML("afterbegin",t.source().replace(/{{title}}/gi,this.title())),!0===i.master()&&$("#designer-dialog-export-isMaster").attr("checked",!0),!0===i.subsystem()&&$("#designer-dialog-export-isSubsystem").attr("checked",!0),document.getElementById("designer-dialog-export-modal-cancel").addEventListener("click",function(e){this.cancel()}.bind(this)),document.getElementById("designer-dialog-export-modal-ok").addEventListener("click",function(e){this.ok()}.bind(this)),document.getElementById("designer-dialog-export-json").addEventListener("click",function(e){$("#designer-dialog-export-options").show(),$("#designer-dialog-export-options-log-level").hide()}.bind(this)),document.getElementById("designer-dialog-export-javascript").addEventListener("click",function(e){$("#designer-dialog-export-options").hide(),$("#designer-dialog-export-options-log-level").show()}.bind(this)),document.getElementById("designer-dialog-export-html").addEventListener("click",function(e){$("#designer-dialog-export-options").hide(),$("#designer-dialog-export-options-log-level").show()}.bind(this)),document.getElementById("designer-dialog-export-node").addEventListener("click",function(e){$("#designer-dialog-export-options").hide(),$("#designer-dialog-export-options-log-level").show()}.bind(this)),document.getElementById("designer-dialog-export-modal").addEventListener("keydown",function(e){if(13===e.keyCode)return e.stopPropagation(),e.preventDefault(),this.ok(),!1}.bind(this))}),h.on("show",function(){$("#designer-dialog-export-modal").modal("show")}),h.on("hide",function(){$("#designer-dialog-export-modal").modal("hide")});var u=this.require("DialogSchemaCreation");u.on("init",function(e){var t="";$("#designer-dialog-schema-creation").empty(),t=this.require("dialog-modal-schema-creation.html"),document.querySelector("#designer-dialog-schema-creation").insertAdjacentHTML("afterbegin",t.source().replace(/{{title}}/gi,this.title())),document.getElementById("designer-dialog-schema-creation-name").addEventListener("keydown",function(e){if(13===e.keyCode)return e.stopPropagation(),e.preventDefault(),$("#designer-dialog-schema-creation-name").val()&&this.ok(),!1}.bind(this)),document.getElementById("designer-dialog-schema-creation-modal-cancel").addEventListener("click",function(e){this.cancel()}.bind(this)),document.getElementById("designer-dialog-schema-creation-modal-ok").addEventListener("click",function(e){this.ok()}.bind(this)),$("#designer-dialog-schema-creation-modal").on("shown.bs.modal",function(){$("#designer-dialog-schema-creation-name").focus()})}),u.on("show",function(){$("#designer-dialog-schema-creation-modal").modal("show")}),u.on("hide",function(){$("#designer-dialog-schema-creation-modal").modal("hide")});var g=this.require("DialogSystemCreation");g.on("init",function(e){var t="";$("#designer-dialog-system-creation").empty(),t=this.require("dialog-modal-system-creation.html"),document.querySelector("#designer-dialog-system-creation").insertAdjacentHTML("afterbegin",t.source().replace(/{{title}}/gi,this.title())),document.getElementById("designer-dialog-system-creation-name").addEventListener("keydown",function(e){if(13===e.keyCode)return e.stopPropagation(),e.preventDefault(),$("#designer-dialog-system-creation-name").val()&&this.ok(),!1}.bind(this)),document.getElementById("designer-dialog-system-creation-modal-cancel").addEventListener("click",function(e){this.cancel()}.bind(this)),document.getElementById("designer-dialog-system-creation-modal-ok").addEventListener("click",function(e){this.ok()}.bind(this)),$("#designer-dialog-system-creation-modal").on("shown.bs.modal",function(){$("#designer-dialog-system-creation-name").focus()})}),g.on("show",function(){$("#designer-dialog-system-creation-modal").modal("show")}),g.on("hide",function(){$("#designer-dialog-system-creation-modal").modal("hide")});var p=this.require("DialogModelCreation");p.on("init",function(e){var t="";$("#designer-dialog-model-creation").empty(),t=this.require("dialog-modal-model-creation.html"),document.querySelector("#designer-dialog-model-creation").insertAdjacentHTML("afterbegin",t.source().replace(/{{title}}/gi,this.title())),document.getElementById("designer-dialog-model-creation-modal-ok").addEventListener("click",function(e){this.ok()}.bind(this))}),p.on("show",function(){$("#designer-dialog-model-creation-modal").modal("show")}),p.on("hide",function(){$("#designer-dialog-model-creation-modal").modal("hide")});var f=this.require("DialogBehaviorCreation");f.on("init",function(e){var t="",i="",s=[],n=this.require("designer"),r=this.require("designer").space();n.system().schemas(),n.system().models();$("#designer-dialog-behavior-creation").empty(),r!==n.system().name()?s=Object.keys(this.require("designer").getGeneratedSchema(function(e){var t=e,i="";for(i in n.system().components())if(void 0!==n.system().components()[i][e]){t=i;break}return t}(r))):(s.push("start"),s.push("stop")),s.sort(),s.forEach(function(e){i=i+'<option value="'+e+'">'+e+"</option>"}),t=this.require("dialog-modal-behavior-creation.html"),document.querySelector("#designer-dialog-behavior-creation").insertAdjacentHTML("afterbegin",t.source().replace(/{{title}}/gi,this.title()).replace(/{{states}}/gi,i)),document.getElementById("designer-dialog-behavior-creation-state").addEventListener("keydown",function(e){if(13===e.keyCode)return e.stopPropagation(),e.preventDefault(),$("#designer-dialog-behavior-creation-state").val()&&this.ok(),!1}.bind(this)),document.getElementById("designer-dialog-behavior-creation-modal-cancel").addEventListener("click",function(e){this.cancel()}.bind(this)),document.getElementById("designer-dialog-behavior-creation-modal-ok").addEventListener("click",function(e){this.ok()}.bind(this)),$("#designer-dialog-behavior-creation-modal").on("shown.bs.modal",function(){$("#designer-dialog-behavior-creation-state").focus()})}),f.on("show",function(){$("#designer-dialog-behavior-creation-modal").modal("show")}),f.on("hide",function(){$("#designer-dialog-behavior-creation-modal").modal("hide")});var y=this.require("DialogComponentCreation");y.on("init",function(e){var t="",i="",s="",n=this.require("designer").system().models();$("#designer-dialog-component-creation").empty();for(i in n)s=s+'<option value="'+i+'">'+i+"</option>";t=this.require("dialog-modal-component-creation.html"),document.querySelector("#designer-dialog-component-creation").insertAdjacentHTML("afterbegin",t.source().replace(/{{title}}/gi,this.title()).replace(/{{models}}/gi,s)),document.getElementById("designer-dialog-component-creation-modal-cancel").addEventListener("click",function(e){this.cancel()}.bind(this)),document.getElementById("designer-dialog-component-creation-modal-ok").addEventListener("click",function(e){this.ok()}.bind(this))}),y.on("show",function(){$("#designer-dialog-component-creation-modal").modal("show")}),y.on("hide",function(){$("#designer-dialog-component-creation-modal").modal("hide")});var v=this.require("DialogRuntimeComponentInfo");v.on("init",function(e){var t="";$("#designer-dialog-runtimecomponent-info").empty(),t=this.require("dialog-modal-runtimecomponent-info.html"),document.querySelector("#designer-dialog-runtimecomponent-info").insertAdjacentHTML("afterbegin",t.source().replace(/{{title}}/gi,this.title())),document.getElementById("designer-dialog-runtimecomponent-info-modal-ok").addEventListener("click",function(e){this.hide()}.bind(this))}),v.on("show",function(){$("#designer-dialog-runtimecomponent-info-modal").modal("show")}),v.on("hide",function(){$("#designer-dialog-runtimecomponent-info-modal").modal("hide")});var b=this.require("DialogSearch");b.on("init",function(e){var t="",i=null;this.require("designer").system();$("#designer-dialog-search").empty(),t=this.require("dialog-modal-search.html"),document.querySelector("#designer-dialog-search").insertAdjacentHTML("afterbegin",t.source().replace(/{{title}}/gi,this.title())),(i=document.getElementById("designer-dialog-search-modal-ok")).addEventListener("click",function(e){this.ok()}.bind(this)),(i=document.getElementById("designer-dialog-search-result")).addEventListener("click",function(e){this.hide()}.bind(this)),(i=document.getElementById("designer-dialog-input-search")).addEventListener("keyup",function(e){if(13===e.keyCode)return e.stopPropagation(),e.preventDefault(),!1;this.filter(e.target.value)}.bind(this)),i.addEventListener("keydown",function(e){if(13===e.keyCode)return e.stopPropagation(),e.preventDefault(),!1}.bind(this)),(i=document.getElementById("designer-dialog-option")).addEventListener("click",function(e){$("#designer-dialog-checkbox-search")[0].checked=!this.inContent(),this.inContent(!this.inContent()),this.filter(this.filter())}.bind(this)),$("#designer-dialog-search-modal").on("shown.bs.modal",function(){$("#designer-dialog-input-search").focus()})}),b.on("show",function(){$("#designer-dialog-search-modal").modal("show")}),b.on("hide",function(){$("#designer-dialog-search-modal").modal("hide")});var q=this.require("ModelSystem");q.on("render",function(){var e=null,t=this,i="",s="";e=this.require("model-system.html");for(s in this.document())-1!==["name","description","version"].indexOf(s)&&(i=i+"<tr><td>"+s+"</td><td>"+this.document()[s].replace(/\n/g,"<br>")+"</td></tr>");document.querySelector("#designer-workspace").insertAdjacentHTML("afterbegin",e.source().replace(/{{title}}/gi,this.title()).replace(/{{_id}}/gi,this.uuid()).replace(/{{content}}/gi,i)),(e=document.getElementById("designer-system-"+this.uuid()).children[0].children[1])&&e.addEventListener("click",function(e){this.require("designer").open("system.html#"+t.uuid()+"#description",t.uuid())}.bind(this)),(e=document.getElementById("designer-system-"+this.uuid()+"-edit"))&&e.addEventListener("click",function(e){this.require("designer").open("system.html#"+t.uuid()+"#description",t.uuid())}.bind(this)),(e=document.getElementById("designer-system-"+this.uuid()+"-export"))&&e.addEventListener("click",function(e){this.document().name;var t=JSON.parse(JSON.stringify(this.document()));delete t.classInfo,this.require("designer").saveAs(t,this.document().name+".json")}.bind(this)),(e=document.getElementById("designer-system-"+this.uuid()+"-delete"))&&e.addEventListener("click",function(e){var t=this.require("storage").get("system-designer-systems"),i=this.require("designer"),s=this.require("System"),n=this.uuid();this.require("storage").remove(n),t.systems.splice(t.systems.indexOf(n),1),this.require("storage").set("system-designer-systems",t),i.system().destroy(),i.logs().forEach(function(e){this.logs().pop()}.bind(i)),t.systems.length&&i.system(new s(this.require("storage").get(t.systems[0]))),$("#designer-system-"+this.uuid()).remove(),this.destroy(),i.space(""),i.spaces().render(),i.workspace().refresh()}.bind(this))}),q.on("hide",function(){$("#designer-system-"+this.uuid()).hide()}),q.on("show",function(){$("#designer-system-"+this.uuid()).show()});var k=this.require("ModelType");k.on("render",function(){function e(e){var t="",s="";for(s in i.require("designer").system().models())if(i.require("designer").system().models()[s]._name===e){t=s;break}return t}var t=null,i=this,s="",n="",r="",o="";if(o=this.require("designer").system().id(),t=this.require("model-type.html"),this.document().schema)for(n in this.document().schema)this.document().schema.hasOwnProperty(n)&&(r=this.document().schema[n].type,s+=function(t,s){return Array.isArray(s)?-1!==s[0].indexOf("@")?"@RuntimeComponent"!==s[0]?'<div class="list-group-item" style="text-align: left">'+t+'<a href="#'+i.require("designer").system().id()+"#models#"+e(s[0].replace("@",""))+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+s[0].replace("@","")+"</a> [ ]</div>":'<div class="list-group-item" style="text-align: left">'+t+s[0].replace("@","")+" [ ]</div>":-1===["any","boolean","string","number","object","function","array","html","javascript","css","json","text","date"].indexOf(s[0])?'<div class="list-group-item" style="text-align: left">'+t+'<a href="#'+i.require("designer").system().id()+"#types#"+s[0]+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+s[0].replace("@","")+"</a> [ ]</div>":'<div class="list-group-item" style="text-align: left">'+t+s[0]+" [ ]</div>":-1!==s.indexOf("@")?"@RuntimeComponent"!==s?'<div class="list-group-item" style="text-align: left">'+t+'<a href="#'+i.require("designer").system().id()+"#models#"+e(s.replace("@",""))+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+s.replace("@","")+"</a></div>":'<div class="list-group-item" style="text-align: left">'+t+s.replace("@","")+"</div>":-1===["any","boolean","string","number","object","function","array","html","javascript","css","json","text","date"].indexOf(s)?'<div class="list-group-item" style="text-align: left">'+t+'<a href="#'+i.require("designer").system().id()+"#types#"+s+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+s+"</a></div>":'<div class="list-group-item" style="text-align: left">'+t+s+"</div>"}(n+" : ",r));this.document().value&&this.document().value.forEach(function(e){s=s+'<div class="list-group-item" style="text-align: left">'+e+"</div>"}),this.document().schema||this.document().value||(r=this.document().type,s=s+'<div class="list-group-item" style="text-align: left"><i>alias</i> : '+r+"</div>"),""===s&&(s+='<a class="list-group-item" style="text-align: left"><br/><br/></a>'),document.querySelector("#designer-workspace").insertAdjacentHTML("afterbegin",t.source().replace(/{{title}}/gi,this.title()).replace(/{{id}}/gi,this.uuid()).replace(/{{content}}/gi,s)),(t=document.getElementById("designer-type-"+this.uuid()).children[0].children[1])&&t.addEventListener("click",function(e){this.require("designer").open("type.html#"+i.uuid()+"#"+o,i.uuid())}.bind(this)),(t=document.getElementById("designer-type-"+this.uuid()+"-edit"))&&t.addEventListener("click",function(e){this.require("designer").open("type.html#"+i.uuid()+"#"+o,i.uuid())}.bind(this)),(t=document.getElementById("designer-type-"+this.uuid()+"-export"))&&t.addEventListener("click",function(e){var t={name:"type "+this.document().name,master:!1,subsystem:!0,version:"0.0.1",description:"Type "+this.document().name,schemas:{},models:{},behaviors:{},types:{},components:{}};t.name=t.name.trim(),t.name=t.name.replace(/ /gi,"-"),t.name=t.name.toLocaleLowerCase(),t.types[this.document().name]=this.document(),this.require("designer").saveAs(t,"type."+this.document().name.replace(/ /gi,"-").toLowerCase()+".json")}.bind(this)),(t=document.getElementById("designer-type-"+this.uuid()+"-delete"))&&t.addEventListener("click",function(e){var t=this.require("designer");types=t.system().types(),delete types[this.title()],t.system().types(types),$("#designer-type-"+this.title()).remove(),this.require("channel").$designerDeleteType(this.uuid()),this.destroy(),t.save(),t.space(""),t.spaces().render(),t.workspace().refresh()}.bind(this))}),k.on("hide",function(){$("#designer-type-"+this.title()).hide()}),k.on("show",function(){$("#designer-type-"+this.title()).show()});var w=this.require("ModelSchema");w.on("render",function(){var e=null,t="",i=this,s="",n="";n=this.uuid()||this.title(),systemId=this.require("designer").system().id(),e=this.require("model-schema.html");for(s in this.document())this.document().hasOwnProperty(s)&&0!==s.indexOf("_")&&(t=t+"<tr><td>"+s+"</td><td>"+this.document()[s]+"</td></tr>");""===t&&(t+="<tr><td><br/><br/><br/></td><td><br/><br/><br/></td></tr>"),document.querySelector("#designer-workspace").insertAdjacentHTML("afterbegin",e.source().replace(/{{title}}/gi,this.title()).replace(/{{id}}/gi,n).replace(/{{content}}/gi,t)),this.editable()?((e=document.getElementById("designer-schema-"+n).children[0].children[1])&&e.addEventListener("click",function(e){this.require("designer").open("schema.html#"+i.uuid()+"#"+systemId,i.uuid())}.bind(this)),(e=document.getElementById("designer-schema-"+n+"-edit"))&&e.addEventListener("click",function(e){this.require("designer").open("schema.html#"+i.uuid()+"#"+systemId,i.uuid())}.bind(this)),(e=document.getElementById("designer-schema-"+n+"-export"))&&e.addEventListener("click",function(e){var t={name:"schema "+this.document()._name,master:!1,subsystem:!0,version:"0.0.1",description:"Schema "+this.document()._name,schemas:{},models:{},behaviors:{},types:{},components:{}};t.name=t.name.trim(),t.name=t.name.replace(/ /gi,"-"),t.name=t.name.toLocaleLowerCase(),t.schemas[this.document()._id]=this.document(),this.require("designer").saveAs(t,"schema."+this.document()._name.replace(/ /gi,"-").toLowerCase()+".json")}.bind(this)),(e=document.getElementById("designer-schema-"+n+"-delete"))&&e.addEventListener("click",function(e){var t=this.require("designer");t.deleteSchema(this.uuid()),$("#designer-schema-"+this.uuid()).remove(),this.require("channel").$designerDeleteSchema(this.uuid()),this.destroy(),jsPlumb.deleteEveryEndpoint(),t.save(),t.space(""),t.spaces().render(),t.workspace().refresh()}.bind(this))):($("#designer-schema-"+n+" > div > div > div > button").hide(),(e=document.getElementById("designer-schema-"+n).children[0].children[1])&&e.addEventListener("click",function(e){"RuntimeComponent"!==this.title()?this.require("designer").system().schemas()[i.uuid()]?this.require("designer").open("index.html#"+this.require("designer").system().id()+"#schemas#"+i.uuid(),"_self"):this.require("message").warning("Your schema ‘"+i.title()+"’ has not been yet created."):new(this.require("DialogRuntimeComponentInfo"))({title:"RuntimeComponent schema"}).show()}.bind(this)))}),w.on("hide",function(){$("#designer-schema-"+this.uuid()).hide()}),w.on("show",function(){$("#designer-schema-"+this.uuid()).show()});var E=this.require("ModelClass");E.on("render",function(){function e(e){return-1!==e.indexOf("@")&&"RuntimeComponent"!==e.replace("@","")?'<a href="#'+s.require("designer").system().id()+"#models#"+t(e.replace("@",""))+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+e.replace("@","")+"</a>":-1===["any","boolean","string","number","object","function","array","html","javascript","css","errorParam","json","text","date"].indexOf(e)&&"RuntimeComponent"!==e.replace("@","")?'<a href="#'+s.require("designer").system().id()+"#types#"+e+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+e.replace("@","")+"</a>":e.replace("@","")}function t(e){var t="",i="";for(i in s.require("designer").system().models())if(s.require("designer").system().models()[i]._name===e){t=i;break}return t}var i=null,s=this,n="",r="",o="",a="",d="",c=null,l="",m=null,h="";l=this.uuid()||this.title(),h=this.require("designer").system().id(),c=function(e){u=-1!==e.type.indexOf("@")&&"@RuntimeComponent"!==e.type?u+e.name+' : <a href="#'+this.require("designer").system().id()+"#models#"+t(e.type.replace("@",""))+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+e.type.replace("@","")+"</a>, ":-1===["any","boolean","string","number","object","function","array","html","javascript","css","errorParam","json","text","date"].indexOf(e.type)&&"@RuntimeComponent"!==e.type?u+e.name+' : <a href="#'+this.require("designer").system().id()+"#types#"+e.type+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+e.type.replace("@","")+"</a>, ":u+e.name+" : "+e.type.replace("@","")+", "};for(n in this.document())if(this.document().hasOwnProperty(n))switch(a=this.document()[n],!0){case void 0!==a.type:r=Array.isArray(a.type)?-1!==a.type[0].indexOf("@")?"123751cb591de26"!==l&&"@RuntimeComponent"!==a.type[0]?r+'<div class="list-group-item" style="text-align: left">+ '+n+' : <a href="#'+this.require("designer").system().id()+"#models#"+t(a.type[0].replace("@",""))+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+a.type[0].replace("@","")+"</a> [ ]</div>":r+'<div class="list-group-item" style="text-align: left">+ '+n+" : "+a.type[0].replace("@","")+" [ ]</div>":-1===["any","boolean","string","number","object","function","array","html","javascript","css","json","text","date"].indexOf(a.type[0])?"123751cb591de26"!==l?r+'<div class="list-group-item" style="text-align: left">+ '+n+' : <a href="#'+this.require("designer").system().id()+"#types#"+a.type[0]+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+a.type[0].replace("@","")+"</a> [ ]</div>":r+'<div class="list-group-item" style="text-align: left">+ '+n+" : "+a.type[0].replace("@","")+" [ ]</div>":r+'<div class="list-group-item" style="text-align: left">+ '+n+" : "+a.type[0]+" [ ]</div>":-1!==a.type.indexOf("@")?"123751cb591de26"!==l&&"@RuntimeComponent"!==a.type?r+'<div class="list-group-item" style="text-align: left">+ '+n+' : <a href="#'+this.require("designer").system().id()+"#models#"+t(a.type.replace("@",""))+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+a.type.replace("@","")+"</a></div>":r+'<div class="list-group-item" style="text-align: left">+ '+n+" : "+a.type.replace("@","")+"</div>":-1===["any","boolean","string","number","object","function","array","html","javascript","css","json","text","date"].indexOf(a.type)&&"123751cb591de26"!==l?r+'<div class="list-group-item" style="text-align: left">+ '+n+' : <a href="#'+this.require("designer").system().id()+"#types#"+a.type+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+a.type+"</a></div>":r+'<div class="list-group-item" style="text-align: left">+ '+n+" : "+a.type+"</div>";break;case void 0!==a.params:d="undefined";var u="(";a.params.forEach(c.bind(this)),u=(u+=")").replace(", )",")"),void 0!==a.result?(d=e(a.result),o="123751cb591de26"!==l?o+'<div class="list-group-item" style="text-align: left">+ <a href="#'+this.require("designer").system().id()+"#behaviors#"+this.document()._name+"#"+n+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+n+"</a>"+u+" : "+d+"</div>":o+'<div class="list-group-item" style="text-align: left">+ '+n+u+" : "+d+"</div>"):o="123751cb591de26"!==l?o+'<div class="list-group-item" style="text-align: left">+ <a href="#'+this.require("designer").system().id()+"#behaviors#"+this.document()._name+"#"+n+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+n+"</a>"+u+"</div>":o+'<div class="list-group-item" style="text-align: left">+ '+n+u+"</div>";break;case-1!==n.indexOf("_"):break;default:d="undefined",void 0!==a.result?(d=e(a.result),o="123751cb591de26"!==l?o+'<div class="list-group-item" style="text-align: left">+ <a href="#'+this.require("designer").system().id()+"#behaviors#"+this.document()._name+"#"+n+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+n+"</a>() : "+d+"</div>":o+'<div class="list-group-item" style="text-align: left">+ '+n+"() : "+d+"</div>"):o="123751cb591de26"!==l?o+'<div class="list-group-item" style="text-align: left">+ <a href="#'+this.require("designer").system().id()+"#behaviors#"+this.document()._name+"#"+n+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+n+"</a>()</div>":o+'<div class="list-group-item" style="text-align: left">+ '+n+"()</div>"}""===r&&(r+='<a class="list-group-item" style="text-align: left"><br/></a>'),""===o&&(o+='<a class="list-group-item" style="text-align: left"><br/></a>'),m=this.require("model-class.html"),document.querySelector("#designer-workspace").insertAdjacentHTML("afterbegin",m.source().replace(/{{title}}/gi,this.title()).replace(/{{_id}}/gi,l).replace(/{{attributes}}/gi,r).replace(/{{collections}}/gi,"").replace(/{{methods}}/gi,o).replace(/{{events}}/gi,"")),this.editable()?((i=document.getElementById("designer-model-"+l).children[0].children[1])&&i.addEventListener("click",function(e){this.require("designer").open("model.html#"+s.uuid()+"#"+h,s.uuid())}.bind(this)),(i=document.getElementById("designer-model-"+l+"-export"))&&i.addEventListener("click",function(e){var t={name:"model "+this.document()._name,master:!1,subsystem:!0,version:"0.0.1",description:"Model "+this.document()._name,schemas:{},models:{},behaviors:{},types:{},components:{}};t.name=t.name.trim(),t.name=t.name.replace(/ /gi,"-"),t.name=t.name.toLocaleLowerCase(),t.models[this.document()._id]=this.document(),this.require("designer").saveAs(t,"model."+this.document()._name.replace(/ /gi,"-").toLowerCase()+".json")}.bind(this)),(i=document.getElementById("designer-model-"+l+"-edit"))&&i.addEventListener("click",function(e){this.require("designer").open("model.html#"+s.uuid()+"#"+h,s.uuid())}.bind(this))):($("#designer-model-"+l+" > div > div > div > button").hide(),(i=document.getElementById("designer-model-"+l).children[0].children[1])&&i.addEventListener("click",function(e){"RuntimeComponent"!==this.title()?this.require("designer").system().models()[s.uuid()]?this.require("designer").open("index.html#"+this.require("designer").system().id()+"#models#"+s.uuid(),"_self"):this.require("message").warning("Your schema ‘"+s.title()+"’ has not been yet created."):new(this.require("DialogRuntimeComponentInfo"))({title:"RuntimeComponent model"}).show()}.bind(this)))}),E.on("hide",function(){$("#designer-class-"+this.uuid()).hide()}),E.on("show",function(){$("#designer-class-"+this.uuid()).show()});var L=this.require("ModelBehavior");L.on("render",function(){var e="",t=null,i=this,s="";s=this.require("designer").system().id(),e=this.require("model-behavior.html"),document.querySelector("#designer-workspace").insertAdjacentHTML("afterbegin",e.source().replace(/{{_id}}/gi,this.uuid()).replace(/{{title}}/gi,this.title()).replace(/{{content}}/gi,this.content().replace(/</g,"&lt;"))),(t=document.getElementById("designer-behavior-"+this.uuid()).children[0].children[1])&&t.addEventListener("click",function(e){this.require("designer").open("behavior.html#"+i.uuid()+"#"+s+"#action",i.uuid())}.bind(this)),(t=document.getElementById("designer-behavior-"+this.uuid()+"-edit"))&&t.addEventListener("click",function(e){this.require("designer").open("behavior.html#"+i.uuid()+"#"+s+"#action",i.uuid())}.bind(this)),(t=document.getElementById("designer-behavior-"+this.uuid()+"-export"))&&t.addEventListener("click",function(e){var t=this.document().state,i="",s={name:"behavior "+t,master:!1,subsystem:!0,version:"0.0.1",description:"Behavior "+t,schemas:{},models:{},behaviors:{},types:{},components:{}};s.name=s.name.trim(),s.name=s.name.replace(/ /gi,"-"),s.name=s.name.toLocaleLowerCase(),s.behaviors[this.document()._id]=this.document(),i=this.document().component===this.require("designer").system().id()?"behavior."+this.require("designer").system().name()+"."+t.replace(/ /gi,"-").toLowerCase()+".json":"behavior."+this.document().component+"."+t.replace(/ /gi,"-").toLowerCase()+".json",this.require("designer").saveAs(s,i)}.bind(this)),(t=document.getElementById("designer-behavior-"+this.uuid()+"-delete"))&&t.addEventListener("click",function(e){var t=this.require("designer");behaviors=t.system().behaviors(),delete behaviors[this.uuid()],t.system().behaviors(behaviors),$("#designer-behavior-"+this.uuid()).fadeOut(400,function(){$(this).remove()}),this.require("channel").$designerDeleteBehavior(this.uuid()),this.destroy(),t.save()}.bind(this))}),L.on("hide",function(){$("#designer-behavior-"+this.uuid()).hide()}),L.on("show",function(){$("#designer-behavior-"+this.uuid()).show()});var C=this.require("ModelComponent");C.on("render",function(){function e(e){var t="",i="",s="";for(i in r.require("designer").system().components())for(s in r.require("designer").system().components()[i])if(s===e){t=i;break}return t}function t(t){var i=model[o].type[0].replace("@","");r.require("designer").system().components();"RuntimeComponent"===i&&(i=e(t)),l=l+'<a href="#'+runtime.require("designer").system().id()+"#components#"+i+"#"+t+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+t+"</a>,<br>"}var i=null,s=null,n="",r=this,o="",a="",d="",c="",l="",m="",h=null;c=this.require("designer").system().id(),h=function(e){var t="",i="";for(i in r.require("designer").system().schemas())if(r.require("designer").system().schemas()[i]._name===e){t=r.require("designer").system().schemas()[i];break}return t}(this.model()),model=function(e){var t="",i="";for(i in r.require("designer").system().models())if(r.require("designer").system().models()[i]._name===e){t=r.require("designer").system().models()[i];break}return t}(this.model());for(o in this.document())if(this.document().hasOwnProperty(o)&&"_id"!==o)switch(a=this.document()[o],d=JSON.stringify(a),!0){case"link"===h[o]:"string"==typeof a?("RuntimeComponent"===(m=model[o].type.replace("@",""))&&(m=e(a)),n=n+"<tr><td>"+o+'</td><td><a href="#'+this.require("designer").system().id()+"#components#"+m+"#"+a+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+a+"</a></td></tr>"):n=n+"<tr><td>"+o+"</td><td>"+d+"</td></tr>";break;case"collection"===h[o]:Array.isArray(a)&&-1!==model[o].type[0].indexOf("@")?(a.forEach(t),n=(n=n+"<tr><td>"+o+"</td><td>["+l+"]</td></tr>").replace(",<br>]","]")):n=d.length<25?n+"<tr><td>"+o+"</td><td>"+d+"</td></tr>":n+"<tr><td>"+o+"</td><td>"+d.substring(0,25)+" ...</td></tr>";break;default:n=d.length<25?"string"==typeof a?n+"<tr><td>"+o+"</td><td>"+a.replace(/</g,"&lt;")+"</td></tr>":n+"<tr><td>"+o+"</td><td>"+d.replace(/</g,"&lt;")+"</td></tr>":"string"==typeof a?n+"<tr><td>"+o+"</td><td>"+a.substring(0,23).replace(/</g,"&lt;")+" ...</td></tr>":n+"<tr><td>"+o+"</td><td>"+d.substring(0,23).replace(/</g,"&lt;")+" ...</td></tr>"}""===n&&(n+="<tr><td><br/><br/></td><td><br/><br/></td></tr>"),i=this.require("model-component.html"),document.querySelector("#designer-workspace").insertAdjacentHTML("afterbegin",i.source().replace(/{{title}}/gi,this.title()).replace(/{{_id}}/gi,this.uuid().replace(/\./g,"-")).replace(/{{content}}/gi,n)),(s=document.getElementById("designer-component-"+this.uuid().replace(/\./g,"-")).children[0].children[1])&&s.addEventListener("click",function(e){this.require("designer").open("component.html#"+encodeURIComponent(r.title())+"#"+encodeURIComponent(r.model())+"#"+c,r.uuid())}.bind(this)),(s=document.getElementById("designer-component-"+this.uuid().replace(/\./g,"-")+"-edit"))&&s.addEventListener("click",function(e){this.require("designer").open("component.html#"+encodeURIComponent(r.title())+"#"+encodeURIComponent(r.model())+"#"+c,r.uuid())}.bind(this)),(s=document.getElementById("designer-component-"+this.uuid().replace(/\./g,"-")+"-export"))&&s.addEventListener("click",function(e){var t=this.document()._id,i={name:"component "+t,master:!1,subsystem:!0,version:"0.0.1",description:"Component "+t,schemas:{},models:{},behaviors:{},types:{},components:{}};i.name=i.name.trim(),i.name=i.name.replace(/ /gi,"-"),i.name=i.name.toLocaleLowerCase(),i.models[this.model()],i.components[this.model()]={},i.components[this.model()][this.document()._id]=this.document(),this.require("designer").saveAs(i,"component."+t.replace(/ /gi,"-").toLowerCase()+".json")}.bind(this)),(s=document.getElementById("designer-component-"+this.uuid().replace(/\./g,"-")+"-delete"))&&s.addEventListener("click",function(e){var t=this.require("designer"),i=t.system().components();delete i[this.model()][this.uuid()],t.system().components(i),$("#designer-component-"+this.uuid().replace(/\./g,"-")).fadeOut(400,function(){$(this).remove()}),this.require("channel").$designerDeleteComponent(this.uuid(),this.model()),this.destroy(),t.save()}.bind(this))}),C.on("hide",function(){$("#designer-component-"+this.uuid()).hide()}),C.on("show",function(){$("#designer-component-"+this.uuid()).show()});var S=this.require("ModelLog");S.on("render",function(){var e="";htmlComp=this.require("model-log.html"),this.require("designer").logs().forEach(function(t){switch(t.type()){case"debug":e=e+'<p class="text-muted">'+t.log()+"</p>";break;case"info":e=e+'<p class="text-info">'+t.log()+"</p>";break;case"warn":e=e+'<p class="text-warning">'+t.log()+"</p>";break;case"error":e=e+'<p class="text-danger">'+t.log()+"</p>"}}),document.querySelector("#designer-workspace").insertAdjacentHTML("afterbegin",htmlComp.source().replace("{{logs}}",e)),document.getElementById("designer-log-clean").addEventListener("click",function(e){this.require("designer").logs().forEach(function(e){this.logs().pop()}.bind(this.require("designer"))),document.querySelector("#designer-loug-output").innerHTML=""}.bind(this))}),S.on("hide",function(){$("#designer-log").hide()}),S.on("show",function(){$("#designer-log").show()});var I=this.require("MenuBar");I.on("init",function(e){var t=[],i=[],s=[],n=this;t=this.require("db").collections().MenuHeader.find({type:"designer"}),this.header(this.require(t[0]._id)),(i=this.require("db").collections().MenuItem.find({type:"designer"})).sort(function(e,t){return e.position>t.position?1:e.position<t.position?-1:0}),i.forEach(function(e){var t=e._id;n.items().push(n.require(t))}),(s=this.require("db").collections().MenuAction.find({type:"designer"})).sort(function(e,t){return e.position>t.position?1:e.position<t.position?-1:0}),s.forEach(function(e){var t=e._id;n.actions().push(n.require(t))})}),I.on("render",function(){function e(){var e=0,t=0,i=null;for(e=r.children.length,t=0;t<e;t++)i=r.children[t],$(i).removeClass("active")}var t=0,i=0,s=null,n=document.getElementById("designer-menubar-header"),r=document.getElementById("designer-menubar-items"),o=document.getElementById("designer-menubar-actions"),a=this,d=window.location.href.split("#"),c=window.location.href.split("?messages="),l=[],m="system",h="",u=this.require("designer");n.insertAdjacentHTML("afterbegin",this.header().html().source()),this.items().forEach(function(e){r.insertAdjacentHTML("beforeend","<li>"+e.html().source()+"</>")});var g=function(){e(),$(this).addClass("active")};for(t=r.children.length,i=0;i<t;i++)(s=r.children[i]).addEventListener("click",g),s.addEventListener("click",function(){this.click()}.bind(a.items(i)));for(this.actions().forEach(function(e){o.insertAdjacentHTML("afterbegin","<li>"+e.html().source()+"</>")}),d.length>2&&0!==d[2].length&&(m=(m=d[2]).split("?")[0]),d.length>3&&(h=(h=d[3]).split("?")[0]),d.length>4&&u.state().component(d[4].split("?")[0]),i=0;i<t;i++)this.items(i).name()===m&&(s=r.children[i],$(s).addClass("active"));h&&u.space(h),u.context(m);var p=this;$("#designer-menu-action-search").on("keyup",function(e){var t=$("#designer-menu-action-search").val();p.designer().filter(t)}),u.updateRouter(),c[1]&&(l=JSON.parse(decodeURIComponent(c[1])),u.messages(l))});var _=this.require("ToolBar");_.on("init",function(e){var t=[],i=this;(t=this.require("db").collections().ToolBarItem.find({type:"designer"})).sort(function(e,t){return e.position>t.position?1:e.position<t.position?-1:0}),t.forEach(function(e){var t=e._id;i.items().push(i.require(t))})}),_.on("render",function(){var e=document.getElementById("designer-toolbar-items"),t=0,i=0,s=this;for(this.items().forEach(function(t){e.insertAdjacentHTML("beforeend","<li>"+t.html().source()+"</>")}),i=e.children.length,t=0;t<i;t++)e.children[t].addEventListener("click",function(e){2!==e.detail&&this.click()}.bind(s.items(t)))});var B=this.require("Spaces");B.on("init",function(e){}),B.on("clear",function(){this.require("designer").space(""),$("#designer-spaces-items").empty()}),B.on("render",function(){function e(){var e=0,t=0,i=null;for(e=a.children.length,t=0;t<e;t++)i=a.children[t],$(i).removeClass("active")}var t=null,i=this.designer().system(),s=this.require("SpaceItem"),n=null,r="",o="",a=document.getElementById("designer-spaces-items"),d=document.getElementById("designer-spaces-system-items"),c=document.getElementById("designer-spaces-components-items"),l=this,m="",h=null,u=[],g=!1,p="";switch($("#designer-spaces-help").empty(),this.designer().context()){case"system":$("#designer-spaces-spaces-system").hide(),$("#designer-spaces-spaces-components").hide(),document.getElementById("designer-spaces-type").innerHTML="Systems",document.getElementById("designer-spaces-help").insertAdjacentHTML("beforeend",this.require("help-system.html").source());break;case"schemas":$("#designer-spaces-spaces-system").hide(),$("#designer-spaces-spaces-components").hide(),document.getElementById("designer-spaces-type").innerHTML="Schemas",document.getElementById("designer-spaces-help").insertAdjacentHTML("beforeend",this.require("help-schemas.html").source());break;case"models":$("#designer-spaces-spaces-system").hide(),$("#designer-spaces-spaces-components").hide(),document.getElementById("designer-spaces-type").innerHTML="Models",document.getElementById("designer-spaces-help").insertAdjacentHTML("beforeend",this.require("help-models.html").source());break;case"types":$("#designer-spaces-spaces-system").hide(),$("#designer-spaces-spaces-components").hide(),document.getElementById("designer-spaces-type").innerHTML="Types",document.getElementById("designer-spaces-help").insertAdjacentHTML("beforeend",this.require("help-types.html").source());break;case"behaviors":$("#designer-spaces-spaces-system").show(),$("#designer-spaces-spaces-components").show(),document.getElementById("designer-spaces-type").innerHTML="Models",document.getElementById("designer-spaces-system-header").innerHTML="System",document.getElementById("designer-spaces-components-header").innerHTML="Components",document.getElementById("designer-spaces-help").insertAdjacentHTML("beforeend",this.require("help-behaviors.html").source());break;case"components":$("#designer-spaces-spaces-system").hide(),$("#designer-spaces-spaces-components").hide(),document.getElementById("designer-spaces-type").innerHTML="Models",document.getElementById("designer-spaces-help").insertAdjacentHTML("beforeend",this.require("help-components.html").source());break;case"logs":$("#designer-spaces-spaces-system").hide(),$("#designer-spaces-spaces-components").hide(),document.getElementById("designer-spaces-type").innerHTML="Logs",document.getElementById("designer-spaces-help").insertAdjacentHTML("beforeend",this.require("help-logs.html").source())}if($("#designer-spaces-items").empty(),$("#designer-spaces-system-items").empty(),$("#designer-spaces-components-items").empty(),i)switch(this.designer().context()){case"system":this.items().forEach(function(e){this.items().pop()}.bind(this));var f=this.require("storage").get("system-designer-systems"),y=[],v=0,b=0;for(f&&(y=f.systems),v=y.length,b=0;b<v;b++)n=new s({name:(i=this.require("storage").get(y[b])).name,uuid:i._id}),this.items().push(n);for(this.items().sort(function(e,t){var i=runtime.require(e),s=runtime.require(t),n=0;return i.name()>s.name()&&(n=1),i.name()<s.name()&&(n=-1),n}),this.items().forEach(function(e){a.insertAdjacentHTML("beforeend",'<li id="designer-space-'+e.name()+'" class=""><a href="#'+e.uuid()+"#system#"+e.name()+'">'+e.name()+"</a></li>")}),h=function(){e(),$(this).addClass("active")},v=a.children.length,b=0;b<v;b++)(t=a.children[b]).addEventListener("click",h),t.addEventListener("click",function(){this.click()}.bind(l.items(b)));this.items().forEach(function(e){e.on("click",function(){var e=this.require("designer"),t=this.require("storage").get(this.uuid()),i=this.require("System");t&&e.system(new i(t)),e.logs().forEach(function(e){this.logs().pop()}.bind(e))})}),v>0&&($("#designer-space-"+this.require("designer").space()).length?$("#designer-space-"+this.require("designer").space()).addClass("active"):this.require("designer").system()?$("#designer-space-"+this.require("designer").system().name()).length&&($("#designer-space-"+this.require("designer").system().name()).addClass("active"),this.require("designer").space(this.require("designer").system().name())):(t=a.children[0],$(t).addClass("active"),this.require("designer").space(this.items(0).name())));break;case"schemas":this.items().forEach(function(e){this.items().pop()}.bind(this));for(m in i.schemas())n=new s({name:i.schemas()[m]._name,uuid:m}),this.items().push(n);for(this.items().sort(function(e,t){var i=runtime.require(e),s=runtime.require(t),n=0;return i.name()>s.name()&&(n=1),i.name()<s.name()&&(n=-1),n}),this.items().forEach(function(e){a.insertAdjacentHTML("beforeend",'<li id="designer-space-'+e.uuid()+'" class=""><a href="#'+i.id()+"#schemas#"+e.uuid()+'">'+e.name()+"</a></li>")}),h=function(){e(),$(this).addClass("active")},v=a.children.length,b=0;b<v;b++)(t=a.children[b]).addEventListener("click",h),t.addEventListener("click",function(){this.click()}.bind(l.items(b)));v>0?$("#designer-space-"+this.require("designer").space()).length?$("#designer-space-"+this.require("designer").space()).addClass("active"):(t=a.children[0],$(t).addClass("active"),this.require("designer").space(this.items(0).uuid())):this.require("designer").space("");break;case"models":this.items().forEach(function(e){this.items().pop()}.bind(this));for(m in i.models())n=new s({name:i.models()[m]._name,uuid:m}),this.items().push(n);for(this.items().sort(function(e,t){var i=runtime.require(e),s=runtime.require(t),n=0;return i.name()>s.name()&&(n=1),i.name()<s.name()&&(n=-1),n}),this.items().forEach(function(e){a.insertAdjacentHTML("beforeend",'<li id="designer-space-'+e.uuid()+'" class=""><a href="#'+i.id()+"#models#"+e.uuid()+'">'+e.name()+"</a></li>")}),h=function(){e(),$(this).addClass("active")},v=a.children.length,b=0;b<v;b++)(t=a.children[b]).addEventListener("click",h),t.addEventListener("click",function(){this.click()}.bind(l.items(b)));v>0?$("#designer-space-"+this.require("designer").space()).length?$("#designer-space-"+this.require("designer").space()).addClass("active"):(t=a.children[0],$(t).addClass("active"),this.require("designer").space(this.items(0).uuid())):this.require("designer").space("");break;case"types":this.items().forEach(function(e){this.items().pop()}.bind(this));for(m in i.types())n=new s({name:m}),this.items().push(n);for(this.items().sort(function(e,t){var i=runtime.require(e),s=runtime.require(t),n=0;return i.name()>s.name()&&(n=1),i.name()<s.name()&&(n=-1),n}),this.items().forEach(function(e){a.insertAdjacentHTML("beforeend",'<li id="designer-space-'+e.name()+'" class=""><a href="#'+i.id()+"#types#"+e.name()+'">'+e.name()+"</a></li>")}),h=function(){e(),$(this).addClass("active")},v=a.children.length,b=0;b<v;b++)(t=a.children[b]).addEventListener("click",h),t.addEventListener("click",function(){this.click()}.bind(l.items(b)));v>0&&($("#designer-space-"+this.require("designer").space()).length?$("#designer-space-"+this.require("designer").space()).addClass("active"):(t=a.children[0],$(t).addClass("active"),this.require("designer").space(this.items(0).name())));break;case"behaviors":this.items().forEach(function(e){this.items().pop()}.bind(this));for(m in i.models())n=new s({name:i.models()[m]._name,uuid:m}),this.items().push(n);for(this.items().sort(function(e,t){var i=runtime.require(e),s=runtime.require(t),n=0;return i.name()<s.name()&&(n=1),i.name()>s.name()&&(n=-1),n}),this.items().reverse(),this.items().forEach(function(e){u.push(e.name()),a.insertAdjacentHTML("beforeend",'<li id="designer-space-'+e.name()+'" class=""><a href="#'+i.id()+"#behaviors#"+e.name()+'">'+e.name()+"</a></li>")}),h=function(){e(),$(this).addClass("active")},v=a.children.length,b=0;b<v;b++)(t=a.children[b]).addEventListener("click",h),t.addEventListener("click",function(){this.click()}.bind(l.items(b)));for(this.systems().forEach(function(e){this.systems().pop()}.bind(this)),this.systems().sort(function(e,t){var i=runtime.require(e),s=runtime.require(t),n=0;return i.name()<s.name()&&(n=1),i.name()>s.name()&&(n=-1),n}),this.require("storage").get("system-designer-systems")&&this.require("storage").get("system-designer-systems").systems.length&&(n=new s({name:this.require("designer").system().name(),uuid:this.require("designer").system().id()}),this.systems().push(n)),this.systems().reverse(),this.systems().forEach(function(e){d.insertAdjacentHTML("beforeend",'<li id="designer-space-'+e.name()+'" class=""><a href="#'+i.id()+"#behaviors#"+e.name()+'">'+e.name()+"</a></li>")}),h=function(){e(),$(this).addClass("active")},v=d.children.length,b=0;b<v;b++)(t=d.children[b]).addEventListener("click",h),t.addEventListener("click",function(){this.click()}.bind(l.systems(b)));if(r=this.designer().space(),-1!==u.indexOf(r)?(g=!0,p=r):(p=function(e,t){var i="",s="";for(s in t)if(void 0!==t[s][e]){i=s;break}return i}(r,this.designer().system().components()))&&(g=!0),g){this.components().forEach(function(e){this.components().pop()}.bind(this));for(o in i.components()[p])n=new s({name:o,uuid:o}),this.components().push(n);for(this.components().sort(function(e,t){var i=runtime.require(e),s=runtime.require(t),n=0;return i.name()<s.name()&&(n=1),i.name()>s.name()&&(n=-1),n}),this.components().reverse(),this.components().forEach(function(e){u.push(e.name()),c.insertAdjacentHTML("beforeend",'<li id="designer-space-'+e.name().replace(/\./g,"-")+'" class=""><a href="#'+i.id()+"#behaviors#"+e.name()+'">'+e.name()+"</a></li>")}),h=function(){e(),$(this).addClass("active")},v=c.children.length,b=0;b<v;b++)(t=c.children[b]).addEventListener("click",h),t.addEventListener("click",function(){this.click()}.bind(l.components(b)))}this.items().length>0&&$("#designer-space-"+this.require("designer").space().replace(/\./g,"-")).length?$("#designer-space-"+this.require("designer").space().replace(/\./g,"-")).addClass("active"):(t=d.children[0],$(t).addClass("active"),this.require("designer").space(this.systems(0).name()));break;case"components":this.items().forEach(function(e){this.items().pop()}.bind(this));for(m in i.models())n=new s({name:i.models()[m]._name,uuid:m}),this.items().push(n);for(this.items().sort(function(e,t){var i=runtime.require(e),s=runtime.require(t),n=0;return i.name()>s.name()&&(n=1),i.name()<s.name()&&(n=-1),n}),this.items().forEach(function(e){a.insertAdjacentHTML("beforeend",'<li id="designer-space-'+e.name()+'" class=""><a href="#'+i.id()+"#components#"+e.name()+'">'+e.name()+"</a></li>")}),h=function(){e(),$(this).addClass("active")},v=a.children.length,b=0;b<v;b++)(t=a.children[b]).addEventListener("click",h),t.addEventListener("click",function(){this.click()}.bind(l.items(b)));v>0&&($("#designer-space-"+this.require("designer").space()).length?$("#designer-space-"+this.require("designer").space()).addClass("active"):(t=a.children[0],$(t).addClass("active"),this.require("designer").space(this.items(0).name())));break;case"logs":a.insertAdjacentHTML("beforeend",'<li class="active"><a href="#'+i.id()+'#logs">Console output</a></li>')}});var O=this.require("Workspace");O.on("init",function(e){var t=this;$("html").on("dragenter dragover",!1).on("drop",function(e){e.stopPropagation(),e.preventDefault();var i=e.originalEvent.dataTransfer.files,s=new FileReader,n="";s.onload=function(e){n+=e.target.result},s.onloadend=function(){var e=JSON.parse(n),i=t.require("DialogDropFile");(i=new i(t.require("designer").system()?{title:"A system has been found",message:"You can import the system or compose it with the current system."}:{title:"A system has been found",message:"You can import the system."})).data(e),i.show()},s.readAsText(i[0],"UTF-8")})}),O.on("create",function(){var e="",t=null,i=this.require("designer").system();switch(this.designer().context()){case"system":(t=new(this.require("DialogSystemCreation"))({title:"Create a new system"})).show(),t.on("ok",function(){var e=this.require("designer"),t=null,i="",s="",n={},r=this.require("System"),o=null;(t=(t=(t=$("#designer-dialog-system-creation-name").val()).trim()).replace(/ /gi,"-"))&&function(e){var t=runtime.require("storage").get("system-designer-systems"),i=[],s=/[\#\&\(\)\[\]\'\"\*\,\;\:\%]/i,r=0,o=!0;for(t&&(i=t.systems),length=i.length,r=0;r<length;r++)if((n=runtime.require("storage").get(i[r])).name===e){o=!1;break}return o=o&&null===e.match(s)}(t)&&(i=e.generateId(),s=e.generateId(),(n={name:t,master:!0,subsystem:!1,version:"0.0.1",description:"",schemas:{},models:{},behaviors:{},types:{},components:{},_id:i}).behaviors[s]={_id:s,component:i,state:"start",action:"function start() { \n\t\n}",useCoreAPI:!1,core:!1},e.system()&&e.system().destroy(),e.system(new r(n)),(o=new(this.require("ModelSystem"))({title:t})).uuid=i,o.document(JSON.parse(JSON.stringify(n))),o.content(JSON.stringify(n)),e.save(),this.hide(),e.space(t),e.spaces().render(),e.workspace().refresh(),this.require("message").success("System created. You can now begin to create schemas."))});break;case"schemas":i&&Object.keys(i).length&&((t=new(this.require("DialogSchemaCreation"))({title:"Create a new schema"})).show(),t.on("ok",function(){var t=this.require("designer"),i=null,s={},n={},r=null;(i=(i=(i=$("#designer-dialog-schema-creation-name").val()).trim()).replace(/ /gi,"_"))&&function(e){var t=!0,i=/[\#\&\(\)\[\]\'\"\*\,\;\:\%]/i,s="";for(s in runtime.require("designer").system().schemas())if(runtime.require("designer").system().schemas()[s]._name===e){t=!1;break}return runtime.require("designer").system().name()===e&&(t=!1),t=t&&null===e.match(i)}(i)&&(s={_id:e=t.generateId().toString(),_name:i,_inherit:["RuntimeComponent"]},(n=t.system().schemas())[e]=s,t.system().schemas(n),(r=new(this.require("ModelSchema"))({title:i})).document(JSON.parse(JSON.stringify(s))),r.content(JSON.stringify(s)),r.uuid(e),t.save(),t.createModel(s),this.require("channel").$designerCreateSchema(i,s),this.hide(),t.space(e),t.spaces().render(),t.workspace().refresh(),t.updateRouter(),this.require("message").success("Schema created. A model has been also generated."))}));break;case"models":i&&Object.keys(i).length&&((t=new(this.require("DialogModelCreation"))({title:"Create a new model"})).show(),t.on("ok",function(){this.hide()}));break;case"types":i&&Object.keys(i).length&&((t=new(this.require("DialogTypeCreation"))({title:"Create a new type"})).show(),t.on("ok",function(){var e=this.require("designer"),t=null,i=!1,s={},n=e.system().types(),r=null,o="";t=$("#designer-dialog-type-creation-name").val(),i=$("#designer-dialog-type-creation-isEnum")[0].checked,(t=(t=t.trim()).replace(/ /gi,"_"))&&(o=e.generateId().toString(),s=i?{_id:o,name:t,type:"any",value:["value1","value2"]}:{_id:o,name:t,type:"object",schema:{property1:{type:"any",mandatory:!1,default:""},property2:{type:"any",mandatory:!1,default:""}}},n[t]=s,e.system().types(n),(r=new(this.require("ModelType"))({title:t})).uuid=t,r.document(JSON.parse(JSON.stringify(s))),r.content(JSON.stringify(s)),e.save(),this.require("channel").$designerCreateType(t,s),this.hide(),e.space(t),e.spaces().render(),e.workspace().refresh(),this.require("message").success("Type created. You can use it in your model."))}));break;case"components":if(i&&Object.keys(i).length){var s=this.require("designer"),n=(s.system().schemas(),s.system().models()),r=s.system().components(),o={},a=null,d="",c="",l=null,m=null;if(function(e){var t="",i="";for(i in s.system().models())if(s.system().models()[i]._name===e){t=i;break}return t}(s.space()),d=s.space(),m=s.getGeneratedSchema(d),void 0===n[d]){o={_id:c=s.generateId()};var h=[];for(var u in m)"property"===m[u]&&h.push(u),"link"===m[u]&&h.push(u),"collection"===m[u]&&h.push(u);h.sort(),l=s.getGeneratedModel(d),length=h.length;for(var g=0;g<length;g++)l&&l[h[g]]&&(o[h[g]]=l[h[g]].default);r[d]||(r[d]={}),r[d][c]=o,s.system().components(r),(a=new(this.require("ModelComponent"))({title:c})).model(d),a.uuid(c.toString()),a.document(JSON.parse(JSON.stringify(o))),a.content(JSON.stringify(o)),a.render(),$("#designer-component-"+c.toString()).hide(),$("#designer-component-"+c.toString()).fadeIn(1e3),s.save(),this.require("channel").$designerCreateComponent(d,o)}else this.require("message").warning("There is no schema. Create a schema before creating a component.")}break;case"behaviors":i&&Object.keys(i).length&&((t=new(this.require("DialogBehaviorCreation"))({title:"Create a new behavior"})).show(),t.on("ok",function(){function t(t,n,r){var o=!1;if(i(n)){for(e in s.system().behaviors())if(s.system().behaviors()[e].state===t&&s.system().behaviors()[e].component===r){o=!0;break}}else for(e in s.system().behaviors())if(s.system().behaviors()[e].state===t&&s.system().behaviors()[e].component===n){o=!0;break}return o}function i(e){var t=!1;return-1!==Object.keys(s.system().components()).indexOf(e)&&(t=!0),t}var s=this.require("designer"),n=s.system().schemas(),r=(s.system().models(),null),o=s.system().behaviors(),a=this.require("message"),d="",c=null,l={},m="",h="\t\n",u=null,g="",p="",f="",y="",v=!0,b=0,q=0,k="";if(g=function(e){var t=e,i="";for(i in s.system().components())if(void 0!==s.system().components()[i][e]){t=i;break}return t}(s.space()),p=$("#designer-dialog-behavior-creation-state").val(),k=s.space(),g&&p){if(f=s.generateId(),g!==s.system().name()){if(d=function(e){var t="",i="";for(i in s.system().schemas())if(s.system().schemas()[i]._name===e){t=i;break}return t}(g),function(e){var t="",i="";for(i in s.system().models())if(s.system().models()[i]._name===e){t=i;break}return t}(g),(r=s.getGeneratedModel(g))[p]&&(c=r[p].params),c&&c.length)for(q=c.length,b=0;b<q;b++)y=0===b?c[b].name:y+", "+c[b].name;if("property"!==n[d][p]&&"link"!==n[d][p]||(y="value"),"collection"===n[d][p]&&(y="value, type"),"method"===n[d][p]&&t(p,s.space(),g)&&(v=!1),"init"===p&&(y="conf",t(p,s.space(),g)&&(v=!1)),"destroy"===p&&t(p,s.space(),g)&&(v=!1),"error"===p&&(y="data",t(p,s.space(),g)&&(v=!1)),r[p]&&(m=r[p].result),m)switch(m){case"string":h="\tvar result = '';\n\treturn result;\n";break;case"array":h="\tvar result = [];\n\treturn result;\n";break;case"number":h="\tvar result = 0;\n\treturn result;\n";break;case"object":default:h="\tvar result = {};\n\treturn result;\n"}}else t(p,k=s.system().id(),g)&&(v=!1);v?(l="destroy"!==p?{_id:f,component:k,state:p,action:"function "+p+"("+y+") { \n"+h+"}",useCoreAPI:!1,core:!1}:{_id:f,component:k,state:"destroy",action:"function destroy() { \n\n  // destroy the component\n  $component.destroy(this.id());\n}",useCoreAPI:!0,core:!1},o[f]=l,s.system().behaviors(o),(u=new(this.require("ModelBehavior"))({uuid:f})).title(p),u.document(l),u.content(JSON.parse(JSON.stringify(l.action))),this.hide(),u.render(),Prism.highlightAll(),$("#designer-behavior-"+f.toString()).hide(),$("#designer-behavior-"+f.toString()).fadeIn(1e3),s.save(),this.require("channel").$designerCreateBehavior(l)):(this.hide(),a.warning("Can not create two behaviors for a method."))}}))}}),O.on("refresh",function(){function e(e){var t="",i="";for(i in g.schemas())if(g.schemas()[i]._name===e){t=i;break}return t}function t(e){var t="",i="";for(i in g.models())if(g.models()[i]._name===e){t=i;break}return t}var i=null,s=null,n=null,r=null,o=null,a="",d="",c="",l=null,m=null,h=null,u=null,g=this.designer().system(),p=this.designer().space(),f="",y=[],v=null,b=null,q=[],k=0,$=0,w=0;if(g){switch(this.clear(),window.scrollTo(0,0),(w="system "+g.name())!==document.title&&(document.title=w),this.designer().context()){case"system":for((b=this.require("storage").get("system-designer-systems"))&&(q=b.systems),$=q.length,k=0;k<$;k++)(g=this.require("storage").get(q[k])).name===p&&((o=new(this.require("ModelSystem"))({title:g.name})).uuid(g._id),o.document(JSON.parse(JSON.stringify(g))),o.content(JSON.stringify(g)),o.render());""===p&&$>0&&this.require("message").warning("System not found.");break;case"schemas":if(p)for(d in g.schemas())if(g.schemas()[d]._id===p){for(i=this.require("ModelSchema"),y=[],g.schemas()[d]._inherit&&(v=g.schemas()[d]._inherit.slice()).reverse(),$=0,v&&($=v.length),k=0;k<$;k++){if(f=e(v[k]),n=new i({title:v[k]}),"RuntimeComponent"===v[k]){f="111df11e2b19fde";var E={_id:"RuntimeComponent",_name:"RuntimeComponent",_core:!0,classInfo:"property",id:"property",destroy:"method",error:"event",init:"method",off:"method",on:"method",require:"method"};n.document(E),n.content(JSON.stringify(E)),y.push(f),n.uuid(f)}else g.schemas()[e(v[k])]?(n.document(JSON.parse(JSON.stringify(g.schemas()[e(v[k])]))),n.content(JSON.stringify(g.schemas()[e(v[k])])),y.push(e(v[k])),n.uuid(e(v[k]))):(y.push(v[k]),n.uuid(v[k]));n.render()}for((n=new i({title:g.schemas()[d]._name})).uuid(d),n.document(JSON.parse(JSON.stringify(g.schemas()[d]))),n.content(JSON.stringify(g.schemas()[d])),n.editable(!0),n.render(),$=y.length,k=0;k<$;k++)this.designer().linkModel(d,y[k])}break;case"models":if(p)for(d in g.models())if(g.models()[d]._id===p){for(s=this.require("ModelClass"),y=[],(c=e(g.models()[d]._name))&&g.schemas()[c]._inherit&&(v=g.schemas()[c]._inherit.slice()).reverse(),$=0,v&&($=v.length),k=0;k<$;k++){if(f=e(v[k]),l=new s({title:v[k]}),"RuntimeComponent"===v[k]){f="123751cb591de26";var L={_name:"RuntimeComponent",_core:!0,classInfo:{type:"@RuntimeClassInfo",readOnly:!1,mandatory:!1,default:{}},id:{type:"string",readOnly:!0,mandatory:!1,default:""},destroy:{params:[]},error:{params:[{name:"data",type:"errorParam"}]},init:{params:[{name:"conf",type:"object"}]},off:{params:[{name:"state",type:"string"},{name:"behaviorId",type:"string",mandatory:!1}]},on:{params:[{name:"state",type:"string"},{name:"handler",type:"function"},{name:"useCoreAPI",type:"boolean",mandatory:!1},{name:"isCore",type:"boolean",mandatory:!1}],result:"string"},require:{params:[{name:"id",type:"string"}],result:"RuntimeComponent"}};l.document(L),l.content(JSON.stringify(L)),y.push(f),l.uuid(f)}else g.models()[t(v[k])]?(l.document(JSON.parse(JSON.stringify(g.models()[t(v[k])]))),l.content(JSON.stringify(g.models()[t(v[k])])),y.push(t(v[k])),l.uuid(t(v[k]))):(y.push(v[k]),l.uuid(f));l.render()}for((l=new s({title:g.models()[d]._name})).uuid(d),l.document(JSON.parse(JSON.stringify(g.models()[d]))),l.content(JSON.stringify(g.models()[d])),l.editable(!0),l.render(),$=y.length,k=0;k<$;k++)this.designer().linkModel(d,y[k])}break;case"types":if(p)for(a in g.types())g.types()[a].name===p&&((m=new(this.require("ModelType"))({title:a})).uuid(a),m.document(JSON.parse(JSON.stringify(g.types()[p]))),m.content(JSON.stringify(g.types()[p])),m.render());break;case"components":if(p)if(this.require("designer").state().component())a=this.require("designer").state().component(),g.components()[p][a]&&((h=new(this.require("ModelComponent"))({title:a})).uuid(a),h.model(p),h.document(JSON.parse(JSON.stringify(g.components()[p][a]))),h.content(JSON.stringify(g.components()[p][a])),h.render());else for(a in g.components()[p])(h=new(this.require("ModelComponent"))({title:a})).uuid(a),h.model(p),h.document(JSON.parse(JSON.stringify(g.components()[p][a]))),h.content(JSON.stringify(g.components()[p][a])),h.render();break;case"behaviors":if(p){a=this.require("designer").state().component();for(d in g.behaviors())g.behaviors()[d].component===p&&(a&&g.behaviors()[d].state===a||""===a)&&((u=new(this.require("ModelBehavior"))({uuid:g.behaviors()[d]._id})).title(g.behaviors()[d].state),u.document(g.behaviors()[d]),u.content(JSON.parse(JSON.stringify(g.behaviors()[d].action))),u.render()),p===this.require("designer").system().name()&&g.behaviors()[d].component===this.require("designer").system().id()&&((u=new(this.require("ModelBehavior"))({uuid:g.behaviors()[d]._id})).title(g.behaviors()[d].state),u.document(g.behaviors()[d]),u.content(JSON.parse(JSON.stringify(g.behaviors()[d].action))),u.render());Prism.highlightAll()}break;case"logs":r=this.require("ModelLog"),modelLog=new r,modelLog.render()}this.designer().filter()&&this.designer().filter(this.designer().filter())}else document.title="System Designer",(b=this.require("storage").get("system-designer-systems"))&&b.systems&&b.systems.length&&this.require("message").warning("System not found.")}),O.on("clear",function(){$("#designer-workspace").empty(),jsPlumb.ready(function(){jsPlumb.deleteEveryEndpoint()})}),this.require("Server").on("start",function(){var e=null;(e=new(this.require("RuntimeChannel"))({_id:"channel"})).on("send",function(e){if(0!==e.event.indexOf("$system")){var t=this.require("storage").get("system-designer-config");this.require("storage").set("system-designer-message",e),this.require("designer").debugWindow()&&this.require("designer").debugWindow().postMessage(JSON.stringify(e),"*"),void 0!==t&&void 0!==t.debugType&&"server"===t.debugType&&t.urlServer&&$.post(t.urlServer+":8888/"+e.event,encodeURIComponent(JSON.stringify(e.data)))}}),e.on("$appLogDebug",function(e){var t="";t=new(this.require("Log"))({type:"debug",log:e.replace("runtime:","").replace(/\[[^\]]+\]/,"<strong>debug:</strong> ")}),this.require("designer").logs().push(t),this.require("message").info(e.replace(/\[[^\]]+\]/,"<strong>runtime:</strong> "))}),e.on("$appLogInfo",function(e){var t="";t=new(this.require("Log"))({type:"info",log:e.replace("runtime:","").replace(/\[[^\]]+\]/,"<strong>info:</strong> ")}),this.require("designer").logs().push(t),this.require("message").info(e.replace(/\[[^\]]+\]/,"<strong>runtime:</strong> "))}),e.on("$appLogWarn",function(e){var t="";t=new(this.require("Log"))({type:"warn",log:e.replace("runtime:","").replace(/\[[^\]]+\]/,"<strong>warning:</strong> ")}),this.require("designer").logs().push(t),this.require("message").warning(e.replace(/\[[^\]]+\]/,"<strong>runtime:</strong> "))}),e.on("$appLogError",function(e){var t="";t=new(this.require("Log"))({type:"error",log:e.replace("runtime:","").replace(/\[[^\]]+\]/,"<strong>error:</strong> ")}),this.require("designer").logs().push(t),this.require("message").danger(e.replace(/\[[^\]]+\]/,"<strong>runtime:</strong> "))}),e.on("$editorUpdateType",function(e,t){var i=this.require("designer"),s=i.system().types();s[e]=t,i.system().types(s),i.save(),i.space(t.name),i.spaces().render(),i.workspace().refresh()}),e.on("$editorDeleteType",function(e){var t=this.require("designer"),i=t.system().types(),s=[],n=null;(s=this.require("db").collections().ModelType.find({uuid:e})).length&&(n=this.require(s[0]._id))&&(n.hide(),n.destroy()),delete i[e],t.system().types(i),t.save(),t.workspace().refresh()}),e.on("$editorUpdateSchemaName",function(e,t){var i=this.require("designer"),s=i.system().schemas()[t]._name,n=i.system().models(),r=i.system().behaviors(),o=i.system().components(),a="";n[function(e,t){var i="",s="";for(s in t)if(t[s]._name===e){i=s;break}return i}(s,i.system().models())]._name=e,i.system().models(n);for(a in r)r[a].component===s&&(r[a].component=e,i.system().behaviors(r));o[s]&&(o[e]=JSON.parse(JSON.stringify(o[s])),delete o[s],i.system().components(o)),i.save()}),e.on("$editorUpdateSchema",function(e,t){var i=this.require("designer"),s=i.system().schemas(),n=null,r=null,o="";jsPlumb.deleteEveryEndpoint(),i.syncModel(t),s[e]=t,i.system().schemas(s),i.save(),n=i.system().models();for(o in n)n[o]._name!==t._name&&(r=n[o],i.syncComponent(r,!0));i.space(e),i.spaces().render(),i.workspace().refresh()}),e.on("$designerDeleteSchema",function(e){var t=this.require("designer"),i=t.system().schemas(),s=[],n=null;(s=this.require("db").collections().ModelSchema.find({uuid:e})).length&&(n=this.require(s[0]._id))&&(n.hide(),n.destroy()),delete i[e],t.system().schemas(i),t.save(),t.workspace().refresh()}),e.on("$editorUpdateSchemaId",function(e,t){var i=this.require("designer"),s=i.system().schemas(),n=null;n=JSON.parse(JSON.stringify(s[e])),delete s[e],n._id=t,s[t]=n,i.system().schemas(s),i.save(),i.workspace().refresh()}),e.on("$editorUpdateModel",function(e,t){var i=this.require("designer"),s=i.system().models();jsPlumb.deleteEveryEndpoint(),s[e]=t,i.system().models(s),i.save(),i.syncBehavior(t),i.space(e),i.spaces().render(),i.workspace().refresh()}),e.on("$editorUpdateModelId",function(e,t){var i=this.require("designer"),s=i.system().models(),n=null;n=JSON.parse(JSON.stringify(s[e])),delete s[e],n._id=t,s[t]=n,i.system().models(s),i.save(),i.workspace().refresh()}),e.on("$editorUpdateBehavior",function(e,t){var i=this.require("designer"),s=i.system().behaviors();s[e]=t,i.system().behaviors(s),i.save(),i.workspace().refresh()}),e.on("$editorDeleteBehavior",function(e){var t=this.require("designer"),i=t.system().behaviors(),s=[],n=null;(s=this.require("db").collections().ModelBehavior.find({uuid:e})).length&&(n=this.require(s[0]._id))&&(n.hide(),n.destroy()),delete i[e],t.system().behaviors(i),t.save(),t.workspace().refresh()}),e.on("$editorUpdateComponent",function(e,t,i){var s=this.require("designer"),n=s.system().components();n[t][e]=i,s.system().components(n),s.save(),s.workspace().refresh()}),e.on("$editorDeleteComponent",function(e,t){var i=this.require("designer"),s=i.system().components(),n=[],r=null;(n=this.require("db").collections().ModelComponent.find({uuid:e})).length&&(r=this.require(n[0]._id))&&(r.hide(),r.destroy()),delete s[t][e],i.system().components(s),i.save(),i.workspace().refresh()}),e.on("$editorUpdateSystem",function(e,t){var i=this.require("System"),s=null,n=this.require("designer");n.system()&&n.system().destroy(),s=new i(t),n.system(s),n.save(),n.space(t.name),n.spaces().render(),n.workspace().refresh()}),e.on("$appLoadSystem",function(e){var t=null;"app-designer-testing"!==e.name&&((t=new(this.require("DialogImport"))({title:"A system has been found",message:"Do you want to import the system ?",data:e})).show(),t.on("ok",function(){var e=this.require("System"),t=null,i=this.require("designer"),s=this.require("message");i.system()&&i.system().destroy(),t=new e(this.data()),i.system(t),i.logs().forEach(function(e){this.logs().pop()}.bind(i)),i.save(),i.space(t.name()),i.spaces().render(),i.workspace().refresh(),i.updateRouter(),this.hide(),i.save(),s.success("Importation of the system is done.")}))}),e.on("$runtimeCreateComponent",function(e,t){var i=this.require("designer"),s=i.system().components();void 0===s[e]&&(s[e]={}),delete t.classInfo,s[e][t._id]=t,i.system().components(s),i.save(),"components"===i.context()&&i.workspace().refresh()}),e.on("$runtimeDeleteComponent",function(e,t){var i=this.require("designer"),s=i.system().components();void 0!==s[t]&&(delete s[t][e],i.system().components(s),i.save(),"components"===i.context()&&i.workspace().refresh())}),e.on("$runtimeUpdateComponent",function(e,t,i,s){var n=this.require("designer"),r=n.system().components();void 0!==r[t]&&"undefined"!==r[t][e]&&(r[t][e][i]=s,n.system().components(r),n.save(),"components"===n.context()&&n.workspace().refresh())}),window.addEventListener("message",function(e){var t=null,i=this.require("storage").get("system-designer-config");i||(i={}),(t=JSON.parse(e.data))&&void 0!==t.event&&void 0!==t.from&&void 0!==t.data&&$db.RuntimeMessage.insert(t)}.bind(e),!1),this.require("storage").on("changed",function(e){void 0!==e["system-designer-message"]&&(this.require("designer").debugWindow()&&this.require("designer").debugWindow().postMessage(JSON.stringify(e["system-designer-message"].newValue),"*"),$db.RuntimeMessage.insert(e["system-designer-message"].newValue))},!0)},!0);var M=this.require("Designer");M.on("check",function(){"undefined"==typeof SharedWorker&&new(this.require("DialogCheck"))({title:"Hem... You will laugh",message:"Your browser has not all the features to use correctly System Designer.<br><br>Please use:<br><br>- Mozilla Firefox (recommended) or <br>- Google Chrome (desktop only).<br><br>"}).show()}),M.on("logs",function(e,t){var i="";if("add"===t&&"logs"===this.context()){switch(e.type()){case"debug":i=i+'<p class="text-muted">'+e.log()+"</p>";break;case"info":i=i+'<p class="text-info">'+e.log()+"</p>";break;case"warn":i=i+'<p class="text-warning">'+e.log()+"</p>";break;case"error":i=i+'<p class="text-danger">'+e.log()+"</p>"}document.querySelector("#designer-loug-output").insertAdjacentHTML("afterbegin",i)}}),M.on("welcome",function(){var e=null,t=null;(t=this.require("storage").get("system-designer-config"))||(t={}),void 0===t.welcomeScreen&&((e=new(this.require("DialogWelcome"))({title:"Welcome to System Designer"})).show(),e.on("ok",function(){var e=this.require("storage").get("system-designer-config");e||(e={}),e.welcomeScreen=!1,this.require("storage").set("system-designer-config",e),this.hide()}))}),M.on("render",function(){var e=null,t=null,i=null,s=null,n=null,r=null,o="",a=null;e=new(this.require("MenuBar"))({designer:this}),t=new(this.require("ToolBar"))({designer:this}),i=new(this.require("Workspace"))({designer:this}),n=new(this.require("Spaces"))({designer:this}),a=new(this.require("Server"))({designer:this}),this.menubar(e),this.toolbar(t),this.workspace(i),this.spaces(n),this.server(a),this.require("logger").on("warn",function(e){this.require("message").warning(e)}),this.require("logger").on("error",function(e){this.require("message").danger(e)}),s=new(this.require("DesignerState")),this.state(s),r=this.require("System");var d=this.require("storage").get("system-designer-systems");switch(!0){case window.location.href.split("#").length>1&&window.location.href.split("#")[1].length>0:o=window.location.href.split("#")[1],this.require("storage").get(o)&&(this.system(new r(this.require("storage").get(o))),this.refresh());break;default:d&&d.systems&&d.systems.length&&d.systems[0].length&&(d.systems.sort(function(e,t){var i=this.require("storage").get(e),s=this.require("storage").get(t),n=0;return i.name>s.name&&(n=1),i.name<s.name&&(n=-1),n}.bind(this)),this.system(new r(this.require("storage").get(d.systems[0])))),this.refresh()}this.welcome();var c=this;window.onhashchange=function(e){var t=window.location.href.split("#"),i="",s="system",n="",o=0,a=0,l=null,m=null;for(t.length>1&&(i=(i=t[1]).split("?")[0]),t.length>2&&(s=(s=t[2]).split("?")[0]),t.length>3&&(n=(n=t[3]).split("?")[0]),t.length>4?c.state().component(t[4].split("?")[0]):c.state().component(""),t.length>1&&i?c.system(new r(c.require("storage").get(i))):d&&d.systems&&d.systems.length&&c.system(new r(c.require("storage").get(d.systems[0]))),c.space(n),c.context(s),m=document.getElementById("designer-menubar-items"),a=c.menubar().items().length,o=0;o<a;o++)l=m.children[o],$(l).removeClass("active");for(o=0;o<a;o++)c.menubar().items(o).name()===s&&(l=m.children[o],$(l).addClass("active"));c.updateRouter()},$(window).resize(function(){jsPlumb.repaintEverything()}),this.menubar().render(),this.toolbar().render(),this.spaces().render(),$(function(){$('[data-toggle="tooltip"]').tooltip({container:"body",delay:{show:2e3,hide:100},trigger:"hover"})}),this.server().start(),this.runMessages(this.messages()),this.messages([])}),M.on("filter",function(e){var t=[],i="";switch(this.context()){case"behaviors":i="ModelBehavior";break;case"schemas":i="ModelSchema";break;case"types":i="ModelType";break;case"models":i="ModelClass";break;case"components":i="ModelComponent";break;case"system":i="ModelSystem"}for(var s=this.require("db").collections()[i].find({}),n=0;n<s.length;n++)t.push(this.require(s[n]._id));switch(e.length>0?t.forEach(function(t){-1===t.content().toLowerCase().indexOf(e.toLowerCase())?t.hide():t.show()}):t.forEach(function(e){e.show()}),this.context()){case"schemas":case"models":jsPlumb.repaintEverything()}}),M.on("context",function(e){jsPlumb.ready(function(){jsPlumb.deleteEveryEndpoint()}),this.spaces().render(),this.workspace().clear(),this.workspace().refresh()}),M.on("space",function(e){"system"===this.context()&&this.updateRouter()}),M.on("updateRouter",function(){function e(e,t){var i="",s="";for(s in t)if(t[s]._name===e){i=s;break}return i}function t(e,t){var i="",s="";for(s in t)if(t[s]._name===e){i=s;break}return i}function i(e,t){var i="",s="";for(s in t)if(s===e){i=t[e]._name;break}return i}function s(e){var t="";return 2===e.split("#").length&&(t=e.split("#")[1]),e.split("#").length>2&&(t=e.split("#")[2]),t=t.split("#")[0],t=t.trim()}var n=[],r=0,o=0,a="",d="",c="",l="",m="",h="",u="";switch(d=this.require("designer").context(),c=this.require("designer").space(),d){case"schemas":if(this.require("designer").system())for(c&&(u=e(l=i(c,this.require("designer").system().schemas()),this.require("designer").system().models())),o=(n=$("#designer-menubar-items > li > a")).length,r=0;r<o;r++)a=s(n[r].href),n[r].href="#"+this.require("designer").system().id()+"#"+a,"models"===a&&u&&(n[r].href=n[r].href+"#"+u),"components"===a&&l&&(n[r].href=n[r].href+"#"+l),"behaviors"===a&&l&&(n[r].href=n[r].href+"#"+l);else for(o=(n=$("#designer-menubar-items > li > a")).length,r=0;r<o;r++)a=s(n[r].href),n[r].href="##"+a;break;case"models":if(this.require("designer").system())for(c&&(m=t(h=function(e,t){var i="",s="";for(s in t)if(s===e){i=t[e]._name;break}return i}(c,this.require("designer").system().models()),this.require("designer").system().schemas())),o=(n=$("#designer-menubar-items > li > a")).length,r=0;r<o;r++)a=s(n[r].href),n[r].href="#"+this.require("designer").system().id()+"#"+a,"schemas"===a&&m&&(n[r].href=n[r].href+"#"+m),"components"===a&&h&&(n[r].href=n[r].href+"#"+h),"behaviors"===a&&h&&(n[r].href=n[r].href+"#"+h);else for(o=(n=$("#designer-menubar-items > li > a")).length,r=0;r<o;r++)a=s(n[r].href),n[r].href="##"+a;break;case"behaviors":if(this.require("designer").system())for(c&&(u=e(c,this.require("designer").system().models()),l=i(m=t(c,this.require("designer").system().schemas()),this.require("designer").system().schemas())),o=(n=$("#designer-menubar-items > li > a")).length,r=0;r<o;r++)a=s(n[r].href),n[r].href="#"+this.require("designer").system().id()+"#"+a,"schemas"===a&&m&&(n[r].href=n[r].href+"#"+m),"models"===a&&u&&(n[r].href=n[r].href+"#"+u),"components"===a&&u&&(n[r].href=n[r].href+"#"+l);else for(o=(n=$("#designer-menubar-items > li > a")).length,r=0;r<o;r++)a=s(n[r].href),n[r].href="##"+a;break;case"components":if(this.require("designer").system())for(c&&(u=e(c,this.require("designer").system().models()),l=i(m=t(c,this.require("designer").system().schemas()),this.require("designer").system().schemas())),o=(n=$("#designer-menubar-items > li > a")).length,r=0;r<o;r++)a=s(n[r].href),n[r].href="#"+this.require("designer").system().id()+"#"+a,"schemas"===a&&m&&(n[r].href=n[r].href+"#"+m),"models"===a&&u&&(n[r].href=n[r].href+"#"+u),"behaviors"===a&&u&&(n[r].href=n[r].href+"#"+l);else for(o=(n=$("#designer-menubar-items > li > a")).length,r=0;r<o;r++)a=s(n[r].href),n[r].href="##"+a;break;default:if(this.require("designer").system())for(o=(n=$("#designer-menubar-items > li > a")).length,r=0;r<o;r++)a=s(n[r].href),n[r].href="#"+this.require("designer").system().id()+"#"+a;else for(o=(n=$("#designer-menubar-items > li > a")).length,r=0;r<o;r++)a=s(n[r].href),n[r].href="##"+a}}),M.on("createBehavior",function(e,t,s,n){var r="\t\n",o=this.system().behaviors();if(function(e,t,i,s){var n={},r="",o=!1,a=!0;for(r in s)if((n=s[r]).component===t&&n.state===i){o=!0;break}return o&&(a=!1),a}(e,t,s,o)){if(uuid=this.generateId(),methodDef=n.params,methodDef&&methodDef.length)for(length=methodDef.length,i=0;i<length;i++)0===i?params=methodDef[i].name:params=params+", "+methodDef[i].name;if(result=n.result,result)switch(result){case"string":r="\tvar result = '';\n\treturn result;\n";break;case"array":r="\tvar result = [];\n\treturn result;\n";break;case"number":r="\tvar result = 0;\n\treturn result;\n";break;case"object":default:r="\tvar result = {};\n\treturn result;\n"}behavior={_id:uuid,component:t,state:s,action:"function "+s+"("+params+") { \n"+r+"}",useCoreAPI:!1,core:!1},o[uuid]=behavior,this.system().behaviors(o),this.save(),this.require("channel").$designerCreateBehavior(behavior)}}),M.on("deleteSchema",function(e){var t="",i="",s=this.system().schemas(),n=this.system().models(),r=this.system().behaviors(),o=this.system().components(),a=s[e]._name;delete o[a],this.system().components(o);for(t in r)r[t].component===a&&(delete r[t],this.system().behaviors(r));(i=function(e,t){var i="",s="";for(s in t)if(t[s]._name===e){i=s;break}return i}(s[e]._name,n))&&(delete n[i],this.system().models(n)),delete s[e],this.system().schemas(s)}),M.on("createModel",function(e){this.system().schemas();var t=this.system().models(),i=this.system().components(),s="",n="",r=null,o=null;o={_id:s=this.generateId(),_name:e._name};for(n in e)if(0!==n.indexOf("_"))switch(!0){case"property"===e[n]:o[n]={type:"any",readOnly:!1,mandatory:!1,default:""};for(r in i[""])i[""][r][n]=o[n].default,this.require("channel").$designerUpdateComponent(r,"",i[""][r]);break;case"link"===e[n]:o[n]={type:"@RuntimeComponent",readOnly:!1,mandatory:!1,default:""};for(r in i[""])i[""][r][n]=o[n].default,this.require("channel").$designerUpdateComponent(r,"",i[""][r]);break;case"method"===e[n]:o[n]={params:[{name:"param",type:"any",mandatory:!1,default:null}],result:"any"};for(r in i[""])i[""][r][n]=o[n].default,this.require("channel").$designerUpdateComponent(r,"",i[""][r]);break;case"event"===e[n]:o[n]={params:[{name:"param",type:"any",mandatory:!1,default:null}]};for(r in i[""])i[""][r][n]=o[n].default,this.require("channel").$designerUpdateComponent(r,"",i[""][r]);break;case"collection"===e[n]:o[n]={type:["any"],readOnly:!1,mandatory:!1,default:[]};for(r in i[""])i[""][r][n]=o[n].default,this.require("channel").$designerUpdateComponent(r,"",i[""][r])}t[s]=o,this.system().models(t),this.require("channel").$designerCreateModel(o._id,o),this.system().components(i),this.save()}),M.on("syncComponent",function(e,t){var i=this.system().components(),s="",n="",r="",o=null,a=null;s=e._name,schema=this.getGeneratedSchema(s),o=this.getGeneratedModel(s);for(r in schema)switch(!0){case"property"===schema[r]:case"link"===schema[r]:case"collection"===schema[r]:for(a in i[s])void 0===i[s][a][r]&&(i[s][a][r]=o[r].default,this.require("channel").$designerUpdateComponent(a,s,i[s][a]),this.system().components(i))}if(t)for(n in i[s])for(r in i[s][n])void 0===o[r]&&0!==r.indexOf("_")&&(delete i[s][n][r],this.require("channel").$designerDeleteComponent(n,s),this.system().components(i));this.save()}),M.on("syncModel",function(e){var t=this.system().schemas(),i=this.system().models(),s=this.system().components(),n=this.system().behaviors(),r="",o="",a="",d=null,c=null,l=null,m=null,h=!1;r=e._name;for(o in i)i[o]._name===e._name&&(l=i[o]);l||(h=!0,l={_id:this.generateId(),_name:r}),m=t[e._id];for(a in e)if(e.hasOwnProperty(a)&&m&&(void 0===m[a]||m[a]!==e[a])||h)switch(!0){case"property"===e[a]:l[a]={type:"any",readOnly:!1,mandatory:!1,default:""};for(d in s[r])s[r][d][a]=l[a].default,this.require("channel").$designerUpdateComponent(d,r,s[r][d]),this.system().components(s);break;case"link"===e[a]:l[a]={type:"@RuntimeComponent",readOnly:!1,mandatory:!1,default:""};for(d in s[r])s[r][d][a]=l[a].default,this.require("channel").$designerUpdateComponent(d,r,s[r][d]),this.system().components(s);break;case"method"===e[a]:(void 0===l[a]||void 0!==l[a]&&void 0!==l[a].type)&&(l[a]={params:[{name:"param",type:"any",mandatory:!1,default:null}],result:"any"},this.createBehavior("method",l._name,a,l[a]));break;case"event"===e[a]:void 0===l[a]||void 0!==l[a]&&void 0!==l[a].type?(l[a]={params:[{name:"param",type:"any",mandatory:!1,default:null}]},this.createBehavior("event",l._name,a,l[a])):void 0!==l[a].result&&delete l[a].result;break;case"collection"===e[a]:l[a]={type:["@RuntimeComponent"],readOnly:!1,mandatory:!1,default:[]};for(d in s[r])s[r][d][a]=l[a].default,this.require("channel").$designerUpdateComponent(d,r,s[r][d]),this.system().components(s);break;case 1!==a.indexOf("_"):"_id"!==a&&"_inherit"!==a&&(l[a]=e[a])}if(m)for(a in m)if(0!==a.indexOf("_")&&void 0===e[a]){delete l[a];for(d in s[r])delete s[r][d][a],this.require("channel").$designerDeleteComponent(d,r),this.system().components(s);for(c in n)l&&n[c].component===l._name&&n[c].state===a&&(delete n[c],this.require("channel").$designerDeleteBehavior(c),this.system().behaviors(n))}i[l._id]=l,this.system().models(i),this.require("channel").$designerUpdateModel(l._id,l),this.save()}),M.on("syncBehavior",function(e){var t=this.system().behaviors(),i=null,s="",n="",r="",o=null,a=null,d=0,c=0,l="",m="",h=null,u=this;i=function(e){var t="",i="";for(i in u.system().schemas())if(u.system().schemas()[i]._name===e){t=u.system().schemas()[i];break}return t}(e._name);for(s in i)switch(!0){case"method"===i[s]:case"event"===i[s]:if(o=e[s],"object"!=typeof e[s]&&(o="method"===i[s]?{params:[{name:"param",type:"string",mandatory:!1,default:""}],result:"string"}:{params:[{name:"param",type:"string",mandatory:!1,default:""}]}),a=o.params,n="",a&&a.length)for(d=a.length,c=0;c<d;c++)n=0===c?a[c].name:n+", "+a[c].name;r="function "+s+"("+n+") ";for(l in t)(h=t[l]).component===e._name&&h.state===s&&((m=h.action.split("{"))[0]=r,t[l].action=m.join("{"),this.system().behaviors(t),this.require("channel").$designerUpdateBehavior(h._id,h),this.save())}}),M.on("linkModel",function(e,t){jsPlumb.ready(function(){jsPlumb.setContainer("body"),jsPlumb.connect({paintStyle:{strokeStyle:"#7F949D",lineWidth:3},source:"designer-model-panel-"+e,target:"designer-model-panel-"+t,overlays:[["Arrow",{location:1}]]},{connector:["Flowchart"],anchor:["Left","Right"],endpoint:"Blank"})})}),M.on("save",function(){var e=this.require("storage").get("system-designer-systems"),t=this.require("designer"),i=this.require("db").collections().System.find({_id:t.system().id()})[0],s=i._id;delete(i=JSON.parse(JSON.stringify(i))).classInfo,this.require("storage").set(s,i),e?-1===e.systems.indexOf(s)&&e.systems.push(s):e={systems:[s]},this.require("storage").set("system-designer-systems",e)}),M.on("runMessages",function(e){e.forEach(function(e){console.log(e),$db.RuntimeMessage.insert(e)})},!0),e.on("start",function(){this.require("designer").render()}),e.start()});